<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>所有公司 - 商業服務業數位應用資料庫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="../assets/css/custom.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div id="topbar"></div>

  <div class="d-flex" style="height: calc(100vh - 64px);">
    <div id="sidebar"></div>

    <main class="flex-fill p-4" style="background-color: var(--color-bg-gray); overflow-y: auto; height: 100%;">
      <div class="container-fluid">
        <!-- 標題 -->
        <div class="d-flex align-items-center gap-2 mb-4">
          <span class="material-icons" style="font-size: 28px; color: var(--color-primary);">business</span>
          <h4 class="mb-0">所有公司</h4>
        </div>

        <!-- Tab 導航 -->
        <ul class="nav nav-tabs mb-4" id="companyTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts-pane" type="button" role="tab" aria-controls="charts-pane" aria-selected="true">
              <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">bar_chart</span>
              統計圖表
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab" aria-controls="list-pane" aria-selected="false">
              <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">list</span>
              資料列表
            </button>
          </li>
        </ul>

        <!-- Tab 內容 -->
        <div class="tab-content" id="companyTabsContent">
          <!-- 統計圖表 Tab -->
          <div class="tab-pane fade show active" id="charts-pane" role="tabpanel" aria-labelledby="charts-tab">
            <!-- 統計概覽卡片 - 簡潔風格 -->
            <div class="row g-3 mb-4">
              <div class="col-6 col-lg-4">
                <div class="stat-card-minimal">
                  <div class="stat-value" id="statTotalCompanies">0</div>
                  <div class="stat-label">總公司數</div>
                </div>
              </div>
              <div class="col-6 col-lg-4">
                <div class="stat-card-minimal">
                  <div class="stat-value text-success" id="statTotalCities">0</div>
                  <div class="stat-label">涵蓋縣市</div>
                </div>
              </div>
              <div class="col-6 col-lg-4">
                <div class="stat-card-minimal">
                  <div class="stat-value text-warning" id="statTotalIndustries">0</div>
                  <div class="stat-label">產業類別</div>
                </div>
              </div>
            </div>

            <!-- 雙欄主視覺區 -->
            <div class="row g-4">
              <!-- 左側：台灣熱度地圖 + 縣市表格 -->
              <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-transparent border-0 pt-3 pb-0">
                    <h6 class="fw-semibold mb-0 d-flex align-items-center">
                      <span class="material-icons me-2" style="font-size: 20px; color: #43a047;">map</span>
                      公司縣市分布熱度圖
                    </h6>
                  </div>
                  <div class="card-body pt-2">
                    <div class="row g-3">
                      <!-- 台灣地圖 SVG - 放大版 -->
                      <div class="col-lg-7">
                        <div id="taiwanMapContainer" class="map-container-bordered">
                          <!-- 縮放控制按鈕 - 膠囊組（固定位置） -->
                          <div class="map-zoom-controls">
                            <button type="button" class="zoom-btn" onclick="zoomMap(1.2)" title="放大">
                              <span class="material-icons">add</span>
                            </button>
                            <div class="zoom-divider"></div>
                            <button type="button" class="zoom-btn" onclick="zoomMap(0.8)" title="縮小">
                              <span class="material-icons">remove</span>
                            </button>
                            <div class="zoom-divider"></div>
                            <button type="button" class="zoom-btn" onclick="resetMapZoom()" title="重置">
                              <span class="material-icons">refresh</span>
                            </button>
                          </div>
                          <div class="map-svg-wrapper" id="mapSvgWrapper">
                          <svg id="taiwanMap" baseprofile="tiny" fill="#6f9c76" height="100%" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".5" version="1.2" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; min-height: 480px; display: block; transition: width 0.35s ease, min-width 0.35s ease, transform 0.35s ease;">
                            <g id="features">
                              <path d="M181.2 423.5l0 0.1-1.1-0.4-0.3-0.4 0.2-0.4 0.4-0.8-1.3-0.9-0.2-0.3-0.1-0.1-2.5-1.9-1.8-1.9-2.7 1-1.3 1.6 0.2 0.7-0.1 0.6-0.3 0.2-0.3-0.1-0.4 2.4-5 5.9-11.4-4.1 0.2 1-0.2 1-0.3 0.1 1.1 1.1-0.4 8.2-3.3 2.6 2.5 2.7-1.4-0.6-1.9-0.2-1.7-0.7-0.9-1.5 0.3-0.6 1.6-1.9 0.5-1 0.1-1.4 0-1.8-0.6-3.1-1.2-3-0.2-1.6 1.1-0.6 5.5-2.7 7.2 4.7 5-0.6 0.8-6.3 1.7-3.9 5.3-1.1 5.2 4.7 2 5.3z m0.2 10.5l0.3-2.1 0.3 0-0.2 1.7-0.4 0.4z m0.9-5l-1-3 0.1-0.7 0.3-0.4 0.8 2.4-0.2 1.7z" id="TWKIN" data-name="金門縣"></path>
                              <path d="M471.2 47.6l0.1 0.6-0.3 0-0.7 0.1-0.5 0.1-0.1-0.9 0.3-0.4 0.1-0.1-0.1-0.3-0.1 0-0.1-0.1 0.4-0.5 0.2-0.1 0.4-0.2 0.2-0.3 0.6 1.3-0.6 0.7 0.2 0.1z m-12.4 22.5l-0.1-0.3-0.2 0.5 0.2 0.7 0.3 0.3 0.3 0.1 0.4 0.1 0.3 0 0.5 0.1 0.3 0.2 0.1 0.5 0.2-0.3 0.6-0.1 0.4-0.3 0.3-0.2 0-0.5 0.1-0.5 0.6-0.7 0.1 0 0.2-0.1 0.6 0.1 0.5 0 0.3 0.1 0.1 0 0.5 0 0.7 0.1 0.8-0.5 0 0.3-0.3 0.3-0.2 0.4-0.3 0-0.2 0.2-0.2 0.4 0 0.5-0.1 0.3 0 0.1-0.3 0.4-0.3 0.5-0.1 0.1-0.3 0.2-0.2-0.4-0.2 0-0.7 0.1-0.2 0.3-0.4 0.6-1 1-0.2 0-0.4-0.3-0.7-0.1-0.6 0.1-0.2 1.2-0.2 0.1-0.7 0.1-0.1-0.3-0.4-0.5-0.2-0.2-0.5 0.1-0.6 0.1-0.9-0.3-0.3-1 0.3-0.6 0.4-0.3 0.4-0.4 0.3-0.7-0.7-0.5 0.4-0.5 0.4 0 0.2 0 0.1-0.5-0.5-0.8 0-0.8 0.3-0.4 0.4 0 0.3 0.4 0.3 0.1 0.1 0 0.1 0 0.5 0.3-0.3 0.9-0.1 0.2z m12.6-10.9l-0.4 0-0.6 0-1.1-0.3-0.4 0.7-0.4 0.1-0.2 0.2-0.3 0.4 0 0.7 0.2 0.7 0 0.6-0.2 0.9 0.1 0.4 0.3 0.1 0.1 0.3-0.5 0.2-0.9-0.2-0.5 0.2 0-1 0.1-1.5 0.3-1.4 0.3-0.5-0.2-0.4 0-0.6 0.1-0.2 1.1-0.1 0.5-0.6 0.5-0.2 0.6-0.3 1-0.9 0.3-1 0.5-0.3 0.6-0.1 0.4-0.3 0.6 0.1 0.1 0.5 0.3 0.4 0.1 0 0.3 0 0 0.9 0 0.9 0.7-0.7 0.2 0 0.6 0 0.1 0.1 0 0.3 0 0.9-0.7 0.2 0.1 0.5 0.3 0.2 0 0.3 0 0.7-0.5-0.7-0.2-0.7-0.5-0.7-0.7 0-0.5 0-0.3 0.2-0.4 0.3-0.5 0.1-0.4 0.6z m2.1-5.6l-0.4 0.2-0.3 0-0.7 0 0.1-0.7 0.7-0.2 0.1-0.4 0.7-0.1 0.7-0.2-0.9 1.4z" id="TWLIE" data-name="連江縣"></path>
                              <path d="M409.7 611.6l0.9 2.9-0.4 2.2-1.4-1.4-1.9-1.3-2-0.4-2.8 1.6-2.1 0.3-1 0.5-0.5 1.1-0.8 2.9-0.5 0.9-3.4 2-3.4 0.5-3.5-1.4-3.5-3.5 0.9-1.8 1.9 2.3 2.9 0.6 3.1-0.8 2.6-2.1-1.8-0.7-1.4-0.8-1.1-1.2-1-1.6-0.4 0.7 0 0.2-0.2 0.2-0.7 0.4-0.2-2.9 0.2-2.9 1.3 0 1.5 0.4 5.3-3.4 3.4-1.1-0.9 3.2-0.4 0.9 2.9-0.9 2.2 0.3 1.6-0.2 1.2-1.9 3.4 6.2z m-35.8-6.2l2.3-7.5 2.3-2.2 3 2.6-1.8 1.1-1.2 2.6-2 6.1-0.1 1.6 0.5 1.4-0.2 1-2.2 0.3-1.6 0.1-1.1 0.2-0.9 0.4-0.9 0.8-2.7 0 0.5-1.5 0.9-0.9 1.3-0.5 1.8-0.1 1.6-0.6 0.4-1.5 0.1-3.4z m18.1-5l-0.6-2.5-1.5-2.1-3.1-3.1 4-3 2.4 1.3 2.3 2 1 2.1-1.8 1.7 0.7 2.5-1 1.7-1.6 0.5-0.8-1.1z" id="TWPEN" data-name="澎湖縣"></path>
                              <path d="M657.2 325.1l6.4-10.3 5-5.9 5.2-4.4 13.2-4.4 3.1-1.9 2.7-2.4 3.3-1.8 6.4-2.3 14.5-2.6 3 3.3 4.6 2.2 3.4 2.2 2.3 2.1 2.9 0.7 3.1 1.6 3.7 5.4 0.3 2.9-0.7 3-2.4 2.5-9.4 2.8-2.7 2.9 0.2 4.5-0.8 4.1 0.8 3.7 3.8 3.7 0.8 3.7-1 4.8 3.7 2.1 5.3-0.3 3.7 1.4 6 8.9-1 3.8-2.3 2.7 0.6 3.7 1 4.1 6.4 6 1.8 4-2.2 0.6-3.9 2.8 2.3 9-1.6 2.7-2.5 1-2.3-0.5-2.9 1.1-0.3 1.1-3.5-1.5-5.2-3-2.9-2.1-4-0.7-4.5-2.6-3.7-2.9-0.4-3.1 3.3-4.7 1.4-5.6-1.2-5.2-0.2-3.6-2.5-1.9-3.1-1.6-1.9-3.3-2.4-2.5-2.8 0.2-2.8-0.5-2.2-2.2-3-2.2-4.8-1.5-2.4-2.7 0.8-4.2-2.6-3-4.9-1.6-3-1.4-3.1-0.9-3.6-1.4-2.9-6.3-3.3-2.2-9.8 0.7-2.3-0.8z" id="TWTAO" data-name="桃園市"></path>
                              <path d="M657.2 325.1l2.3 0.8 9.8-0.7 3.3 2.2 2.9 6.3 3.6 1.4 3.1 0.9 3 1.4 4.9 1.6 2.6 3-0.8 4.2 2.4 2.7 4.8 1.5 3 2.2 2.2 2.2 2.8 0.5 2.8-0.2 2.4 2.5 1.9 3.3 3.1 1.6 2.5 1.9 0.2 3.6 1.2 5.2-1.4 5.6-3.3 4.7 0.4 3.1 3.7 2.9 4.5 2.6 4 0.7 2.9 2.1 5.2 3 3.5 1.5-1.7 4.7-1 3.4 0.4 3.2-2.7 4.2-10.1 10.2-3.1 7.5-2-0.5-7.7 0.7-0.5 0.4-0.5-3.5-3.3-5.6-2.3-2.4-1-3.1-3.6-2.9-9.1 2.3-3.4-0.4-4.9 0.4-5.5 1.5-3-0.7 0.7-3.7 0.9-3.3-0.7-2.9-0.7-2.1 0.7-2.3 0.5-2.4 0.3-2.8-0.6-3.8-2.7-2.4-8.8-4.2-4.3-3.2-2.8-3.2-3.2-8 1.8-2.2 1.6-4.1 2.5-3.1 4.2-1.7 3.7-0.6 1.7-1 0.7-2.7-1.3-2.6-2.8-2.8-3.9-2-10.9-3.5-6-2.6 0.1-0.1 1.1-1.6 0.4-2.7 0.6-2.1 1.5-2.1 1.9-1.6 1.8-0.6-0.1-0.9 0.5-2.1 1.6-4.4 1.5-2.3z" id="TWHSQ" data-name="新竹縣"></path>
                              <path d="M646.3 345.6l6 2.6 10.9 3.5 3.9 2 2.8 2.8 1.3 2.6-0.7 2.7-1.7 1-3.7 0.6-4.2 1.7-2.5 3.1-1.6 4.1-1.8 2.2-0.2 0.2-3.3 0.8-3.1-1.3-2-2.7-3-1.9-5-1.9 0.8-3 4-8.2 1.6-2.1 0.5-1.2 0-1.2-0.5-1.3-0.8-1.6 1.1-2.2 1.2-1.3z" id="TWHSZ" data-name="新竹市"></path>
                              <path d="M655 374.5l3.2 8 2.8 3.2 4.3 3.2 8.8 4.2 2.7 2.4 0.6 3.8-0.3 2.8-0.5 2.4-0.7 2.3 0.7 2.1 0.7 2.9-0.9 3.3-0.7 3.7 3 0.7 5.5-1.5 4.9-0.4 3.4 0.4 9.1-2.3 3.6 2.9 1 3.1 2.3 2.4 3.3 5.6 0.5 3.5-2.7 1.9-1.3 4-3.5 1.5-3.9-0.1-3 2.2-3.3 3.1-4.2 2.4-8.4 6.6-4.9 2-6.4 3.5-3.9-1.6-3.6-4-4.4-1.7-7.1-0.6-4 2.4-0.6 5.3-3.7 2-8.8 0.5-8.4-4.8-4.7-0.9-5.3-2.6-10.9-8-4.5-3.9-3.4-3.6-6.6-10.3 5.2-5.8 1.3-2.9 0.7-4.8 1.5-4 4.3-7.5 1.2-4.5 1.1-2 4.8-1.4 1.4-1.5 0.8-1.9 1-1.8 3-3.2 3.4-2.4 4-1.1 5.2 1-0.7-3.9 1.9-2.7 2.7-2.7 1.3-4.2 0.6-1.3 2.6-1.3 0.3-0.9 5 1.9 3 1.9 2 2.7 3.1 1.3 3.3-0.8 0.2-0.2z" id="TWMIA" data-name="苗栗縣"></path>
                              <path d="M712.3 433.2l0.5-0.4 7.7-0.7 2 0.5 2.6 0.8-0.5 4 1.1 2.6 3.5 0.8 3.2 1.9 2.7 1.8 2.8-0.4 3.4-1.7 3.6 0 4.2 3.4-3.4 3.5-0.3 3-1.7 4.5-5.4 3.4-2.2 3.6-0.9 3.7-2.2 2.7-2.5 1.3-0.9 1.4-2 1.5-9.6-0.9-3.4-0.8-3.4 0.2-8 3.2-4.5 0.7-4.4 0.2-6.4 3.3-3.2 0.6-3.6 2.1-5.7 5.5-3.6 1.4-4.8-0.1-3.4 2.8-1.9 3.9-2.5 0.7-6.4-4.8-2.2 1.4-4.2 5.5-4.3 0.2-7.3-1.1-4.6 2.2-2.7 6.1-5.4 10.4-3.6 3.4-3 0.5-13-1.8-3-0.1-0.1-1-3.9-2.6-3.1-0.5-0.9-2.5 0-2.8-1.4-2.9-2.3-3.6-3.2-2.6-8.5-2.5-3.3-3.9-0.7-5.5-1.9-4.6-2.9-2.5-4.2-1.3 0.5-0.6 0.5-2.4 2.4-1.9 1.6-4.7 1.9-8.8 6.7-11.7 2.1-7.1 2.4-4 9.6-10.6 6.6 10.3 3.4 3.6 4.5 3.9 10.9 8 5.3 2.6 4.7 0.9 8.4 4.8 8.8-0.5 3.7-2 0.6-5.3 4-2.4 7.1 0.6 4.4 1.7 3.6 4 3.9 1.6 6.4-3.5 4.9-2 8.4-6.6 4.2-2.4 3.3-3.1 3-2.2 3.9 0.1 3.5-1.5 1.3-4 2.7-1.9z" id="TWTXG" data-name="台中市"></path>
                              <path d="M563.1 480.3l4.2 1.3 2.9 2.5 1.9 4.6 0.7 5.5 3.3 3.9 8.5 2.5 3.2 2.6 2.3 3.6 1.4 2.9 0 2.8 0.9 2.5 3.1 0.5 3.9 2.6 0.1 1 0 2.6-3.1 1.1-0.9 2.1 0.4 2.9-1.4 3.3-1.2 3.9-0.1 4.1-0.8 4.7-0.7 9.7 1.5 4.5 2.6 2.4 2.8 1 4.1 2.1-0.7 2.5-2.8 1.1-1.8 1.7-1.7 1.1-0.7 0.5-8.7-1.7-4.2 0.1-8.7-4.4-14.2-1.6-8.4-3.2-4.8-1.3-5.4-0.3-15.9 1.9-5.5-3.2 0.6-1 1.1-5.1 0.9-2.1 5.1-4.9 1.5-2.1 1.9-5.6 3-5.6 4.2-11.6 1.9-3.3 2.2-2.2 1.8-1.2 1.5-0.8 1.2-1 0.4-2.2 0.9-2 3.7-2.9 0.8-2.2 0.4-7.2 0.7-2 1.9-1.9 8.2-9.5z" id="TWCHA" data-name="彰化縣"></path>
                              <path d="M519.2 556.7l5.5 3.2 15.9-1.9 5.4 0.3 4.8 1.3 8.4 3.2 14.2 1.6 8.7 4.4 4.2-0.1 8.7 1.7 0.7-0.5 1.4 5.2-1.5 3.4-0.7 5.2 0.7 5.5-1.3 3.7-0.7 4.2 2.8 3.4 4.2 1.8 4.9-1.5 6-0.6 1.9 2.5-0.4 0-0.3 3.6 0 2.5-2.8 0.9-8.4 1.7-4.6 0.5-1.7-2.9-3.4-2.4-6 1.7-2.7 0.4-9.1-3.3-3.6-4.2-3.8-3.4-4.9 0.3-9.1 1.7-5.2 1.4-11.8 6.8-2.7 2.7-3.2 1.7-5 4.1-3.9 0.6-1.4 2.2-1.3 3.5-2.8 2.3-4.4-0.1-6-3.3-7.6 0.8-0.1 0.1-0.7 0 3.4-3.7-0.2-11.8 0.5-8.9 2-7 3.2-5.6 0.9-7.2 1.7-6.3 0.9-2.2 4.4-5.8 0.7-2 0.6-1.1 4-3.1 0.6-1.2z" id="TWYUN" data-name="雲林縣"></path>
                              <path d="M496.5 622.6l0.7 0 0.1-0.1 7.6-0.8 6 3.3 4.4 0.1 2.8-2.3 1.3-3.5 1.4-2.2 3.9-0.6 5-4.1 3.2-1.7 2.7-2.7 11.8-6.8 5.2-1.4 9.1-1.7 4.9-0.3 3.8 3.4 3.6 4.2 9.1 3.3 2.7-0.4 6-1.7 3.4 2.4 1.7 2.9 4.6-0.5 8.4-1.7 2.8-0.9 0-2.5 0.3-3.6 0.4 0 4.4 0.5 4.8 1.9 3 0.8 3.7 2.1-0.3 3.8-2.1 3.7 0.9 3.4 1.9 4.7 0.3 4.2 0.8 2.8 5.5 1 18.4 0.1 0.6 0.2-13.3 6.8-6.1 4.8-2.5 4.9-3.1 3.7-5.5 3.1-5.8 4.4-3.2 3.8-8.9 5.3-4.2 0.4-4.9-0.5-2.6 2.6-0.1 3.5 1 3.3 0.7 4.8-6-0.7-2.7-0.8-3.6 0.5-3.8 1.7-2.7 0-3.3-2.5-1.1-3.3 1.2-10.3-0.7-5.4-7.1-7.3-1.3-3.6-1.5-3.1-2.9-1.7-5.1-1.7-6.1 0.3-11 2.1-5.6 2.5-4.4 3.3-3.4 3.4-4.8 3.7-4.1 2.6-1.8 3.6-4.5 2-5.3-1.3-6.3-1-3.8-1.4 2.8-0.2 2.3-1 1 0.3-0.6-2.3-1.6 1.2-1.3-0.4-1.8-0.1 0-2.3 1.8-4.1 2.6-0.2 3.9 0-2.6-7.5-3.1-5.8 1.4-2.6 0-1.4-2.2-1.1 0.3-1.2 1.3-1.5 0.6-1.9 3-3.8-6.2 0.4-0.2-6.3z m62.7 15.5l4.9-2 3.2-0.4 2.2-1.6-1.9-4.9-1.7-2.9-3-1.6-4-1.5-5.7 0.5-6.7 1.2-2.7 2.9 0.6 4.1 4.4 1.7 5.1 3.3 5.3 1.2z m-82.1-1.3l10.1-10.2 7.6-9.7 1.8-0.5-6.5 10.5-3.2 3.2-2.1 2.6-2.7 2.7-2.2 1.5-3.2 2.6-2.2 1.2 2.6-3.9z" id="TWCYQ" data-name="嘉義縣"></path>
                              <path d="M495.1 664.4l3.8 1.4 6.3 1 5.3 1.3 4.5-2 1.8-3.6 4.1-2.6 4.8-3.7 3.4-3.4 4.4-3.3 5.6-2.5 11-2.1 6.1-0.3 5.1 1.7 2.9 1.7 1.5 3.1 1.3 3.6 7.1 7.3 0.7 5.4-1.2 10.3 1.1 3.3 3.3 2.5 2.7 0 3.8-1.7 3.6-0.5 2.7 0.8 6 0.7-1.6 4.8-7.5 10.9-7.2 12.2-4.7 6-5.4 5.3-4.6 3.9-4.5 4.6-3.8 5.1-2.1 3.7-1.7 4-4.6 3.2-4.6 1.9-2.6 1.8-3 1.1-6.1-0.7-5.9 0.6-11.3-1.6-3.5-1.8-2.8-6.2-0.1-0.3-4.5 2.6-0.7-4.5-1.3-2.6-2.8-2.8 3.5-2.5 1.9-4.3-0.8-3.8-4.6-0.7-0.8 1.4-0.8 2.4-1.3 1.9-2.4-0.1-0.9-1.6 0.3-5-0.5-1.8-3-1.3-1.6 1.5-1.4 2.1-1.9 0.5-2.1-1.8-0.6-2.5 0.5-2.4 0.9-1.7 2.1-1.1 2.7-0.4 2.2-0.7 0.7-2.2-1-1.1-6.7-1.7 0-1.4 5.6 0-0.5-1.9-3.1-2.7-2-2.3 0.5-2.9 1.8-1 1.9-0.7 1-1.8-0.6-2.8-1-2.3 0.7-2.2 1-2.6 1.6-1.9-0.3-1.7 0.3-1.6 2.4-6.5 1.2-1.2 1.8-0.5-2.7-1.8 1.2-2.9z" id="TWTNN" data-name="台南市"></path>
                              <path d="M596.8 682.8l-0.7-4.8-1-3.3 0.1-3.5 2.6-2.6 4.9 0.5 4.2-0.4 8.9-5.3 3.2-3.8 5.8-4.4 5.5-3.1 3.1-3.7 2.5-4.9 6.1-4.8 13.3-6.8 3.2 0.7 4.2 1.6 3 4.2 0.5 1.5 1.4 4.2-2.2 3.5-4 1.8-1 2.3 0.7 2.9 4 2.6 4.6 3.7 2 5.5 0.2 1.8-11.2 2.8-4.7 2.9-2.9 2.8-5.6 3.7-0.6 4.1 1.6 4.3-1.9 3.5-5.3 2.9-0.7 5 1.6 7.1-2.2 9.5 0 8.1-3.1 4.2-6.2 5.3-1.7 7 1 5.9 2.2 3.3 4.4 4.6 0.9 3.5-2.8 0.4-3.8-0.7-3.1 0.2-6.1 4.8-4.3-4-5.4-6.4-5.2 1.3-4.8 4.3-9.4-4.8-6.8 3.2-4.6 5.1-5.7 2.1-12.9-0.8-1.3 3.5-0.9 5.2-1.9 5.7 0.4 5-0.1 6.9-4 15.3-0.2 5.1 2 5.4 0.3 5.9-5.8 14.8-1.9-0.8-1.1 0-1.4 0.5-1.5 0.1-9.4-7.4-8.8-12.4 9.2 11.1-1-5.2-1.6-2.9-1.2-2.3-3.8-4.4-6.5-6-2.5-3.1-1.2-3.4 1.6-3.3 0.8-3-1.1-4.1-1.9-4.1-3.6-5.5-3.3-7.4-0.7-3.3 0-2.1 1.1-2.6 0.3-1.7-0.4-0.9-1-0.7-0.9-0.9-0.4-1.7-2.1-3.5-0.5-1.4-1.6-9.9 4.5-2.6 0.1 0.3 2.8 6.2 3.5 1.8 11.3 1.6 5.9-0.6 6.1 0.7 3-1.1 2.6-1.8 4.6-1.9 4.6-3.2 1.7-4 2.1-3.7 3.8-5.1 4.5-4.6 4.6-3.9 5.4-5.3 4.7-6 7.2-12.2 7.5-10.9 1.6-4.8z" id="TWKHH" data-name="高雄市"></path>
                              <path d="M551.1 836.2l5.8-14.8-0.3-5.9-2-5.4 0.2-5.1 4-15.3 0.1-6.9-0.4-5 1.9-5.7 0.9-5.2 1.3-3.5 12.9 0.8 5.7-2.1 4.6-5.1 6.8-3.2 9.4 4.8 4.8-4.3 5.2-1.3 5.4 6.4 4.3 4 6.1-4.8 3.1-0.2 3.8 0.7 2.5 4.7 0.5 3.5 3.9 1 4 2.6-2 9.9-0.1 3.8-1.5 3.5-7 3-3.5 2-5.5 1.2-3.9 3.2-1.7 4.7-2.6 4.8-2.2 5.4-0.6 10.6 0.9 4.7 1.4 4.4 0.8 5.1 0 3.8 1.9 3.7 3.3 4-1.8 2.7-3.8 2.3-1.5 2.8-0.4 3.3 2 2.8 2.4 1.2 2.3 3.2-0.1 4.1 0.4 4.4 2.3 4.3 3.3 3.5 7.4 3.4 3.2-0.3 0.6 37.2-1.1 5.3-1.8 4.3-2.4 1.8-2.9 2.7 0.1 6 1 6.6-0.2 4.2-3.3-4.9-4.9-3.7-5.7-2.5-5.7-1.4-0.2 4.7-1.7 1.7-2.4-0.6-2.7-2.2-0.1-1.7 0.9-5-4-6.7-0.3-1.8 0-1.4 0.3-2.4 0-7.7 0.4-2.3 1.8-2.5 0.4-2.2-14.4-37.2-1.1-2.1-4-4.9-3.2-7.1-1.4-2.1-5.9-4.6-2.3-1.3-0.8-0.3-0.8-0.6-0.7-2.6-0.5-1-3.1-2.1-7.3-3.4-3.2-2.3-3.5-3-1.6-1-0.2-0.1z" id="TWPIF" data-name="屏東縣"></path>
                              <path d="M634.7 759.1l2.8-0.4-0.9-3.5-4.4-4.6-2.2-3.3-1-5.9 1.7-7 6.2-5.3 3.1-4.2 0-8.1 2.2-9.5-1.6-7.1 0.7-5 5.3-2.9 1.9-3.5-1.6-4.3 0.6-4.1 5.6-3.7 2.9-2.8 4.7-2.9 11.2-2.8 0.8 5.3 3.7 5.9 5.6 2 4.4 2.1 3.6 3.4 4.5 0.7 4.1 1.1 6.6 11.5 8.5 7 5.9 0.8 4.7-2.7 0.6-4.4 0-4.9 2.2-4.3 3.5-9.6 2.6-5.5 1.8-6.1 1.9-4.8 2.5-3.7 2.6-5-0.4-4.9-1.3-5 2.8-3.9 7.8-3.8 2.5 0.8-3.3 19-1.6 3.5-5.1 6.8-1.9 3.5-1.5 4.4-1 8.3 0.1 7.3-0.8 6.9-3.5 7.2-1.5 1.6-3.4 2.5-1.5 1.6-0.8 1.6-1.2 4.2-3.5 6.1-2.1 9.4-1.5 4.2-7.4 10.7-0.9 2-10 8.4-2.4 2.8-0.4 1.9 0.5 4.5-0.1 2-0.9 2.3-1.6 2.6-3.4 4.3-3.4 3.2-11.6 7.8-7.8 8.5-1.9 1-1.5 2-3.8 9.7-1.8 3.6-5.8 7.3-2.4 4.3-1.3 8.8-3.5 12.1-6.9 12.1-1 4.1-1.2 11.6 0.2 10.5-3.2 0.3-7.4-3.4-3.3-3.5-2.3-4.3-0.4-4.4 0.1-4.1-2.3-3.2-2.4-1.2-2-2.8 0.4-3.3 1.5-2.8 3.8-2.3 1.8-2.7-3.3-4-1.9-3.7 0-3.8-0.8-5.1-1.4-4.4-0.9-4.7 0.6-10.6 2.2-5.4 2.6-4.8 1.7-4.7 3.9-3.2 5.5-1.2 3.5-2 7-3 1.5-3.5 0.1-3.8 2-9.9-4-2.6-3.9-1-0.5-3.5-2.5-4.7z m134.6 166.8l3.3 2.6 1.5 1.7-0.2 2-3.9 1.3-5.3-2.2-4.9-3.4-2.8-2.7 0.8-1.9 0-1.9-0.7-1.6-1.3-1.5 14.1 0 0 1.2-0.4 0.8-0.6 1.7-0.2 2.1 0.6 1.8z m-19.5-125.9l-1-3 0.4-0.4 7.3-0.6 0.8 0.5 0.5 1.4-0.6 2.8-0.6 1.2-0.3 1.2 0.3 1.1-0.1 0.8-0.5-0.1-1.3 0-0.6-0.2-0.3-0.4-1.9-0.7-2.1-3.6z" id="TWTTT" data-name="台東縣"></path>
                              <path d="M727.6 474.4l2-1.5 0.9-1.4 2.5-1.3 2.2-2.7 0.9-3.7 2.2-3.6 5.4-3.4 1.7-4.5 0.3-3 3.4-3.5 1.8 1.5 4.7 2.2 10.8 2.8 6 2.3 4.7 0 3.5-3.3 1.7-4.3 2.7-0.6 13.4 7.9 8 1.3 0.8 0 0.5 0.5 0.6 1.1 0.5 1.1 0.2 0.7-1 1.7-4.2 4.1-4.6 6.3-3.3 2.7-1 1.4 0.5 1.5-0.6 1.1-4.9 3.6-1.8 1.8-2 4.3-2 8.8-5.4 7.8-1.1 3.2 0.2 3.4 1.3 3.8 1.1 1.6 0.9 0.7 0.6 1 0.1 2.3-0.8 2.7-2.7 4.1-0.5 2.5-0.3 4.6-2.3 11.7-4.6 12.4-5.8 28.8-3.4 7.1-8 46.2-2.5-0.8-7.8 3.8-2.8 3.9 1.3 5 0.4 4.9-2.6 5-2.5 3.7-1.9 4.8-1.8 6.1-2.6 5.5-3.5 9.6-2.2 4.3 0 4.9-0.6 4.4-4.7 2.7-5.9-0.8-8.5-7-6.6-11.5-4.1-1.1-4.5-0.7-3.6-3.4-4.4-2.1-5.6-2-3.7-5.9-0.8-5.3-0.2-1.8-2-5.5-4.6-3.7-4-2.6-0.7-2.9 1-2.3 4-1.8 2.2-3.5-1.4-4.2 4.3-2.5 2.2-2.1-1.2-4.4 1.1-1.9 1.1-3 3.7-2.7 5.4-1.2 5.3-0.2 3.8-3.4 1-6.2 2.8-3.7 5.5-2 3.3-2.3 1.1-3.6 2.3-9.1 0.9-6-0.7-5.2-0.8-3.9-2.3-2.9-1.5-2.9 4.1-6.8 0.1-2.7 1.8-5.1 2.8-6.1 2.2-6.3 1.1-7.2 0.5-5.4-1.3-3.2-1.5-2.4 1.7-5.5 3.7-7.7 5.8-7.6 0.1-2.7-1-3.3-3.8-2.4-2-2.2-0.2-7.2 2.7-2.1 4.7-1.6 3.8-1.7-0.2-2.6-1-4.5z" id="TWHUA" data-name="花蓮縣"></path>
                              <path d="M740.7 399.4l0.3-1.1 2.9-1.1 2.3 0.5 2.5-1 1.6-2.7-2.3-9 3.9-2.8 2.2-0.6 4.2-1.2 3.5-1.3 2.7-2.4 3.6-2.5 4.8-2.3 2.8-2-0.3-1.4-0.7-2.3-0.1-3 1.4-3.6 3.4-2.9 2.7-1.6 9.4-3.8 9.7-5.9 4.5-1.3 3.6-2.6 2.3-3.7 2.3-2.9 2.7-1.4 2.5-0.9 3.3-2.1 1.2-2.8-1.8-2.5 1-2.2 8.1-1.6 2.6-1.8 6-3.2 4.3-0.9 2.4 1.4 0.6 0.8-8.6 4.3-4 3.4-13.5 16.4-2.1 3.5-1.7 4.8-1.1 5.6-0.4 5.5 0.2 5.3 2.4 11.2-0.2 2.9-1 2.8 0.2 5.8 2.4 4.5 4.7 2.9 5.5 1.1 0 1.2-2.3-0.2-2.2 0.2-1.9 0.6-1.3 1 1.9 3.6 0.9 4.7-0.6 4.1-4.3 2.4-0.3 1.8 0.6 2.1 1.2 2 0.4 2-1.8 1.7-4.5 2.6-5 5.8-0.2 2.3 0.3 5-0.8 2-1 1.6-0.6 2.3-0.3 4.6-0.4 1.2-0.7 0.9-0.4 1 0.7 1.2 0.2 0.2-0.8 0-8-1.3-13.4-7.9-2.7 0.6-1.7 4.3-3.5 3.3-4.7 0-6-2.3-10.8-2.8-4.7-2.2-1.8-1.5-4.2-3.4-3.6 0-3.4 1.7-2.8 0.4-2.7-1.8-3.2-1.9-3.5-0.8-1.1-2.6 0.5-4-2.6-0.8 3.1-7.5 10.1-10.2 2.7-4.2-0.4-3.2 1-3.4 1.7-4.7z" id="TWILA" data-name="宜蘭縣"></path>
                              <path d="M754.1 381.6l-1.8-4-6.4-6-1-4.1-0.6-3.7 2.3-2.7 1-3.8-6-8.9-3.7-1.4-5.3 0.3-3.7-2.1 1-4.8-0.8-3.7-3.8-3.7-0.8-3.7 0.8-4.1-0.2-4.5 2.7-2.9 9.4-2.8 2.4-2.5 0.7-3-0.3-2.9-3.7-5.4-3.1-1.6-2.9-0.7-2.3-2.1-3.4-2.2-4.6-2.2-3-3.3 8.1-1.5 3.4-1.3 4.5-3.7 1.3-0.7 1.6-0.3 2.2 0 2.6 0.8 1.3 1.9 0.9 2 1.1 1.1 2.5-1-2.6-4.1-4.2-4.2-2.2-1.4 0.7-1.9 1.3-1.1 1.3-0.7 0.6-0.6 1.5-3.8 2.3-4.2 4.7-4.3 7-3.5 7.9-1.8 7.8 0.9 3.2 2.5 7.3 10.1 2.5 5.4 0.9-0.3 1.9-0.6 2.3-0.2 1.5 0.4-0.1 0.7-0.7 0.9-0.7 1.3 0 1.5 0.8 0.9 1.6 1.2-3.1 2.1-5.2 2.3-2.3 1.5 0.4 2.1 2.1 2.7 1.2 2.5 2.1 2.5 2.6 2.5 2.2 1.6 7.6 3.1 3.7 0.5 2.9-1.1 1.8-1.3 0.3-1.8-2.7-2.8-0.1-2.2 0.2-8.6 24.9 6.1 2.4 1.5-1.2 2.6-0.3 2.1 0.5 3.8 1.7 6.2 1.9 3 1.6 0.7 5-0.8 2.6 0.3 3 0.8 2.7 1.3 1.5 1.9-6.3 3.1-0.6-0.8-2.4-1.4-4.3 0.9-6 3.2-2.6 1.8-8.1 1.6-1 2.2 1.8 2.5-1.2 2.8-3.3 2.1-2.5 0.9-2.7 1.4-2.3 2.9-2.3 3.7-3.6 2.6-4.5 1.3-9.7 5.9-9.4 3.8-2.7 1.6-3.4 2.9-1.4 3.6 0.1 3 0.7 2.3 0.3 1.4-2.8 2-4.8 2.3-3.6 2.5-2.7 2.4-3.5 1.3-4.2 1.2z m22.7-60.5l3-1.2 5.5-7 1.4-3-2.7-2.3-3.3-1.9-0.1-3.6 1.1-4.8-1.1-3.2-2.8-2.5-1.8-7.2-1.2-2.6-1.1-2.4-0.3-2.4 0.4-2.6-1.5-1.6-2.8-0.9-2.9 1.4-2.1 1.8-7.8 4.7-2.6 2.9-1.5 3.3-1.3 1.7-1.2 2.1 2.7 3.1 4.2 4 0.8 4.5-1.1 5.3 2.9 4.9 4.1 3.2 2.8 3.2 2.6 2.3 3.5 0.8 4.2 0z" id="TWNWT" data-name="新北市"></path>
                              <path d="M806.8 285.1l-0.2 8.6 0.1 2.2 2.7 2.8-0.3 1.8-1.8 1.3-2.9 1.1-3.7-0.5-7.6-3.1-2.2-1.6-2.6-2.5-2.1-2.5-1.2-2.5-2.1-2.7-0.4-2.1 2.3-1.5 5.2-2.3 3.1-2.1 1.1 0.7 0.5 0.8 1.2 1.1 2.8 1.1 8.1 1.9z" id="TWKEE" data-name="基隆市"></path>
                              <path d="M599.5 519.1l3 0.1 13 1.8 3-0.5 3.6-3.4 5.4-10.4 2.7-6.1 4.6-2.2 7.3 1.1 4.3-0.2 4.2-5.5 2.2-1.4 6.4 4.8 2.5-0.7 1.9-3.9 3.4-2.8 4.8 0.1 3.6-1.4 5.7-5.5 3.6-2.1 3.2-0.6 6.4-3.3 4.4-0.2 4.5-0.7 8-3.2 3.4-0.2 3.4 0.8 9.6 0.9 1 4.5 0.2 2.6-3.8 1.7-4.7 1.6-2.7 2.1 0.2 7.2 2 2.2 3.8 2.4 1 3.3-0.1 2.7-5.8 7.6-3.7 7.7-1.7 5.5 1.5 2.4 1.3 3.2-0.5 5.4-1.1 7.2-2.2 6.3-2.8 6.1-1.8 5.1-0.1 2.7-4.1 6.8 1.5 2.9 2.3 2.9 0.8 3.9 0.7 5.2-0.9 6-2.3 9.1-1.1 3.6-3.3 2.3-5.5 2-2.8 3.7-1 6.2-3.8 3.4-5.3 0.2-5.4 1.2-3.7 2.7-1.1 3-1.1 1.9 1.2 4.4-2.2 2.1-4.3 2.5-0.5-1.5-3-4.2-4.2-1.6-3.2-0.7-0.6-0.2-18.4-0.1-5.5-1-0.8-2.8-0.3-4.2-1.9-4.7-0.9-3.4 2.1-3.7 0.3-3.8-3.7-2.1-3-0.8-4.8-1.9-4.4-0.5-1.9-2.5-6 0.6-4.9 1.5-4.2-1.8-2.8-3.4 0.7-4.2 1.3-3.7-0.7-5.5 0.7-5.2 1.5-3.4-1.4-5.2 1.7-1.1 1.8-1.7 2.8-1.1 0.7-2.5-4.1-2.1-2.8-1-2.6-2.4-1.5-4.5 0.7-9.7 0.8-4.7 0.1-4.1 1.2-3.9 1.4-3.3-0.4-2.9 0.9-2.1 3.1-1.1 0-2.6z" id="TWNAN" data-name="南投縣"></path>
                              <path d="M776.8 321.1l-4.2 0-3.5-0.8-2.6-2.3-2.8-3.2-4.1-3.2-2.9-4.9 1.1-5.3-0.8-4.5-4.2-4-2.7-3.1 1.2-2.1 1.3-1.7 1.5-3.3 2.6-2.9 7.8-4.7 2.1-1.8 2.9-1.4 2.8 0.9 1.5 1.6-0.4 2.6 0.3 2.4 1.1 2.4 1.2 2.6 1.8 7.2 2.8 2.5 1.1 3.2-1.1 4.8 0.1 3.6 3.3 1.9 2.7 2.3-1.4 3-5.5 7-3 1.2z" id="TWTPE" data-name="台北市"></path>
                              <path d="M559.2 638.1l-5.3-1.2-5.1-3.3-4.4-1.7-0.6-4.1 2.7-2.9 6.7-1.2 5.7-0.5 4 1.5 3 1.6 1.7 2.9 1.9 4.9-2.2 1.6-3.2 0.4-4.9 2z" id="TWCYI" data-name="嘉義市"></path>
                            </g>
                          </svg>
                          </div>
                          <!-- 地圖圖例 - 毛玻璃懸浮（固定位置） -->
                          <div class="map-legend">
                            <span class="legend-item"><span class="legend-dot" style="background: #e53935;"></span>500+</span>
                            <span class="legend-item"><span class="legend-dot" style="background: #fb8c00;"></span>300-499</span>
                            <span class="legend-item"><span class="legend-dot" style="background: #fdd835;"></span>100-299</span>
                            <span class="legend-item"><span class="legend-dot" style="background: #43a047;"></span>&lt;100</span>
                          </div>
                        </div>
                      </div>
                      <!-- 縣市分布表格 -->
                      <div class="col-lg-5">
                        <div class="table-responsive city-table-container" id="cityTableContainer">
                          <table class="table table-sm mb-0">
                            <thead class="sticky-top" style="background: #f8f9fa;">
                              <tr>
                                <th class="border-0 py-2" style="font-weight: 600;">縣市</th>
                                <th class="border-0 py-2 text-end" style="font-weight: 600;">家數</th>
                                <th class="border-0 py-2" style="width: 45%; font-weight: 600;">分布</th>
                              </tr>
                            </thead>
                            <tbody id="cityDistributionTable">
                              <tr><td colspan="3" class="text-center text-muted py-4">載入中...</td></tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 右側：產業分布環狀圖 -->
              <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-transparent border-0 pt-3 pb-0">
                    <h6 class="fw-semibold mb-0 d-flex align-items-center">
                      <span class="material-icons me-2" style="font-size: 20px; color: #4472C4;">donut_large</span>
                      產業別分布
                    </h6>
                  </div>
                  <div class="card-body pt-2 d-flex flex-column">
                    <div class="d-flex align-items-center justify-content-center" style="min-height: 280px;">
                      <canvas id="industryDonutChart" style="max-height: 280px;"></canvas>
                    </div>
                    <div class="mt-auto pt-3">
                      <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm mb-0">
                          <thead class="sticky-top" style="background: #f8f9fa;">
                            <tr>
                              <th class="border-0 py-2" style="font-weight: 600;">產業別</th>
                              <th class="border-0 py-2 text-end" style="font-weight: 600;">家數</th>
                              <th class="border-0 py-2 text-end" style="font-weight: 600;">佔比</th>
                            </tr>
                          </thead>
                          <tbody id="industryDistributionTable">
                            <tr><td colspan="3" class="text-center text-muted py-4">載入中...</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 資料列表 Tab -->
          <div class="tab-pane fade" id="list-pane" role="tabpanel" aria-labelledby="list-tab">
            <!-- 搜尋與篩選 -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">搜尋</label>
                <input type="search" class="form-control" id="keyword" placeholder="輸入公司名稱 / 統一編號" oninput="filterCompanies()">
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">縣市</label>
                <select class="form-select" id="cityFilter" onchange="filterCompanies()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">產業別</label>
                <select class="form-select" id="industryFilter" onchange="filterCompanies()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">數位化階段</label>
                <select class="form-select" id="stageFilter" onchange="filterCompanies()">
                  <option value="">全部</option>
                  <option value="尚未開始">尚未開始</option>
                  <option value="初步導入階段">初步導入階段</option>
                  <option value="持續優化階段">持續優化階段</option>
                  <option value="成熟運用階段">成熟運用階段</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mt-1">
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">聯絡人</label>
                <input type="text" class="form-control" id="contactFilter" placeholder="輸入聯絡人姓名" oninput="filterCompanies()">
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">地區（鄉鎮市區）</label>
                <select class="form-select" id="districtFilter" onchange="filterCompanies()">
                  <option value="">全部</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- 公司列表 -->
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">公司列表（<span id="companyCount">0</span> 家）</h5>
            <div>
              <div class="btn-group me-2">
                <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">download</span>
                  匯出報表
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="exportCompanyList(); return false;">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">list_alt</span>
                    公司清單
                  </a></li>
                  <li><a class="dropdown-item" href="#" onclick="exportStatisticsSummary(); return false;">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">assessment</span>
                    統計摘要
                  </a></li>
                </ul>
              </div>
            <button class="btn btn-primary btn-sm" onclick="addCompany()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</span>
              新增公司
            </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead style="background-color: #fafafa;">
                  <tr>
                    <th style="width: 50px;">#</th>
                    <th>公司名稱</th>
                    <th>統一編號</th>
                    <th>縣市</th>
                    <th>產業別</th>
                    <th>聯絡人</th>
                    <th>員工規模</th>
                    <th>數位化階段</th>
                    <th>問卷數</th>
                    <th>加入時間</th>
                    <th style="width: 120px; white-space: nowrap;">操作</th>
                  </tr>
                </thead>
                <tbody id="companiesTableBody">
                  <tr>
                    <td colspan="11" class="text-center py-4 text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
          </div><!-- /list-pane -->
        </div><!-- /tab-content -->
      </div>
    </main>
  </div>

  <!-- 新增公司 Modal -->
  <div class="modal fade" id="companyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增公司</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">公司名稱 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="modalCompanyName" placeholder="請輸入公司名稱">
            </div>
            <div class="col-md-6">
              <label class="form-label">統一編號</label>
              <input type="text" class="form-control" id="modalTaxId" placeholder="請輸入8位統一編號（選填）" maxlength="8">
              <small class="text-muted">若無統編可留空，適用於個人工作室、小攤販等</small>
            </div>
            <div class="col-md-4">
              <label class="form-label">縣市 <span class="text-danger">*</span></label>
              <select class="form-select" id="modalCity">
                <option value="">請選擇縣市</option>
                <option value="台北市">台北市</option>
                <option value="新北市">新北市</option>
                <option value="桃園市">桃園市</option>
                <option value="台中市">台中市</option>
                <option value="台南市">台南市</option>
                <option value="高雄市">高雄市</option>
                <option value="基隆市">基隆市</option>
                <option value="新竹市">新竹市</option>
                <option value="嘉義市">嘉義市</option>
                <option value="新竹縣">新竹縣</option>
                <option value="苗栗縣">苗栗縣</option>
                <option value="彰化縣">彰化縣</option>
                <option value="南投縣">南投縣</option>
                <option value="雲林縣">雲林縣</option>
                <option value="嘉義縣">嘉義縣</option>
                <option value="屏東縣">屏東縣</option>
                <option value="宜蘭縣">宜蘭縣</option>
                <option value="花蓮縣">花蓮縣</option>
                <option value="台東縣">台東縣</option>
                <option value="澎湖縣">澎湖縣</option>
                <option value="金門縣">金門縣</option>
                <option value="連江縣">連江縣</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">鄉鎮市區</label>
              <input type="text" class="form-control" id="modalDistrict" placeholder="請輸入鄉鎮市區">
            </div>
            <div class="col-md-4">
              <label class="form-label">資本額</label>
              <input type="text" class="form-control" id="modalCapital" placeholder="例：1000萬">
            </div>
            <div class="col-12">
              <label class="form-label">地址</label>
              <input type="text" class="form-control" id="modalAddress" placeholder="請輸入詳細地址">
            </div>
            <div class="col-md-4">
              <label class="form-label">聯絡人姓名 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="modalContactPerson" placeholder="請輸入聯絡人姓名">
            </div>
            <div class="col-md-4">
              <label class="form-label">聯絡電話 <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="modalContactPhone" placeholder="例：02-1234-5678">
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="modalContactEmail" placeholder="example@company.com">
            </div>
            <div class="col-md-4">
              <label class="form-label">傳真</label>
              <input type="tel" class="form-control" id="modalFax" placeholder="例：02-1234-5679">
            </div>
            <div class="col-md-4">
              <label class="form-label">公司網址</label>
              <input type="url" class="form-control" id="modalWebsite" placeholder="https://www.company.com">
            </div>
            <div class="col-md-4">
              <label class="form-label">產業別 <span class="text-danger">*</span></label>
              <select class="form-select" id="modalIndustry">
                <option value="">請選擇產業別</option>
                <option value="製造業">製造業</option>
                <option value="批發及零售業">批發及零售業</option>
                <option value="住宿及餐飲業">住宿及餐飲業</option>
                <option value="資訊及通訊傳播業">資訊及通訊傳播業</option>
                <option value="專業、科學及技術服務業">專業、科學及技術服務業</option>
                <option value="運輸及倉儲業">運輸及倉儲業</option>
                <option value="金融及保險業">金融及保險業</option>
                <option value="農、林、漁、牧業">農、林、漁、牧業</option>
                <option value="電力及燃氣供應業">電力及燃氣供應業</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">員工規模</label>
              <select class="form-select" id="modalEmployeeRange">
                <option value="">請選擇員工規模</option>
                <option value="5人以下">5人以下</option>
                <option value="6-20人">6-20人</option>
                <option value="21-50人">21-50人</option>
                <option value="51-100人">51-100人</option>
                <option value="101-200人">101-200人</option>
                <option value="201人以上">201人以上</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">數位化階段</label>
              <select class="form-select" id="modalDigitalStage">
                <option value="">請選擇數位化階段</option>
                <option value="尚未開始">尚未開始</option>
                <option value="初步導入階段">初步導入階段</option>
                <option value="持續優化階段">持續優化階段</option>
                <option value="成熟運用階段">成熟運用階段</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveCompany()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="../assets/js/hardcoded-data.js"></script>
  <script src="../assets/js/layout.js"></script>
  <script>
    checkLogin('companies');
    initLayout('companies');

    const STORAGE_KEY = 'companiesStore';
    let allCompanies = [];

    // 取得預設示範公司資料（完整版 - 18家公司）
    function getDefaultCompanies() {
      return [
        {
          id: 'company-001',
          name: '台灣製造股份有限公司',
          taxId: '12345678',
          city: '台北市',
          district: '內湖區',
          address: '內湖路一段123號5樓',
          contactPerson: '陳志明',
          contactPhone: '02-2658-1234',
          contactEmail: 'contact@twmfg.com.tw',
          fax: '02-2658-1235',
          website: 'https://www.twmfg.com.tw',
          capital: '5000萬',
          industry: '製造業',
          employeeRange: '51-100人',
          digitalStage: '初步導入階段',
          joinedAt: '2025-10-01T09:00:00',
          createdAt: '2025-10-01T09:00:00',
          surveys: [
            { id: 'survey-001', name: '2025 Q1 數位轉型調查', status: '進行中', owner: '輔導組', creator: '王大明', createdAt: '2025-10-05', description: '針對製造業數位轉型需求進行調查', fields: [], responses: [] },
            { id: 'survey-002', name: '客戶滿意度調查', status: '草稿', owner: '客服組', creator: '李小華', createdAt: '2025-10-10', description: '了解客戶對數位服務的滿意度', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-001',
              date: '2025-10-08T14:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '數位轉型需求評估',
              content: '與公司主管進行初次訪談，了解目前營運狀況及數位化需求。主要需求包含：ERP 系統導入、生產線數位化、供應鏈管理優化。',
              consultant: '王大明'
            },
            {
              id: 'guidance-002',
              date: '2025-10-12T10:30:00',
              type: '技術輔導',
              status: '中期',
              title: 'ERP 系統選型建議',
              content: '根據公司規模與需求，建議導入中小企業適用的 ERP 系統。預估導入時間 3-6 個月，需要配合教育訓練。',
              consultant: '王大明'
            }
          ]
        },
        {
          id: 'company-002',
          name: '新北科技有限公司',
          taxId: '23456789',
          city: '新北市',
          district: '板橋區',
          address: '文化路二段88號12樓',
          contactPerson: '林美玲',
          contactPhone: '02-8965-4321',
          contactEmail: 'info@nttech.com',
          fax: '02-8965-4322',
          website: 'https://www.nttech.com',
          capital: '2000萬',
          industry: '資訊及通訊傳播業',
          employeeRange: '21-50人',
          digitalStage: '持續優化階段',
          joinedAt: '2025-10-03T14:30:00',
          createdAt: '2025-10-03T14:30:00',
          surveys: [
            { id: 'survey-003', name: '員工數位技能調查', status: '進行中', owner: '人資部', creator: '張志明', createdAt: '2025-10-08', description: '評估員工數位技能現況', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-003',
              date: '2025-10-06T15:00:00',
              type: '追蹤輔導',
              status: '結案',
              title: 'AI 工具應用成效檢討',
              content: '檢視公司導入的 AI 客服系統使用情況，整體滿意度良好，建議持續優化對話腳本。',
              consultant: '李小華'
            }
          ]
        },
        {
          id: 'company-003',
          name: '桃園餐飲集團',
          taxId: '34567890',
          city: '桃園市',
          district: '中壢區',
          address: '中央西路二段456號',
          contactPerson: '黃大維',
          contactPhone: '03-4225-678',
          contactEmail: 'service@tyfd.com.tw',
          fax: '03-4225-679',
          website: 'https://www.tyfd.com.tw',
          capital: '8000萬',
          industry: '住宿及餐飲業',
          employeeRange: '101-200人',
          digitalStage: '初步導入階段',
          joinedAt: '2025-10-05T10:15:00',
          createdAt: '2025-10-05T10:15:00',
          surveys: [
            { id: 'survey-004', name: '餐飲業數位化需求調查', status: '進行中', owner: '餐飲組', creator: '陳美玲', createdAt: '2025-10-12', description: '餐飲業數位化現況與需求', fields: [], responses: [] },
            { id: 'survey-005', name: '外送平台整合調查', status: '草稿', owner: '資訊組', creator: '陳美玲', createdAt: '2025-10-13', description: '多平台訂單整合需求評估', fields: [], responses: [] },
            { id: 'survey-006', name: '數位支付使用情況', status: '進行中', owner: '財務組', creator: '陳美玲', createdAt: '2025-10-14', description: '數位支付工具使用狀況', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-004',
              date: '2025-10-09T11:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '餐飲業數位化轉型規劃',
              content: '討論多店面管理系統、外送平台整合、數位行銷等需求。建議優先導入 POS 系統整合方案。',
              consultant: '陳美玲'
            },
            {
              id: 'guidance-005',
              date: '2025-10-14T16:00:00',
              type: '技術輔導',
              status: '中期',
              title: '外送平台系統整合建議',
              content: '評估多個外送平台整合方案，推薦採用第三方整合系統，可節省人力成本。',
              consultant: '陳美玲'
            }
          ]
        },
        {
          id: 'company-004',
          name: '台中批發貿易行',
          taxId: '45678901',
          city: '台中市',
          district: '西屯區',
          address: '台灣大道三段789號1樓',
          contactPerson: '吳建國',
          contactPhone: '04-2315-8899',
          contactEmail: 'tcwholesale@gmail.com',
          fax: '04-2315-8898',
          website: '',
          capital: '500萬',
          industry: '批發及零售業',
          employeeRange: '6-20人',
          digitalStage: '尚未開始',
          joinedAt: '2025-09-28T16:20:00',
          createdAt: '2025-09-28T16:20:00',
          surveys: [],
          guidanceRecords: [
            {
              id: 'guidance-013',
              date: '2025-09-29T10:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '批發業數位轉型初步評估',
              content: '了解傳統批發業營運模式，主要痛點為庫存管理效率低、訂單處理人工化。建議優先導入進銷存系統。',
              consultant: '王大明'
            }
          ]
        },
        {
          id: 'company-005',
          name: '高雄顧問管理公司',
          taxId: '56789012',
          city: '高雄市',
          district: '前鎮區',
          address: '中華五路101號8樓之3',
          contactPerson: '鄭雅文',
          contactPhone: '07-7225-999',
          contactEmail: 'contact@khconsult.com',
          fax: '07-7225-998',
          website: 'https://www.khconsult.com',
          capital: '1000萬',
          industry: '專業、科學及技術服務業',
          employeeRange: '21-50人',
          digitalStage: '成熟運用階段',
          joinedAt: '2025-10-07T11:45:00',
          createdAt: '2025-10-07T11:45:00',
          surveys: [
            { id: 'survey-007', name: '顧問服務數位化評估', status: '進行中', owner: '服務組', creator: '張志明', createdAt: '2025-10-09', description: '顧問服務流程數位化評估', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-006',
              date: '2025-10-09T09:30:00',
              type: '初次訪談',
              status: '初訪',
              title: '顧問業數位化需求評估',
              content: '討論顧問服務流程數位化需求，包含案件管理系統、客戶關係管理、線上諮詢平台等。',
              consultant: '張志明'
            }
          ]
        },
        {
          id: 'company-006',
          name: '台南紡織工業股份有限公司',
          taxId: '67890123',
          city: '台南市',
          district: '永康區',
          address: '中華路888號',
          contactPerson: '謝文雄',
          contactPhone: '06-2435-777',
          contactEmail: 'tn.textile@company.com',
          fax: '06-2435-778',
          website: 'http://www.tntextile.com.tw',
          capital: '3億',
          industry: '製造業',
          employeeRange: '201人以上',
          digitalStage: '持續優化階段',
          joinedAt: '2025-09-25T08:30:00',
          createdAt: '2025-09-25T08:30:00',
          surveys: [
            { id: 'survey-008', name: '生產線自動化調查', status: '進行中', owner: '生產部', creator: '王大明', createdAt: '2025-09-30', description: '評估生產線自動化需求', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-007',
              date: '2025-09-28T14:00:00',
              type: '技術輔導',
              status: '中期',
              title: '智慧製造解決方案評估',
              content: '針對紡織生產線進行智慧製造評估，建議導入 IoT 感測器進行品質監控，預估可提升 15% 生產效率。',
              consultant: '王大明'
            },
            {
              id: 'guidance-008',
              date: '2025-10-05T10:00:00',
              type: '追蹤輔導',
              status: '中期',
              title: 'IoT 設備導入進度追蹤',
              content: '確認設備採購進度，協助解決系統整合問題。預計下月開始試運行。',
              consultant: '王大明'
            }
          ]
        },
        {
          id: 'company-007',
          name: '基隆物流運輸有限公司',
          taxId: '78901234',
          city: '基隆市',
          district: '仁愛區',
          address: '孝一路25號',
          contactPerson: '劉建宏',
          contactPhone: '02-2428-5566',
          contactEmail: 'kl.logistics@gmail.com',
          fax: '02-2428-5567',
          website: '',
          capital: '3000萬',
          industry: '運輸及倉儲業',
          employeeRange: '51-100人',
          digitalStage: '初步導入階段',
          joinedAt: '2025-10-10T13:00:00',
          createdAt: '2025-10-10T13:00:00',
          surveys: [
            { id: 'survey-009', name: '物流追蹤系統調查', status: '進行中', owner: '物流組', creator: '李小華', createdAt: '2025-10-11', description: '物流追蹤系統需求評估', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-009',
              date: '2025-10-11T15:30:00',
              type: '初次訪談',
              status: '初訪',
              title: '物流數位化需求訪談',
              content: '了解現有物流管理流程，主要痛點為車輛調度效率不佳、貨物追蹤困難。建議導入 GPS 追蹤系統與智慧調度平台。',
              consultant: '李小華'
            }
          ]
        },
        {
          id: 'company-008',
          name: '新竹電子科技公司',
          taxId: '89012345',
          city: '新竹市',
          district: '東區',
          address: '光復路二段101號',
          contactPerson: '徐志強',
          contactPhone: '03-5713-888',
          contactEmail: 'info@hcelectronics.com',
          fax: '03-5713-889',
          website: 'https://www.hcelectronics.com',
          capital: '1.5億',
          industry: '製造業',
          employeeRange: '101-200人',
          digitalStage: '成熟運用階段',
          joinedAt: '2024-12-15T10:00:00',
          createdAt: '2024-12-15T10:00:00',
          surveys: [
            { id: 'survey-010', name: '智慧製造評估', status: '進行中', owner: '技術部', creator: '張志明', createdAt: '2024-12-20', description: '智慧製造導入評估', fields: [], responses: [] },
            { id: 'survey-011', name: 'AI 應用調查', status: '進行中', owner: '研發部', creator: '張志明', createdAt: '2025-01-10', description: 'AI 技術應用現況', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-010',
              date: '2024-12-18T13:00:00',
              type: '技術輔導',
              status: '中期',
              title: 'AI 視覺檢測系統導入',
              content: '協助評估 AI 視覺檢測系統導入可行性，建議從 PCB 板檢測開始試點。',
              consultant: '張志明'
            },
            {
              id: 'guidance-011',
              date: '2025-01-15T10:30:00',
              type: '追蹤輔導',
              status: '結案',
              title: 'AI 系統試運行檢討',
              content: '檢討 AI 視覺檢測系統試運行成果，準確率達 98.5%，建議擴大應用範圍。',
              consultant: '張志明'
            }
          ]
        },
        {
          id: 'company-009',
          name: '宜蘭農產加工社',
          taxId: '90123456',
          city: '宜蘭縣',
          district: '員山鄉',
          address: '員山路三段66號',
          contactPerson: '陳阿發',
          contactPhone: '03-9225-123',
          contactEmail: '',
          fax: '',
          website: '',
          capital: '200萬',
          industry: '製造業',
          employeeRange: '5人以下',
          digitalStage: '尚未開始',
          joinedAt: '2025-10-12T15:30:00',
          createdAt: '2025-10-12T15:30:00',
          surveys: [],
          guidanceRecords: [
            {
              id: 'guidance-014',
              date: '2025-10-13T14:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '農產加工業數位化諮詢',
              content: '評估小型農產加工業數位化需求，建議從基礎電腦化開始，包含簡易記帳、產品標籤列印等。',
              consultant: '陳美玲'
            }
          ]
        },
        {
          id: 'company-010',
          name: '彰化金融服務公司',
          taxId: '01234567',
          city: '彰化縣',
          district: '彰化市',
          address: '中山路一段150號6樓',
          contactPerson: '蔡宗憲',
          contactPhone: '04-7285-111',
          contactEmail: 'service@chfinance.com.tw',
          fax: '04-7285-112',
          website: 'https://www.chfinance.com.tw',
          capital: '5000萬',
          industry: '金融及保險業',
          employeeRange: '51-100人',
          digitalStage: '持續優化階段',
          joinedAt: '2024-08-20T09:15:00',
          createdAt: '2024-08-20T09:15:00',
          surveys: [
            { id: 'survey-012', name: '金融科技應用調查', status: '進行中', owner: '金融組', creator: '張志明', createdAt: '2024-09-01', description: 'FinTech 應用評估', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-015',
              date: '2024-08-25T10:00:00',
              type: '技術輔導',
              status: '中期',
              title: 'FinTech 系統整合建議',
              content: '協助評估金融科技解決方案，包含行動支付、線上開戶、數位簽章等功能整合。',
              consultant: '張志明'
            },
            {
              id: 'guidance-016',
              date: '2024-11-10T14:30:00',
              type: '追蹤輔導',
              status: '結案',
              title: '數位金融服務成效檢討',
              content: '檢討數位金融服務導入成效，客戶滿意度提升 30%，建議持續擴充服務項目。',
              consultant: '張志明'
            }
          ]
        },
        {
          id: 'company-011',
          name: '雲林食品加工廠',
          taxId: '11223344',
          city: '雲林縣',
          district: '斗六市',
          address: '工業路88號',
          contactPerson: '張麗華',
          contactPhone: '05-5325-789',
          contactEmail: 'yunlin.food@yahoo.com.tw',
          fax: '05-5325-788',
          website: '',
          capital: '1500萬',
          industry: '製造業',
          employeeRange: '21-50人',
          digitalStage: '初步導入階段',
          joinedAt: '2025-10-08T14:20:00',
          createdAt: '2025-10-08T14:20:00',
          surveys: [
            { id: 'survey-013', name: '食安追溯系統調查', status: '進行中', owner: '品管部', creator: '陳美玲', createdAt: '2025-10-09', description: '食品安全追溯系統需求', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-012',
              date: '2025-10-09T11:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '食品安全追溯系統規劃',
              content: '評估食品安全追溯系統需求，建議採用區塊鏈技術確保資料不可篡改性，從原料進貨到成品出貨全程追蹤。',
              consultant: '陳美玲'
            }
          ]
        },
        {
          id: 'company-012',
          name: '嘉義觀光旅遊社',
          taxId: '22334455',
          city: '嘉義市',
          district: '東區',
          address: '中山路288號3樓',
          contactPerson: '林文欽',
          contactPhone: '05-2245-888',
          contactEmail: 'cytravel@hotmail.com',
          fax: '05-2245-889',
          website: '',
          capital: '300萬',
          industry: '住宿及餐飲業',
          employeeRange: '6-20人',
          digitalStage: '尚未開始',
          joinedAt: '2025-09-30T11:00:00',
          createdAt: '2025-09-30T11:00:00',
          surveys: [],
          guidanceRecords: [
            {
              id: 'guidance-017',
              date: '2025-10-02T11:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '旅遊業數位行銷需求評估',
              content: '了解旅遊社營運現況，主要需求為線上訂房系統、社群媒體行銷、客戶管理系統。建議先從官網優化開始。',
              consultant: '李小華'
            },
            {
              id: 'guidance-018',
              date: '2025-10-08T15:00:00',
              type: '技術輔導',
              status: '中期',
              title: '官網改版與 SEO 優化',
              content: '協助規劃官網改版方案，包含響應式設計、線上詢價功能、SEO 關鍵字優化。',
              consultant: '李小華'
            }
          ]
        },
        {
          id: 'company-013',
          name: '屏東農業科技公司',
          taxId: '33445566',
          city: '屏東縣',
          district: '屏東市',
          address: '和平路166號',
          contactPerson: '王俊傑',
          contactPhone: '08-7335-666',
          contactEmail: 'pt.agritech@company.com',
          fax: '08-7335-667',
          website: 'https://www.pt-agritech.com',
          capital: '2500萬',
          industry: '農、林、漁、牧業',
          employeeRange: '21-50人',
          digitalStage: '初步導入階段',
          joinedAt: '2023-05-10T10:30:00',
          createdAt: '2023-05-10T10:30:00',
          surveys: [
            { id: 'survey-014', name: '智慧農業調查', status: '進行中', owner: '農技組', creator: '王大明', createdAt: '2023-06-01', description: '智慧農業技術導入評估', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-019',
              date: '2023-05-15T09:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '智慧農業技術導入評估',
              content: '評估農業科技公司數位轉型需求，討論智慧溫室、自動灌溉系統、農產品溯源等技術應用。',
              consultant: '王大明'
            },
            {
              id: 'guidance-020',
              date: '2023-07-20T10:30:00',
              type: '技術輔導',
              status: '中期',
              title: 'IoT 感測器系統建置',
              content: '協助建置 IoT 感測器系統，監控溫度、濕度、土壤狀況等環境參數，提供即時數據分析。',
              consultant: '王大明'
            },
            {
              id: 'guidance-021',
              date: '2024-01-10T14:00:00',
              type: '追蹤輔導',
              status: '結案',
              title: '智慧農業系統成效評估',
              content: '系統運行半年後成效顯著，作物產量提升 20%，水資源節省 35%。建議擴大應用範圍。',
              consultant: '王大明'
            }
          ]
        },
        {
          id: 'company-014',
          name: '花蓮觀光飯店',
          taxId: '44556677',
          city: '花蓮縣',
          district: '花蓮市',
          address: '中華路555號',
          contactPerson: '陳淑芬',
          contactPhone: '03-8225-999',
          contactEmail: 'hlhotel@service.com.tw',
          fax: '03-8225-998',
          website: 'https://www.hlhotel.com.tw',
          capital: '6000萬',
          industry: '住宿及餐飲業',
          employeeRange: '51-100人',
          digitalStage: '持續優化階段',
          joinedAt: '2024-03-15T09:00:00',
          createdAt: '2024-03-15T09:00:00',
          surveys: [
            { id: 'survey-015', name: '飯店數位化服務調查', status: '進行中', owner: '服務部', creator: '李小華', createdAt: '2024-04-01', description: '飯店數位化服務現況', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-022',
              date: '2024-03-20T11:00:00',
              type: '初次訪談',
              status: '初訪',
              title: '飯店數位化服務升級規劃',
              content: '評估飯店數位化服務現況，討論智慧客房、行動入住、數位禮賓服務等升級方案。',
              consultant: '李小華'
            },
            {
              id: 'guidance-023',
              date: '2024-05-15T14:00:00',
              type: '技術輔導',
              status: '中期',
              title: '智慧客房系統導入',
              content: '協助導入智慧客房控制系統，包含語音助理、智慧燈光、溫度控制等功能，提升住客體驗。',
              consultant: '李小華'
            }
          ]
        },
        {
          id: 'company-015',
          name: '台東綠能科技',
          taxId: '55667788',
          city: '台東縣',
          district: '台東市',
          address: '更生路777號',
          contactPerson: '曾志豪',
          contactPhone: '089-325-123',
          contactEmail: 'tt.green@energy.com',
          fax: '089-325-124',
          website: 'https://www.ttgreen.com.tw',
          capital: '4000萬',
          industry: '電力及燃氣供應業',
          employeeRange: '21-50人',
          digitalStage: '成熟運用階段',
          joinedAt: '2023-11-20T14:00:00',
          createdAt: '2023-11-20T14:00:00',
          surveys: [
            { id: 'survey-016', name: '綠能監控系統調查', status: '進行中', owner: '技術部', creator: '張志明', createdAt: '2023-12-01', description: '綠能監控系統評估', fields: [], responses: [] }
          ],
          guidanceRecords: [
            {
              id: 'guidance-024',
              date: '2023-11-25T10:00:00',
              type: '技術輔導',
              status: '中期',
              title: '綠能監控平台優化',
              content: '協助優化太陽能發電監控平台，增加即時發電效率分析、異常警報、遠端控制等功能。',
              consultant: '張志明'
            },
            {
              id: 'guidance-025',
              date: '2024-03-10T15:00:00',
              type: '追蹤輔導',
              status: '結案',
              title: 'AI 預測維護系統導入',
              content: '導入 AI 預測維護系統，透過機器學習預測設備故障，降低維護成本 25%，提升系統可用率。',
              consultant: '張志明'
            }
          ]
        },
        // 無統編的公司（用於批量匯入配對）
        {
          id: 'company-notin-001',
          name: '小確幸咖啡館',
          taxId: '',
          city: '台北市',
          district: '大安區',
          address: '和平東路三段88號1樓',
          contactPerson: '林小美',
          contactPhone: '02-2366-5566',
          contactEmail: 'cafe@example.com',
          fax: '',
          website: '',
          capital: '50萬',
          industry: '住宿及餐飲業',
          employeeRange: '5人以下',
          digitalStage: '尚未開始',
          joinedAt: '2025-10-20T10:00:00',
          createdAt: '2025-10-20T10:00:00',
          surveys: [],
          guidanceRecords: []
        },
        {
          id: 'company-notin-002',
          name: '巷口小吃店',
          taxId: '',
          city: '新北市',
          district: '三重區',
          address: '重新路四段168號',
          contactPerson: '陳大哥',
          contactPhone: '02-2985-7788',
          contactEmail: '',
          fax: '',
          website: '',
          capital: '30萬',
          industry: '住宿及餐飲業',
          employeeRange: '5人以下',
          digitalStage: '尚未開始',
          joinedAt: '2025-10-22T14:30:00',
          createdAt: '2025-10-22T14:30:00',
          surveys: [],
          guidanceRecords: []
        },
        {
          id: 'company-notin-003',
          name: '美美服飾店',
          taxId: '',
          city: '桃園市',
          district: '中壢區',
          address: '中央西路299號',
          contactPerson: '張美美',
          contactPhone: '03-4567-890',
          contactEmail: 'fashion@gmail.com',
          fax: '',
          website: '',
          capital: '80萬',
          industry: '批發及零售業',
          employeeRange: '6-20人',
          digitalStage: '初步導入階段',
          joinedAt: '2025-10-18T16:00:00',
          createdAt: '2025-10-18T16:00:00',
          surveys: [],
          guidanceRecords: []
        }
      ];
    }

    // 載入公司資料（優先使用寫死的資料）
    function loadCompanies() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // 使用寫死的資料
        console.log('正在載入寫死的公司資料...');
        if (typeof HARDCODED_COMPANIES_DATA !== 'undefined' && HARDCODED_COMPANIES_DATA.length > 0) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(HARDCODED_COMPANIES_DATA));
          return HARDCODED_COMPANIES_DATA;
        }
        // 如果沒有寫死資料，使用示範資料
        const defaultData = getDefaultCompanies();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
        return defaultData;
      }
      try {
        let companies = JSON.parse(raw);
        
        // 如果資料是空的，使用寫死的資料
        if (!Array.isArray(companies) || companies.length === 0) {
          console.log('資料為空，正在載入寫死的公司資料...');
          if (typeof HARDCODED_COMPANIES_DATA !== 'undefined' && HARDCODED_COMPANIES_DATA.length > 0) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(HARDCODED_COMPANIES_DATA));
            return HARDCODED_COMPANIES_DATA;
          }
          const defaultData = getDefaultCompanies();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
          return defaultData;
        }
        
        return companies;
      } catch (e) {
        console.error('載入資料失敗，正在載入寫死的公司資料...', e);
        if (typeof HARDCODED_COMPANIES_DATA !== 'undefined' && HARDCODED_COMPANIES_DATA.length > 0) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(HARDCODED_COMPANIES_DATA));
          return HARDCODED_COMPANIES_DATA;
        }
        const defaultData = getDefaultCompanies();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
        return defaultData;
      }
    }

    // 確保無統編的公司存在
    function ensureNoTaxIdCompanies(companies) {
      const noTaxIdCompanies = [
        {
          id: 'company-notin-001',
          name: '小確幸咖啡館',
          taxId: '',
          city: '台北市',
          district: '大安區',
          address: '和平東路三段88號1樓',
          contactPerson: '林小美',
          contactPhone: '02-2366-5566',
          contactEmail: 'cafe@example.com',
          fax: '',
          website: '',
          capital: '50萬',
          industry: '住宿及餐飲業',
          employeeRange: '5人以下',
          digitalStage: '尚未開始',
          joinedAt: '2025-10-20T10:00:00',
          createdAt: '2025-10-20T10:00:00',
          surveys: [],
          guidanceRecords: []
        },
        {
          id: 'company-notin-002',
          name: '巷口小吃店',
          taxId: '',
          city: '新北市',
          district: '三重區',
          address: '重新路四段168號',
          contactPerson: '陳大哥',
          contactPhone: '02-2985-7788',
          contactEmail: '',
          fax: '',
          website: '',
          capital: '30萬',
          industry: '住宿及餐飲業',
          employeeRange: '5人以下',
          digitalStage: '尚未開始',
          joinedAt: '2025-10-22T14:30:00',
          createdAt: '2025-10-22T14:30:00',
          surveys: [],
          guidanceRecords: []
        },
        {
          id: 'company-notin-003',
          name: '美美服飾店',
          taxId: '',
          city: '桃園市',
          district: '中壢區',
          address: '中央西路299號',
          contactPerson: '張美美',
          contactPhone: '03-4567-890',
          contactEmail: 'fashion@gmail.com',
          fax: '',
          website: '',
          capital: '80萬',
          industry: '批發及零售業',
          employeeRange: '6-20人',
          digitalStage: '初步導入階段',
          joinedAt: '2025-10-18T16:00:00',
          createdAt: '2025-10-18T16:00:00',
          surveys: [],
          guidanceRecords: []
        }
      ];

      let hasChanges = false;

      // 檢查每個無統編公司是否存在，不存在則添加
      noTaxIdCompanies.forEach(noTaxIdCompany => {
        const exists = companies.some(c => c.id === noTaxIdCompany.id);
        if (!exists) {
          companies.push(noTaxIdCompany);
          hasChanges = true;
          console.log(`已自動添加無統編公司：${noTaxIdCompany.name}`);
        }
      });

      // 如果有變更，儲存回 localStorage
      if (hasChanges) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(companies));
      }

      return companies;
    }

    // 初始化篩選選項
    function initFilters() {
      allCompanies = loadCompanies();
      const citySelect = document.getElementById('cityFilter');
      const industrySelect = document.getElementById('industryFilter');
      const districtSelect = document.getElementById('districtFilter');

      if (citySelect) {
        citySelect.innerHTML = '<option value="">全部</option>';
      }
      if (industrySelect) {
        industrySelect.innerHTML = '<option value="">全部</option>';
      }
      if (districtSelect) {
        districtSelect.innerHTML = '<option value="">全部</option>';
      }
      
      // 縣市選項
      const cities = [...new Set(allCompanies.map(c => c.city).filter(Boolean))].sort();
      if (citySelect) {
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
      
      // 產業別選項
      const industries = [...new Set(allCompanies.map(c => c.industry).filter(Boolean))].sort();
      if (industrySelect) {
        industries.forEach(industry => {
          const option = document.createElement('option');
          option.value = industry;
          option.textContent = industry;
          industrySelect.appendChild(option);
        });
      }

      // 地區選項
      const districts = [...new Set(allCompanies.map(c => c.district).filter(Boolean))].sort();
      if (districtSelect) {
        districts.forEach(district => {
          const option = document.createElement('option');
          option.value = district;
          option.textContent = district;
          districtSelect.appendChild(option);
        });
      }
    }

    // 篩選公司
    function filterCompanies() {
      const keyword = document.getElementById('keyword').value.trim().toLowerCase();
      const cityFilter = document.getElementById('cityFilter').value;
      const industryFilter = document.getElementById('industryFilter').value;
      const stageFilter = document.getElementById('stageFilter').value;
      const contactFilter = document.getElementById('contactFilter') ? document.getElementById('contactFilter').value.trim().toLowerCase() : '';
      const districtFilter = document.getElementById('districtFilter') ? document.getElementById('districtFilter').value : '';

      const filtered = allCompanies.filter(company => {
        const name = (company.name || '').toLowerCase();
        const taxId = company.taxId || '';
        const contactPerson = (company.contactPerson || '').toLowerCase();
        const district = company.district || '';

        const matchKeyword = !keyword ||
          name.includes(keyword) ||
          taxId.includes(keyword) ||
          contactPerson.includes(keyword) ||
          district.toLowerCase().includes(keyword);

        const matchCity = !cityFilter || company.city === cityFilter;
        const matchIndustry = !industryFilter || company.industry === industryFilter;
        const matchStage = !stageFilter || company.digitalStage === stageFilter;
        const matchContact = !contactFilter || contactPerson.includes(contactFilter);
        const matchDistrict = !districtFilter || district === districtFilter;
        
        return matchKeyword && matchCity && matchIndustry && matchStage && matchContact && matchDistrict;
      });

      renderCompanies(filtered);
    }

    // 渲染公司列表
    function renderCompanies(companies) {
      const tbody = document.getElementById('companiesTableBody');
      const countSpan = document.getElementById('companyCount');
      
      countSpan.textContent = companies.length;

      if (companies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-muted">找不到符合條件的公司</td></tr>';
        return;
      }

      let html = '';
      companies.forEach((company, index) => {
        const surveyCount = (company.surveys || []).length;
        const stageColor = getStageColor(company.digitalStage);

        html += `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td><strong>${escapeHtml(company.name || '未命名')}</strong></td>
            <td>${escapeHtml(company.taxId || '-')}</td>
            <td>${escapeHtml(company.city || '-')}</td>
            <td>${escapeHtml(company.industry || '-')}</td>
            <td>${escapeHtml(company.contactPerson || '-')}</td>
            <td>${escapeHtml(company.employeeRange || '-')}</td>
            <td><span class="badge ${stageColor}">${escapeHtml(company.digitalStage || '未評估')}</span></td>
            <td><span class="badge bg-info">${surveyCount}</span></td>
            <td>${formatDate(company.joinedAt || company.createdAt)}</td>
            <td style="white-space: nowrap;">
              <a href="a03-company-detail.html?id=${company.id}" class="btn btn-sm btn-outline-primary me-1" title="查看">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">visibility</span>
              </a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCompany('${company.id}', '${escapeHtml(company.name)}')" title="刪除">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
              </button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // 取得階段顏色
    function getStageColor(stage) {
      switch(stage) {
        case '尚未開始': return 'bg-secondary';
        case '初步導入階段': return 'bg-primary';
        case '持續優化階段': return 'bg-success';
        case '成熟運用階段': return 'bg-warning';
        default: return 'bg-light text-dark';
      }
    }

    // 格式化日期
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      } catch (e) {
        return dateStr;
      }
    }

    // 跳脫 HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let companyModal = null;

    // 新增公司
    function addCompany() {
      // 清空表單
      document.getElementById('modalCompanyName').value = '';
      document.getElementById('modalTaxId').value = '';
      document.getElementById('modalCity').value = '';
      document.getElementById('modalDistrict').value = '';
      document.getElementById('modalAddress').value = '';
      document.getElementById('modalContactPerson').value = '';
      document.getElementById('modalContactPhone').value = '';
      document.getElementById('modalContactEmail').value = '';
      document.getElementById('modalFax').value = '';
      document.getElementById('modalWebsite').value = '';
      document.getElementById('modalCapital').value = '';
      document.getElementById('modalIndustry').value = '';
      document.getElementById('modalEmployeeRange').value = '';
      document.getElementById('modalDigitalStage').value = '';
      
      // 顯示 Modal
      if (!companyModal) {
        companyModal = new bootstrap.Modal(document.getElementById('companyModal'));
      }
      companyModal.show();
    }

    // 儲存公司
    function saveCompany() {
      // 取得表單資料
      const name = document.getElementById('modalCompanyName').value.trim();
      const taxId = document.getElementById('modalTaxId').value.trim();
      const city = document.getElementById('modalCity').value;
      const district = document.getElementById('modalDistrict').value.trim();
      const address = document.getElementById('modalAddress').value.trim();
      const contactPerson = document.getElementById('modalContactPerson').value.trim();
      const contactPhone = document.getElementById('modalContactPhone').value.trim();
      const contactEmail = document.getElementById('modalContactEmail').value.trim();
      const fax = document.getElementById('modalFax').value.trim();
      const website = document.getElementById('modalWebsite').value.trim();
      const capital = document.getElementById('modalCapital').value.trim();
      const industry = document.getElementById('modalIndustry').value;
      const employeeRange = document.getElementById('modalEmployeeRange').value;
      const digitalStage = document.getElementById('modalDigitalStage').value;

      // 驗證必填欄位
      if (!name) {
        alert('請輸入公司名稱');
        return;
      }
      
      // 載入現有公司資料
      const raw = localStorage.getItem(STORAGE_KEY);
      let companies = [];
      if (raw) {
        try {
          companies = JSON.parse(raw);
        } catch (e) {
          companies = [];
        }
      }
      
      // 統編驗證（非必填，但如果填寫則需驗證格式和重複性）
      if (taxId) {
        // 如果有填寫統編，驗證格式
        if (taxId.length !== 8 || !/^\d{8}$/.test(taxId)) {
          alert('統一編號格式錯誤，必須為8位數字');
          return;
        }
        
        // 檢查統編是否重複
        if (companies.some(c => c.taxId === taxId)) {
          alert('此統一編號已存在');
          return;
        }
      } else {
        // 如果沒有填寫統編，給予提醒
        if (!confirm('⚠️ 您未填寫統一編號\n\n這將導致：\n• 無法透過統編自動配對批量匯入的問卷資料\n• 需要使用手動配對功能\n\n適用對象：個人工作室、小攤販、無統編企業\n\n確定要繼續新增嗎？')) {
          return;
        }
      }
      
      if (!city) {
        alert('請選擇縣市');
        return;
      }
      if (!contactPerson) {
        alert('請輸入聯絡人姓名');
        return;
      }
      if (!contactPhone) {
        alert('請輸入聯絡電話');
        return;
      }
      if (!industry) {
        alert('請選擇產業別');
        return;
      }

      // 建立新公司資料
      const newCompany = {
        id: `company-${Date.now()}`,
        name: name,
        taxId: taxId,
        city: city,
        district: district,
        address: address,
        contactPerson: contactPerson,
        contactPhone: contactPhone,
        contactEmail: contactEmail,
        fax: fax,
        website: website,
        capital: capital,
        industry: industry,
        employeeRange: employeeRange || '',
        digitalStage: digitalStage || '',
        joinedAt: new Date().toISOString(),
        createdAt: new Date().toISOString(),
        surveys: [],
        guidanceRecords: []
      };

      // 儲存到 localStorage
      companies.push(newCompany);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(companies));

      // 關閉 Modal
      if (companyModal) {
        companyModal.hide();
      }

      // 重新載入列表
      allCompanies = companies;
      initFilters();
      filterCompanies();

      alert('公司已新增成功');
    }

    // 匯出公司清單
    function exportCompanyList() {
      if (typeof XLSX === 'undefined') {
        alert('載入 Excel 工具失敗，請重新整理頁面後再試。');
        return;
      }

      if (allCompanies.length === 0) {
        alert('目前沒有公司資料可以匯出');
        return;
      }

      // 建立標題列
      const headers = [
        '#', '公司名稱', '統一編號', '縣市', '鄉鎮市區', '地址', 
        '聯絡人', '聯絡電話', 'Email', '傳真', '公司網址', 
        '資本額', '產業別', '員工規模', '數位化階段', '問卷數', '輔導紀錄數', '加入時間'
      ];

      // 建立資料列
      const data = allCompanies.map((company, index) => {
        return [
          index + 1,
          company.name || '',
          company.taxId || '',
          company.city || '',
          company.district || '',
          company.address || '',
          company.contactPerson || '',
          company.contactPhone || '',
          company.contactEmail || '',
          company.fax || '',
          company.website || '',
          company.capital || '',
          company.industry || '',
          company.employeeRange || '',
          company.digitalStage || '',
          (company.surveys || []).length,
          (company.guidanceRecords || []).length,
          formatDate(company.joinedAt || company.createdAt)
        ];
      });

      // 建立工作表
      const wsData = [headers, ...data];
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // 設定欄位寬度
      const colWidths = [
        { wch: 5 },  // #
        { wch: 30 }, // 公司名稱
        { wch: 12 }, // 統編
        { wch: 10 }, // 縣市
        { wch: 12 }, // 鄉鎮市區
        { wch: 35 }, // 地址
        { wch: 12 }, // 聯絡人
        { wch: 15 }, // 電話
        { wch: 25 }, // Email
        { wch: 15 }, // 傳真
        { wch: 30 }, // 網址
        { wch: 12 }, // 資本額
        { wch: 20 }, // 產業別
        { wch: 12 }, // 員工規模
        { wch: 15 }, // 數位化階段
        { wch: 8 },  // 問卷數
        { wch: 12 }, // 輔導紀錄數
        { wch: 15 }  // 加入時間
      ];
      ws['!cols'] = colWidths;

      // 建立工作簿
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '公司清單');

      // 下載檔案
      const fileName = `公司清單_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      alert(`已匯出 ${allCompanies.length} 家公司資料`);
    }

    // 匯出統計摘要
    function exportStatisticsSummary() {
      if (typeof XLSX === 'undefined') {
        alert('載入 Excel 工具失敗，請重新整理頁面後再試。');
        return;
      }

      if (allCompanies.length === 0) {
        alert('目前沒有公司資料可以匯出');
        return;
      }

      const wb = XLSX.utils.book_new();

      // 1. 總覽統計
      const overviewData = [
        ['統計項目', '數量'],
        ['總公司數', allCompanies.length],
        ['啟用中公司', allCompanies.filter(c => c.digitalStage !== '尚未開始').length],
        ['總問卷數', allCompanies.reduce((sum, c) => sum + (c.surveys || []).length, 0)],
        ['總輔導紀錄數', allCompanies.reduce((sum, c) => sum + (c.guidanceRecords || []).length, 0)]
      ];
      const wsOverview = XLSX.utils.aoa_to_sheet(overviewData);
      wsOverview['!cols'] = [{ wch: 20 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, wsOverview, '總覽');

      // 2. 縣市分布
      const cityCount = {};
      allCompanies.forEach(c => {
        const city = c.city || '未填寫';
        cityCount[city] = (cityCount[city] || 0) + 1;
      });
      const cityData = [['縣市', '公司數', '佔比']];
      Object.entries(cityCount)
        .sort((a, b) => b[1] - a[1])
        .forEach(([city, count]) => {
          cityData.push([city, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        });
      const wsCity = XLSX.utils.aoa_to_sheet(cityData);
      wsCity['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsCity, '縣市分布');

      // 3. 產業別分布
      const industryCount = {};
      allCompanies.forEach(c => {
        const industry = c.industry || '未填寫';
        industryCount[industry] = (industryCount[industry] || 0) + 1;
      });
      const industryData = [['產業別', '公司數', '佔比']];
      Object.entries(industryCount)
        .sort((a, b) => b[1] - a[1])
        .forEach(([industry, count]) => {
          industryData.push([industry, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        });
      const wsIndustry = XLSX.utils.aoa_to_sheet(industryData);
      wsIndustry['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsIndustry, '產業別分布');

      // 4. 員工規模分布
      const employeeCount = {};
      allCompanies.forEach(c => {
        const range = c.employeeRange || '未填寫';
        employeeCount[range] = (employeeCount[range] || 0) + 1;
      });
      const employeeData = [['員工規模', '公司數', '佔比']];
      const employeeOrder = ['5人以下', '6-20人', '21-50人', '51-100人', '101-200人', '201人以上', '未填寫'];
      employeeOrder.forEach(range => {
        const count = employeeCount[range] || 0;
        if (count > 0) {
          employeeData.push([range, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        }
      });
      const wsEmployee = XLSX.utils.aoa_to_sheet(employeeData);
      wsEmployee['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsEmployee, '員工規模分布');

      // 5. 數位化階段分布
      const stageCount = {};
      allCompanies.forEach(c => {
        const stage = c.digitalStage || '未評估';
        stageCount[stage] = (stageCount[stage] || 0) + 1;
      });
      const stageData = [['數位化階段', '公司數', '佔比']];
      const stageOrder = ['尚未開始', '初步導入階段', '持續優化階段', '成熟運用階段', '未評估'];
      stageOrder.forEach(stage => {
        const count = stageCount[stage] || 0;
        if (count > 0) {
          stageData.push([stage, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        }
      });
      const wsStage = XLSX.utils.aoa_to_sheet(stageData);
      wsStage['!cols'] = [{ wch: 18 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsStage, '數位化階段分布');

      // 下載檔案
      const fileName = `統計摘要_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      alert('統計摘要已匯出');
    }

    // 刪除公司
    function deleteCompany(companyId, companyName) {
      // 先載入公司資料檢查關聯
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      
      let companies = [];
      try {
        companies = JSON.parse(raw);
      } catch (e) {
        alert('讀取資料失敗');
        return;
      }
      
      const company = companies.find(c => c.id === companyId);
      if (!company) {
        alert('找不到該公司');
        return;
      }
      
      // 檢查是否有問卷或輔導紀錄
      const surveyCount = (company.surveys || []).length;
      const guidanceCount = (company.guidanceRecords || []).length;
      
      let confirmMsg = `確定要刪除公司「${companyName}」嗎？`;
      
      if (surveyCount > 0 || guidanceCount > 0) {
        confirmMsg += `\n\n此公司有以下相關資料，將一併刪除：`;
        if (surveyCount > 0) {
          confirmMsg += `\n• ${surveyCount} 份問卷`;
        }
        if (guidanceCount > 0) {
          confirmMsg += `\n• ${guidanceCount} 筆輔導紀錄`;
        }
        confirmMsg += `\n\n此操作無法復原，確定要繼續嗎？`;
      } else {
        confirmMsg += `\n\n此操作無法復原，確定要繼續嗎？`;
      }
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      // 執行刪除
      companies = companies.filter(c => c.id !== companyId);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(companies));
      
      // 重新載入列表
      allCompanies = companies;
      initFilters();
      filterCompanies();
      
      alert('公司已刪除');
    }

    // ==================== 圖表相關函數 ====================
    let industryDonutChart = null;

    // 縣市名稱對照 SVG ID
    const CITY_TO_SVG_ID = {
      '台北市': 'TWTPE', '臺北市': 'TWTPE',
      '新北市': 'TWNWT',
      '基隆市': 'TWKEE',
      '桃園市': 'TWTAO',
      '新竹市': 'TWHSZ',
      '新竹縣': 'TWHSQ',
      '苗栗縣': 'TWMIA',
      '台中市': 'TWTXG', '臺中市': 'TWTXG',
      '彰化縣': 'TWCHA',
      '南投縣': 'TWNAN',
      '雲林縣': 'TWYUN',
      '嘉義市': 'TWCYI',
      '嘉義縣': 'TWCYQ',
      '台南市': 'TWTNN', '臺南市': 'TWTNN',
      '高雄市': 'TWKHH',
      '屏東縣': 'TWPIF',
      '宜蘭縣': 'TWILA',
      '花蓮縣': 'TWHUA',
      '台東縣': 'TWTTT', '臺東縣': 'TWTTT',
      '澎湖縣': 'TWPEN',
      '金門縣': 'TWKIN',
      '連江縣': 'TWLIE'
    };

    // SVG ID 對照縣市名稱
    const SVG_ID_TO_CITY = {};
    Object.entries(CITY_TO_SVG_ID).forEach(([city, id]) => {
      if (!SVG_ID_TO_CITY[id]) SVG_ID_TO_CITY[id] = city;
    });

    // 取得熱度地圖顏色
    function getHeatmapColor(count) {
      if (count >= 500) return '#e53935'; // 紅色
      if (count >= 300) return '#fb8c00'; // 橙色
      if (count >= 100) return '#fdd835'; // 黃色
      return '#43a047'; // 綠色
    }

    // 初始化統計圖表
    function initCompanyCharts() {
      const companies = allCompanies;
      const totalCompanies = companies.length;

      // 統計縣市分布
      const cityCount = {};
      companies.forEach(c => {
        const city = c.city || '未填寫';
        cityCount[city] = (cityCount[city] || 0) + 1;
      });

      // 統計產業分布
      const industryCount = {};
      companies.forEach(c => {
        const industry = c.industry || '未填寫';
        industryCount[industry] = (industryCount[industry] || 0) + 1;
      });

      // 更新統計卡片
      document.getElementById('statTotalCompanies').textContent = totalCompanies;
      document.getElementById('statTotalCities').textContent = Object.keys(cityCount).filter(k => k !== '未填寫').length;
      document.getElementById('statTotalIndustries').textContent = Object.keys(industryCount).filter(k => k !== '未填寫').length;

      // 更新台灣地圖顏色
      updateTaiwanMap(cityCount);

      // 更新縣市分布表格
      updateCityDistributionTable(cityCount, totalCompanies);

      // 更新產業分布環狀圖
      updateIndustryDonutChart(industryCount, totalCompanies);

      // 更新產業分布表格
      updateIndustryDistributionTable(industryCount, totalCompanies);
    }

    // 地圖縮放相關變數
    let currentMapZoom = 0.8;
    const MIN_ZOOM = 0.8;
    const MAX_ZOOM = 3;
    const BASE_WIDTH = 100; // 基準寬度百分比

    // 縮放地圖
    function zoomMap(factor) {
      const newZoom = currentMapZoom * factor;
      // 允許稍微有誤差的比較
      if (newZoom >= MIN_ZOOM - 0.01 && newZoom <= MAX_ZOOM + 0.01) {
        currentMapZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom));
        applyMapZoom();
      }
    }

    // 套用地圖縮放
    function applyMapZoom() {
      const mapSvg = document.getElementById('taiwanMap');
      const wrapper = document.getElementById('mapSvgWrapper');
      
      if (mapSvg && wrapper) {
        // 使用 width 變化實現縮放（CSS transition 會處理動畫 0.35s）
        const newWidth = BASE_WIDTH * currentMapZoom;
        mapSvg.style.width = newWidth + '%';
        mapSvg.style.minWidth = (newWidth * 5) + 'px';
        
        // 調整地圖垂直位置（稍微往上移動以避免被圖例遮擋）
        // 當縮放比例較小時往上移，放大時恢復置中
        if (currentMapZoom <= 1) {
          mapSvg.style.transform = 'translateY(-20px)';
        } else {
          mapSvg.style.transform = 'translateY(0)';
        }

        // 控制滾動條與拖曳功能
        if (currentMapZoom <= MIN_ZOOM + 0.01) {
          wrapper.style.overflow = 'hidden';
          wrapper.classList.remove('can-drag');
          wrapper.scrollLeft = 0;
          wrapper.scrollTop = 0;
        } else {
          wrapper.style.overflow = 'auto';
          wrapper.classList.add('can-drag');
        }
      }
    }

    // 重置地圖縮放
    function resetMapZoom() {
      currentMapZoom = MIN_ZOOM;
      applyMapZoom();
    }

    // 初始化地圖拖曳功能
    function initMapDrag() {
      const wrapper = document.getElementById('mapSvgWrapper');
      if (!wrapper) return;
      
      let isDragging = false;
      let startX, startY, scrollLeft, scrollTop;
      
      wrapper.addEventListener('mousedown', (e) => {
        // 只有在允許拖曳且使用滑鼠左鍵時啟用
        if (!wrapper.classList.contains('can-drag') || e.button !== 0) return;
        
        isDragging = true;
        wrapper.classList.add('dragging');
        startX = e.pageX - wrapper.offsetLeft;
        startY = e.pageY - wrapper.offsetTop;
        scrollLeft = wrapper.scrollLeft;
        scrollTop = wrapper.scrollTop;
      });
      
      wrapper.addEventListener('mouseleave', () => {
        isDragging = false;
        wrapper.classList.remove('dragging');
      });
      
      wrapper.addEventListener('mouseup', () => {
        isDragging = false;
        wrapper.classList.remove('dragging');
      });
      
      wrapper.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - wrapper.offsetLeft;
        const y = e.pageY - wrapper.offsetTop;
        const walkX = (x - startX) * 1.5; // 拖曳速度倍數
        const walkY = (y - startY) * 1.5;
        wrapper.scrollLeft = scrollLeft - walkX;
        wrapper.scrollTop = scrollTop - walkY;
      });
    }

    // 更新台灣地圖
    function updateTaiwanMap(cityCount) {
      const mapSvg = document.getElementById('taiwanMap');
      if (!mapSvg) return;

      const featuresGroup = mapSvg.getElementById('features');
      if (!featuresGroup) return;

      const paths = featuresGroup.querySelectorAll('path');
      
      paths.forEach(path => {
        const svgId = path.getAttribute('id');
        const cityName = path.getAttribute('data-name') || SVG_ID_TO_CITY[svgId] || '';
        
        // 計算此縣市的公司數（需考慮台/臺的差異）
        let count = 0;
        Object.entries(cityCount).forEach(([city, cnt]) => {
          const normalizedCity = city.replace(/臺/g, '台');
          const normalizedCityName = cityName ? cityName.replace(/臺/g, '台') : '';
          if (normalizedCity === normalizedCityName || CITY_TO_SVG_ID[city] === svgId) {
            count += cnt;
          }
        });
        
        const color = getHeatmapColor(count);
        
        // 將資料存到 dataset 以便事件處理器使用
        path.dataset.cityName = cityName;
        path.dataset.count = count;
        
        path.style.fill = color;
        path.style.stroke = '#ffffff';
        path.style.strokeWidth = '0.5';
        path.style.cursor = 'pointer';
        path.style.transition = 'all 0.3s ease';

        // 添加互動事件
        path.onmouseenter = function() {
          const name = this.dataset.cityName || this.getAttribute('data-name') || SVG_ID_TO_CITY[this.id] || '未知地區';
          const cnt = this.dataset.count || 0;
          // 讓其他區域變暗
          const allPaths = mapSvg.querySelectorAll('path');
          allPaths.forEach(p => {
            if (p !== this) {
              p.style.filter = 'brightness(0.7)';
            }
          });
          // 高亮當前區域
          this.style.strokeWidth = '2.5';
          this.style.stroke = '#ffffff';
          this.style.filter = 'brightness(1.05) drop-shadow(0 2px 6px rgba(0,0,0,0.3))';
          showMapTooltip(this, name, cnt);
        };
        path.onmouseleave = function() {
          // 恢復所有區域
          const allPaths = mapSvg.querySelectorAll('path');
          allPaths.forEach(p => {
            p.style.filter = 'none';
            p.style.strokeWidth = '0.5';
            p.style.stroke = '#ffffff';
          });
          hideMapTooltip();
        };
        path.onclick = function() {
          const name = this.dataset.cityName || this.getAttribute('data-name');
          if (name) {
            document.getElementById('list-tab').click();
            // 嘗試匹配篩選器中的值
            const cityFilter = document.getElementById('cityFilter');
            const options = Array.from(cityFilter.options);
            const matchOption = options.find(opt => {
              const optVal = opt.value.replace(/臺/g, '台');
              const targetCity = name.replace(/臺/g, '台');
              return optVal === targetCity || optVal.includes(targetCity) || targetCity.includes(optVal);
            });
            if (matchOption) {
              cityFilter.value = matchOption.value;
            }
            filterCompanies();
          }
        };
      });

      // 同步表格高度
      syncTableHeight();
    }

    // 顯示地圖提示
    function showMapTooltip(element, city, count) {
      let tooltip = document.getElementById('mapTooltip');
      if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'mapTooltip';
        tooltip.style.cssText = 'position: fixed; background: rgba(33,33,33,0.95); color: white; padding: 10px 14px; border-radius: 6px; font-size: 14px; pointer-events: none; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
        document.body.appendChild(tooltip);
      }
      const displayCity = city || '未知地區';
      const displayCount = count || 0;
      tooltip.innerHTML = `<div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${displayCity}</div><div><span style="color: #fdd835; font-size: 20px; font-weight: bold;">${displayCount}</span> <span style="color: #e0e0e0;">家公司</span></div>`;
      tooltip.style.display = 'block';

      // 使用 window 的 mousemove 事件來追蹤滑鼠位置
      window.currentTooltipHandler = positionTooltip;
      window.addEventListener('mousemove', positionTooltip);
    }

    function positionTooltip(e) {
      const tooltip = document.getElementById('mapTooltip');
      if (tooltip && tooltip.style.display !== 'none') {
        // 確保提示框不會超出視窗
        const tooltipRect = tooltip.getBoundingClientRect();
        let left = e.clientX + 15;
        let top = e.clientY + 15;
        
        if (left + tooltipRect.width > window.innerWidth) {
          left = e.clientX - tooltipRect.width - 15;
        }
        if (top + tooltipRect.height > window.innerHeight) {
          top = e.clientY - tooltipRect.height - 15;
        }
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
      }
    }

    function hideMapTooltip() {
      const tooltip = document.getElementById('mapTooltip');
      if (tooltip) {
        tooltip.style.display = 'none';
      }
      if (window.currentTooltipHandler) {
        window.removeEventListener('mousemove', window.currentTooltipHandler);
        window.currentTooltipHandler = null;
      }
    }

    // 同步表格高度與地圖容器
    function syncTableHeight() {
      setTimeout(() => {
        const mapContainer = document.getElementById('taiwanMapContainer');
        const tableContainer = document.getElementById('cityTableContainer');
        if (mapContainer && tableContainer) {
          const mapHeight = mapContainer.offsetHeight;
          tableContainer.style.maxHeight = mapHeight + 'px';
          tableContainer.style.height = mapHeight + 'px';
        }
      }, 100);
    }

    // 更新縣市分布表格
    function updateCityDistributionTable(cityCount, total) {
      const tbody = document.getElementById('cityDistributionTable');
      if (!tbody) return;

      const sortedCities = Object.entries(cityCount)
        .sort((a, b) => b[1] - a[1]);

      const maxCount = sortedCities.length > 0 ? sortedCities[0][1] : 1;

      let html = '';
      sortedCities.forEach(([city, count]) => {
        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        const barWidth = (count / maxCount) * 100;
        const color = getHeatmapColor(count);

        html += `
          <tr style="cursor: pointer;" onclick="document.getElementById('list-tab').click(); document.getElementById('cityFilter').value='${city}'; filterCompanies();">
            <td>${escapeHtml(city)}</td>
            <td class="text-end">${count}</td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="progress flex-grow-1" style="height: 8px;">
                  <div class="progress-bar" style="width: ${barWidth}%; background-color: ${color};"></div>
                </div>
                <small class="text-muted" style="width: 40px;">${percentage}%</small>
              </div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html || '<tr><td colspan="3" class="text-center text-muted">暫無資料</td></tr>';
    }

    // 更新產業分布環狀圖
    function updateIndustryDonutChart(industryCount, total) {
      const ctx = document.getElementById('industryDonutChart');
      if (!ctx) return;

      const sortedIndustries = Object.entries(industryCount)
        .sort((a, b) => b[1] - a[1]);

      const labels = sortedIndustries.map(([name]) => name);
      const data = sortedIndustries.map(([, count]) => count);

      const colors = [
        '#4472C4', '#ED7D31', '#A5A5A5', '#FFC000', '#5B9BD5',
        '#70AD47', '#264478', '#9E480E', '#636363', '#997300',
        '#255E91', '#43682B', '#7030A0', '#C00000', '#00B050'
      ];

      if (industryDonutChart) {
        industryDonutChart.destroy();
      }

      industryDonutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, data.length),
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '55%',
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 12,
                padding: 10,
                font: { size: 11 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                  return `${context.label}: ${context.parsed} 家 (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // 更新產業分布表格
    function updateIndustryDistributionTable(industryCount, total) {
      const tbody = document.getElementById('industryDistributionTable');
      if (!tbody) return;

      const sortedIndustries = Object.entries(industryCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);

      let html = '';
      sortedIndustries.forEach(([industry, count]) => {
        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        html += `
          <tr style="cursor: pointer;" onclick="document.getElementById('list-tab').click(); document.getElementById('industryFilter').value='${industry}'; filterCompanies();">
            <td>${escapeHtml(industry)}</td>
            <td class="text-end">${count}</td>
            <td class="text-end">${percentage}%</td>
          </tr>
        `;
      });

      tbody.innerHTML = html || '<tr><td colspan="3" class="text-center text-muted">暫無資料</td></tr>';
    }

    // 初始化
    window.addEventListener('load', function() {
      initFilters();
      filterCompanies();
      initCompanyCharts();
      initMapDrag();
      applyMapZoom(); // 套用預設縮放
      syncTableHeight();
    });

    // 窗口大小改變時重新同步高度
    window.addEventListener('resize', function() {
      syncTableHeight();
    });
  </script>
</body>
</html>
