<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>所有公司 - 商業服務業數位應用資料庫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="../assets/css/custom.css" rel="stylesheet">
</head>
<body>
  <div id="topbar"></div>

  <div class="d-flex" style="height: calc(100vh - 64px);">
    <div id="sidebar"></div>

    <main class="flex-fill p-4" style="background-color: var(--color-bg-gray); overflow-y: auto; height: 100%;">
      <div class="container-fluid">
        <!-- 標題 -->
        <div class="d-flex align-items-center gap-2 mb-4">
          <span class="material-icons" style="font-size: 28px; color: var(--color-primary);">business</span>
          <h4 class="mb-0">所有公司</h4>
        </div>

        <!-- 搜尋與篩選 -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">搜尋</label>
                <input type="search" class="form-control" id="keyword" placeholder="輸入公司名稱 / 統一編號" oninput="filterCompanies()">
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">縣市</label>
                <select class="form-select" id="cityFilter" onchange="filterCompanies()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">產業別</label>
                <select class="form-select" id="industryFilter" onchange="filterCompanies()">
                  <option value="">全部</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">數位化階段</label>
                <select class="form-select" id="stageFilter" onchange="filterCompanies()">
                  <option value="">全部</option>
                  <option value="尚未開始">尚未開始</option>
                  <option value="初步導入階段">初步導入階段</option>
                  <option value="持續優化階段">持續優化階段</option>
                  <option value="成熟運用階段">成熟運用階段</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- 公司列表 -->
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">公司列表（<span id="companyCount">0</span> 家）</h5>
            <div>
              <div class="btn-group me-2">
                <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">download</span>
                  匯出報表
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="exportCompanyList(); return false;">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">list_alt</span>
                    公司清單
                  </a></li>
                  <li><a class="dropdown-item" href="#" onclick="exportStatisticsSummary(); return false;">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">assessment</span>
                    統計摘要
                  </a></li>
                </ul>
              </div>
            <button class="btn btn-primary btn-sm" onclick="addCompany()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</span>
              新增公司
            </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead style="background-color: #fafafa;">
                  <tr>
                    <th style="width: 50px;">#</th>
                    <th>公司名稱</th>
                    <th>統一編號</th>
                    <th>縣市</th>
                    <th>產業別</th>
                    <th>員工規模</th>
                    <th>數位化階段</th>
                    <th>問卷數</th>
                    <th>加入時間</th>
                    <th style="width: 120px; white-space: nowrap;">操作</th>
                  </tr>
                </thead>
                <tbody id="companiesTableBody">
                  <tr>
                    <td colspan="10" class="text-center py-4 text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 新增公司 Modal -->
  <div class="modal fade" id="companyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增公司</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">公司名稱 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="modalCompanyName" placeholder="請輸入公司名稱">
            </div>
            <div class="col-md-6">
              <label class="form-label">統一編號 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="modalTaxId" placeholder="請輸入8位統一編號" maxlength="8">
            </div>
            <div class="col-md-4">
              <label class="form-label">縣市 <span class="text-danger">*</span></label>
              <select class="form-select" id="modalCity">
                <option value="">請選擇縣市</option>
                <option value="台北市">台北市</option>
                <option value="新北市">新北市</option>
                <option value="桃園市">桃園市</option>
                <option value="台中市">台中市</option>
                <option value="台南市">台南市</option>
                <option value="高雄市">高雄市</option>
                <option value="基隆市">基隆市</option>
                <option value="新竹市">新竹市</option>
                <option value="嘉義市">嘉義市</option>
                <option value="新竹縣">新竹縣</option>
                <option value="苗栗縣">苗栗縣</option>
                <option value="彰化縣">彰化縣</option>
                <option value="南投縣">南投縣</option>
                <option value="雲林縣">雲林縣</option>
                <option value="嘉義縣">嘉義縣</option>
                <option value="屏東縣">屏東縣</option>
                <option value="宜蘭縣">宜蘭縣</option>
                <option value="花蓮縣">花蓮縣</option>
                <option value="台東縣">台東縣</option>
                <option value="澎湖縣">澎湖縣</option>
                <option value="金門縣">金門縣</option>
                <option value="連江縣">連江縣</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">鄉鎮市區</label>
              <input type="text" class="form-control" id="modalDistrict" placeholder="請輸入鄉鎮市區">
            </div>
            <div class="col-md-4">
              <label class="form-label">資本額</label>
              <input type="text" class="form-control" id="modalCapital" placeholder="例：1000萬">
            </div>
            <div class="col-12">
              <label class="form-label">地址</label>
              <input type="text" class="form-control" id="modalAddress" placeholder="請輸入詳細地址">
            </div>
            <div class="col-md-4">
              <label class="form-label">聯絡人姓名 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="modalContactPerson" placeholder="請輸入聯絡人姓名">
            </div>
            <div class="col-md-4">
              <label class="form-label">聯絡電話 <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="modalContactPhone" placeholder="例：02-1234-5678">
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="modalContactEmail" placeholder="example@company.com">
            </div>
            <div class="col-md-4">
              <label class="form-label">傳真</label>
              <input type="tel" class="form-control" id="modalFax" placeholder="例：02-1234-5679">
            </div>
            <div class="col-md-4">
              <label class="form-label">公司網址</label>
              <input type="url" class="form-control" id="modalWebsite" placeholder="https://www.company.com">
            </div>
            <div class="col-md-4">
              <label class="form-label">產業別 <span class="text-danger">*</span></label>
              <select class="form-select" id="modalIndustry">
                <option value="">請選擇產業別</option>
                <option value="製造業">製造業</option>
                <option value="批發及零售業">批發及零售業</option>
                <option value="住宿及餐飲業">住宿及餐飲業</option>
                <option value="資訊及通訊傳播業">資訊及通訊傳播業</option>
                <option value="專業、科學及技術服務業">專業、科學及技術服務業</option>
                <option value="運輸及倉儲業">運輸及倉儲業</option>
                <option value="金融及保險業">金融及保險業</option>
                <option value="農、林、漁、牧業">農、林、漁、牧業</option>
                <option value="電力及燃氣供應業">電力及燃氣供應業</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">員工規模</label>
              <select class="form-select" id="modalEmployeeRange">
                <option value="">請選擇員工規模</option>
                <option value="5人以下">5人以下</option>
                <option value="6-20人">6-20人</option>
                <option value="21-50人">21-50人</option>
                <option value="51-100人">51-100人</option>
                <option value="101-200人">101-200人</option>
                <option value="201人以上">201人以上</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">數位化階段</label>
              <select class="form-select" id="modalDigitalStage">
                <option value="">請選擇數位化階段</option>
                <option value="尚未開始">尚未開始</option>
                <option value="初步導入階段">初步導入階段</option>
                <option value="持續優化階段">持續優化階段</option>
                <option value="成熟運用階段">成熟運用階段</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveCompany()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="../assets/js/layout.js"></script>
  <script>
    checkLogin();
    initLayout('companies');

    const STORAGE_KEY = 'companiesStore';
    let allCompanies = [];

    // 載入公司資料（如果沒有則從 dashboard 載入假資料）
    function loadCompanies() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // 嘗試觸發 dashboard 初始化，或者直接返回空陣列讓使用者先訪問 dashboard
        console.log('請先訪問儀表板頁面以初始化假資料');
        return [];
      }
      try {
        const companies = JSON.parse(raw);
        // 檢查公司資料是否有新欄位，如果沒有則可能需要更新
        if (companies.length > 0 && !companies[0].hasOwnProperty('contactPerson')) {
          console.warn('公司資料結構需要更新，請訪問儀表板頁面');
        }
        return companies;
      } catch (e) {
        return [];
      }
    }

    // 初始化篩選選項
    function initFilters() {
      allCompanies = loadCompanies();
      
      // 縣市選項
      const cities = [...new Set(allCompanies.map(c => c.city).filter(Boolean))].sort();
      const citySelect = document.getElementById('cityFilter');
      cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
      
      // 產業別選項
      const industries = [...new Set(allCompanies.map(c => c.industry).filter(Boolean))].sort();
      const industrySelect = document.getElementById('industryFilter');
      industries.forEach(industry => {
        const option = document.createElement('option');
        option.value = industry;
        option.textContent = industry;
        industrySelect.appendChild(option);
      });
    }

    // 篩選公司
    function filterCompanies() {
      const keyword = document.getElementById('keyword').value.toLowerCase();
      const cityFilter = document.getElementById('cityFilter').value;
      const industryFilter = document.getElementById('industryFilter').value;
      const stageFilter = document.getElementById('stageFilter').value;

      const filtered = allCompanies.filter(company => {
        const matchKeyword = !keyword || 
          (company.name && company.name.toLowerCase().includes(keyword)) ||
          (company.taxId && company.taxId.includes(keyword));
        const matchCity = !cityFilter || company.city === cityFilter;
        const matchIndustry = !industryFilter || company.industry === industryFilter;
        const matchStage = !stageFilter || company.digitalStage === stageFilter;
        
        return matchKeyword && matchCity && matchIndustry && matchStage;
      });

      renderCompanies(filtered);
    }

    // 渲染公司列表
    function renderCompanies(companies) {
      const tbody = document.getElementById('companiesTableBody');
      const countSpan = document.getElementById('companyCount');
      
      countSpan.textContent = companies.length;

      if (companies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-muted">找不到符合條件的公司</td></tr>';
        return;
      }

      let html = '';
      companies.forEach((company, index) => {
        const surveyCount = (company.surveys || []).length;
        const stageColor = getStageColor(company.digitalStage);
        
        html += `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td><strong>${escapeHtml(company.name || '未命名')}</strong></td>
            <td>${escapeHtml(company.taxId || '-')}</td>
            <td>${escapeHtml(company.city || '-')}</td>
            <td>${escapeHtml(company.industry || '-')}</td>
            <td>${escapeHtml(company.employeeRange || '-')}</td>
            <td><span class="badge ${stageColor}">${escapeHtml(company.digitalStage || '未評估')}</span></td>
            <td><span class="badge bg-info">${surveyCount}</span></td>
            <td>${formatDate(company.joinedAt || company.createdAt)}</td>
            <td style="white-space: nowrap;">
              <a href="a03-company-detail.html?id=${company.id}" class="btn btn-sm btn-outline-primary me-1" title="查看">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">visibility</span>
              </a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCompany('${company.id}', '${escapeHtml(company.name)}')" title="刪除">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
              </button>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // 取得階段顏色
    function getStageColor(stage) {
      switch(stage) {
        case '尚未開始': return 'bg-secondary';
        case '初步導入階段': return 'bg-primary';
        case '持續優化階段': return 'bg-success';
        case '成熟運用階段': return 'bg-warning';
        default: return 'bg-light text-dark';
      }
    }

    // 格式化日期
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      } catch (e) {
        return dateStr;
      }
    }

    // 跳脫 HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let companyModal = null;

    // 新增公司
    function addCompany() {
      // 清空表單
      document.getElementById('modalCompanyName').value = '';
      document.getElementById('modalTaxId').value = '';
      document.getElementById('modalCity').value = '';
      document.getElementById('modalDistrict').value = '';
      document.getElementById('modalAddress').value = '';
      document.getElementById('modalContactPerson').value = '';
      document.getElementById('modalContactPhone').value = '';
      document.getElementById('modalContactEmail').value = '';
      document.getElementById('modalFax').value = '';
      document.getElementById('modalWebsite').value = '';
      document.getElementById('modalCapital').value = '';
      document.getElementById('modalIndustry').value = '';
      document.getElementById('modalEmployeeRange').value = '';
      document.getElementById('modalDigitalStage').value = '';
      
      // 顯示 Modal
      if (!companyModal) {
        companyModal = new bootstrap.Modal(document.getElementById('companyModal'));
      }
      companyModal.show();
    }

    // 儲存公司
    function saveCompany() {
      // 取得表單資料
      const name = document.getElementById('modalCompanyName').value.trim();
      const taxId = document.getElementById('modalTaxId').value.trim();
      const city = document.getElementById('modalCity').value;
      const district = document.getElementById('modalDistrict').value.trim();
      const address = document.getElementById('modalAddress').value.trim();
      const contactPerson = document.getElementById('modalContactPerson').value.trim();
      const contactPhone = document.getElementById('modalContactPhone').value.trim();
      const contactEmail = document.getElementById('modalContactEmail').value.trim();
      const fax = document.getElementById('modalFax').value.trim();
      const website = document.getElementById('modalWebsite').value.trim();
      const capital = document.getElementById('modalCapital').value.trim();
      const industry = document.getElementById('modalIndustry').value;
      const employeeRange = document.getElementById('modalEmployeeRange').value;
      const digitalStage = document.getElementById('modalDigitalStage').value;

      // 驗證必填欄位
      if (!name) {
        alert('請輸入公司名稱');
        return;
      }
      if (!taxId) {
        alert('請輸入統一編號');
        return;
      }
      if (taxId.length !== 8 || !/^\d{8}$/.test(taxId)) {
        alert('統一編號必須為8位數字');
        return;
      }
      if (!city) {
        alert('請選擇縣市');
        return;
      }
      if (!contactPerson) {
        alert('請輸入聯絡人姓名');
        return;
      }
      if (!contactPhone) {
        alert('請輸入聯絡電話');
        return;
      }
      if (!industry) {
        alert('請選擇產業別');
        return;
      }

      // 檢查統編是否重複
      const raw = localStorage.getItem(STORAGE_KEY);
      let companies = [];
      if (raw) {
        try {
          companies = JSON.parse(raw);
        } catch (e) {
          companies = [];
        }
      }

      if (companies.some(c => c.taxId === taxId)) {
        alert('此統一編號已存在');
        return;
      }

      // 建立新公司資料
      const newCompany = {
        id: `company-${Date.now()}`,
        name: name,
        taxId: taxId,
        city: city,
        district: district,
        address: address,
        contactPerson: contactPerson,
        contactPhone: contactPhone,
        contactEmail: contactEmail,
        fax: fax,
        website: website,
        capital: capital,
        industry: industry,
        employeeRange: employeeRange || '',
        digitalStage: digitalStage || '',
        joinedAt: new Date().toISOString(),
        createdAt: new Date().toISOString(),
        surveys: [],
        guidanceRecords: []
      };

      // 儲存到 localStorage
      companies.push(newCompany);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(companies));

      // 關閉 Modal
      if (companyModal) {
        companyModal.hide();
      }

      // 重新載入列表
      allCompanies = companies;
      initFilters();
      filterCompanies();

      alert('公司已新增成功');
    }

    // 匯出公司清單
    function exportCompanyList() {
      if (typeof XLSX === 'undefined') {
        alert('載入 Excel 工具失敗，請重新整理頁面後再試。');
        return;
      }

      if (allCompanies.length === 0) {
        alert('目前沒有公司資料可以匯出');
        return;
      }

      // 建立標題列
      const headers = [
        '#', '公司名稱', '統一編號', '縣市', '鄉鎮市區', '地址', 
        '聯絡人', '聯絡電話', 'Email', '傳真', '公司網址', 
        '資本額', '產業別', '員工規模', '數位化階段', '問卷數', '輔導紀錄數', '加入時間'
      ];

      // 建立資料列
      const data = allCompanies.map((company, index) => {
        return [
          index + 1,
          company.name || '',
          company.taxId || '',
          company.city || '',
          company.district || '',
          company.address || '',
          company.contactPerson || '',
          company.contactPhone || '',
          company.contactEmail || '',
          company.fax || '',
          company.website || '',
          company.capital || '',
          company.industry || '',
          company.employeeRange || '',
          company.digitalStage || '',
          (company.surveys || []).length,
          (company.guidanceRecords || []).length,
          formatDate(company.joinedAt || company.createdAt)
        ];
      });

      // 建立工作表
      const wsData = [headers, ...data];
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // 設定欄位寬度
      const colWidths = [
        { wch: 5 },  // #
        { wch: 30 }, // 公司名稱
        { wch: 12 }, // 統編
        { wch: 10 }, // 縣市
        { wch: 12 }, // 鄉鎮市區
        { wch: 35 }, // 地址
        { wch: 12 }, // 聯絡人
        { wch: 15 }, // 電話
        { wch: 25 }, // Email
        { wch: 15 }, // 傳真
        { wch: 30 }, // 網址
        { wch: 12 }, // 資本額
        { wch: 20 }, // 產業別
        { wch: 12 }, // 員工規模
        { wch: 15 }, // 數位化階段
        { wch: 8 },  // 問卷數
        { wch: 12 }, // 輔導紀錄數
        { wch: 15 }  // 加入時間
      ];
      ws['!cols'] = colWidths;

      // 建立工作簿
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '公司清單');

      // 下載檔案
      const fileName = `公司清單_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      alert(`已匯出 ${allCompanies.length} 家公司資料`);
    }

    // 匯出統計摘要
    function exportStatisticsSummary() {
      if (typeof XLSX === 'undefined') {
        alert('載入 Excel 工具失敗，請重新整理頁面後再試。');
        return;
      }

      if (allCompanies.length === 0) {
        alert('目前沒有公司資料可以匯出');
        return;
      }

      const wb = XLSX.utils.book_new();

      // 1. 總覽統計
      const overviewData = [
        ['統計項目', '數量'],
        ['總公司數', allCompanies.length],
        ['啟用中公司', allCompanies.filter(c => c.digitalStage !== '尚未開始').length],
        ['總問卷數', allCompanies.reduce((sum, c) => sum + (c.surveys || []).length, 0)],
        ['總輔導紀錄數', allCompanies.reduce((sum, c) => sum + (c.guidanceRecords || []).length, 0)]
      ];
      const wsOverview = XLSX.utils.aoa_to_sheet(overviewData);
      wsOverview['!cols'] = [{ wch: 20 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, wsOverview, '總覽');

      // 2. 縣市分布
      const cityCount = {};
      allCompanies.forEach(c => {
        const city = c.city || '未填寫';
        cityCount[city] = (cityCount[city] || 0) + 1;
      });
      const cityData = [['縣市', '公司數', '佔比']];
      Object.entries(cityCount)
        .sort((a, b) => b[1] - a[1])
        .forEach(([city, count]) => {
          cityData.push([city, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        });
      const wsCity = XLSX.utils.aoa_to_sheet(cityData);
      wsCity['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsCity, '縣市分布');

      // 3. 產業別分布
      const industryCount = {};
      allCompanies.forEach(c => {
        const industry = c.industry || '未填寫';
        industryCount[industry] = (industryCount[industry] || 0) + 1;
      });
      const industryData = [['產業別', '公司數', '佔比']];
      Object.entries(industryCount)
        .sort((a, b) => b[1] - a[1])
        .forEach(([industry, count]) => {
          industryData.push([industry, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        });
      const wsIndustry = XLSX.utils.aoa_to_sheet(industryData);
      wsIndustry['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsIndustry, '產業別分布');

      // 4. 員工規模分布
      const employeeCount = {};
      allCompanies.forEach(c => {
        const range = c.employeeRange || '未填寫';
        employeeCount[range] = (employeeCount[range] || 0) + 1;
      });
      const employeeData = [['員工規模', '公司數', '佔比']];
      const employeeOrder = ['5人以下', '6-20人', '21-50人', '51-100人', '101-200人', '201人以上', '未填寫'];
      employeeOrder.forEach(range => {
        const count = employeeCount[range] || 0;
        if (count > 0) {
          employeeData.push([range, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        }
      });
      const wsEmployee = XLSX.utils.aoa_to_sheet(employeeData);
      wsEmployee['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsEmployee, '員工規模分布');

      // 5. 數位化階段分布
      const stageCount = {};
      allCompanies.forEach(c => {
        const stage = c.digitalStage || '未評估';
        stageCount[stage] = (stageCount[stage] || 0) + 1;
      });
      const stageData = [['數位化階段', '公司數', '佔比']];
      const stageOrder = ['尚未開始', '初步導入階段', '持續優化階段', '成熟運用階段', '未評估'];
      stageOrder.forEach(stage => {
        const count = stageCount[stage] || 0;
        if (count > 0) {
          stageData.push([stage, count, `${(count / allCompanies.length * 100).toFixed(1)}%`]);
        }
      });
      const wsStage = XLSX.utils.aoa_to_sheet(stageData);
      wsStage['!cols'] = [{ wch: 18 }, { wch: 10 }, { wch: 10 }];
      XLSX.utils.book_append_sheet(wb, wsStage, '數位化階段分布');

      // 下載檔案
      const fileName = `統計摘要_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      alert('統計摘要已匯出');
    }

    // 刪除公司
    function deleteCompany(companyId, companyName) {
      // 先載入公司資料檢查關聯
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      
      let companies = [];
      try {
        companies = JSON.parse(raw);
      } catch (e) {
        alert('讀取資料失敗');
        return;
      }
      
      const company = companies.find(c => c.id === companyId);
      if (!company) {
        alert('找不到該公司');
        return;
      }
      
      // 檢查是否有問卷或輔導紀錄
      const surveyCount = (company.surveys || []).length;
      const guidanceCount = (company.guidanceRecords || []).length;
      
      let confirmMsg = `確定要刪除公司「${companyName}」嗎？`;
      
      if (surveyCount > 0 || guidanceCount > 0) {
        confirmMsg += `\n\n此公司有以下相關資料，將一併刪除：`;
        if (surveyCount > 0) {
          confirmMsg += `\n• ${surveyCount} 份問卷`;
        }
        if (guidanceCount > 0) {
          confirmMsg += `\n• ${guidanceCount} 筆輔導紀錄`;
        }
        confirmMsg += `\n\n此操作無法復原，確定要繼續嗎？`;
      } else {
        confirmMsg += `\n\n此操作無法復原，確定要繼續嗎？`;
      }
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      // 執行刪除
      companies = companies.filter(c => c.id !== companyId);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(companies));
      
      // 重新載入列表
      allCompanies = companies;
      initFilters();
      filterCompanies();
      
      alert('公司已刪除');
    }

    // 初始化
    window.addEventListener('load', function() {
      initFilters();
      filterCompanies();
    });
  </script>
</body>
</html>

