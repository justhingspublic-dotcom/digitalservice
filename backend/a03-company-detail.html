<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>公司詳情 - 商業服務業數位應用資料庫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="../assets/css/custom.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="topbar"></div>

  <div class="d-flex" style="height: calc(100vh - 64px);">
    <div id="sidebar"></div>

    <main class="flex-fill p-4" style="background-color: var(--color-bg-gray); overflow-y: auto; height: 100%;">
      <div class="container-fluid">
        <!-- 返回按鈕 -->
        <div class="mb-3" id="backToCompaniesBtn">
          <a href="a02-companies.html" class="btn btn-outline-secondary btn-sm">
            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">arrow_back</span>
            返回公司列表
          </a>
        </div>

        <!-- 標題 -->
        <div class="d-flex align-items-center gap-2 mb-4" id="companyHeader">
          <span class="material-icons" style="font-size: 28px; color: var(--color-primary);">business</span>
          <h4 class="mb-0" id="companyTitle">公司詳情</h4>
        </div>

        <!-- 區塊 1：公司基本資料 -->
        <div class="card mb-4" id="companyInfoCard">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">公司基本資料</h5>
            <button class="btn btn-outline-primary btn-sm" onclick="editCompanyInfo()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">edit</span>
              編輯
            </button>
          </div>
          <div class="card-body">
            <div class="row g-4">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label small text-muted">公司名稱</label>
                  <div class="fw-bold" id="companyName">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">統一編號</label>
                  <div id="companyTaxId">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">所在縣市</label>
                  <div id="companyCity">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">鄉鎮市區</label>
                  <div id="companyDistrict">-</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label small text-muted">聯絡人姓名</label>
                  <div id="companyContactPerson">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">聯絡電話</label>
                  <div id="companyContactPhone">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">Email</label>
                  <div id="companyContactEmail">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">傳真</label>
                  <div id="companyFax">-</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label small text-muted">產業別</label>
                  <div id="companyIndustry">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">員工規模</label>
                  <div id="companyEmployeeRange">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">資本額</label>
                  <div id="companyCapital">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted">公司網址</label>
                  <div id="companyWebsite">-</div>
                </div>
              </div>
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label small text-muted">公司地址</label>
                  <div id="companyAddress">-</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label small text-muted">數位化階段</label>
                  <div id="companyDigitalStage">-</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label small text-muted">加入時間</label>
                  <div id="companyJoinedAt">-</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label small text-muted">問卷數量</label>
                  <div id="companySurveyCount">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 區塊 2：輔導紀錄 -->
        <div class="card mb-4" id="guidanceRecordsCard">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">輔導紀錄</h5>
            <div class="d-flex gap-2">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">download</span>
                  匯出
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="#" onclick="exportGuidanceRecords('excel'); return false;">
                    <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">table_chart</span>
                    匯出 Excel
                  </a></li>
                  <li><a class="dropdown-item" href="#" onclick="exportGuidanceRecords('csv'); return false;">
                    <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">description</span>
                    匯出 CSV
                  </a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-muted" href="#" onclick="alert('PDF 匯出功能開發中，敬請期待！'); return false;">
                    <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">picture_as_pdf</span>
                    匯出 PDF（開發中）
                  </a></li>
                </ul>
              </div>
            <button class="btn btn-primary btn-sm" onclick="addGuidanceRecord()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</span>
              新增紀錄
            </button>
            </div>
          </div>
          <div class="card-body">
            <div id="guidanceRecordsContainer">
              <div class="text-center py-4 text-muted">尚無輔導紀錄</div>
            </div>
          </div>
        </div>

        <!-- 區塊 3：問卷資料庫 -->
        <div id="surveySection">
          <!-- 動態內容區域 -->
        </div>
      </div>
    </main>
  </div>

  <!-- 編輯公司 Modal -->
  <div class="modal fade" id="editCompanyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">編輯公司資料</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">公司名稱 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editCompanyName" placeholder="請輸入公司名稱">
            </div>
            <div class="col-md-6">
              <label class="form-label">統一編號 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editTaxId" placeholder="請輸入8位統一編號" maxlength="8" disabled>
            </div>
            <div class="col-md-4">
              <label class="form-label">縣市 <span class="text-danger">*</span></label>
              <select class="form-select" id="editCity">
                <option value="">請選擇縣市</option>
                <option value="台北市">台北市</option>
                <option value="新北市">新北市</option>
                <option value="桃園市">桃園市</option>
                <option value="台中市">台中市</option>
                <option value="台南市">台南市</option>
                <option value="高雄市">高雄市</option>
                <option value="基隆市">基隆市</option>
                <option value="新竹市">新竹市</option>
                <option value="嘉義市">嘉義市</option>
                <option value="新竹縣">新竹縣</option>
                <option value="苗栗縣">苗栗縣</option>
                <option value="彰化縣">彰化縣</option>
                <option value="南投縣">南投縣</option>
                <option value="雲林縣">雲林縣</option>
                <option value="嘉義縣">嘉義縣</option>
                <option value="屏東縣">屏東縣</option>
                <option value="宜蘭縣">宜蘭縣</option>
                <option value="花蓮縣">花蓮縣</option>
                <option value="台東縣">台東縣</option>
                <option value="澎湖縣">澎湖縣</option>
                <option value="金門縣">金門縣</option>
                <option value="連江縣">連江縣</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">鄉鎮市區</label>
              <input type="text" class="form-control" id="editDistrict" placeholder="請輸入鄉鎮市區">
            </div>
            <div class="col-md-4">
              <label class="form-label">資本額</label>
              <input type="text" class="form-control" id="editCapital" placeholder="例：1000萬">
            </div>
            <div class="col-12">
              <label class="form-label">地址</label>
              <input type="text" class="form-control" id="editAddress" placeholder="請輸入詳細地址">
            </div>
            <div class="col-md-4">
              <label class="form-label">聯絡人姓名 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editContactPerson" placeholder="請輸入聯絡人姓名">
            </div>
            <div class="col-md-4">
              <label class="form-label">聯絡電話 <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="editContactPhone" placeholder="例：02-1234-5678">
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="editContactEmail" placeholder="example@company.com">
            </div>
            <div class="col-md-4">
              <label class="form-label">傳真</label>
              <input type="tel" class="form-control" id="editFax" placeholder="例：02-1234-5679">
            </div>
            <div class="col-md-4">
              <label class="form-label">公司網址</label>
              <input type="url" class="form-control" id="editWebsite" placeholder="https://www.company.com">
            </div>
            <div class="col-md-4">
              <label class="form-label">產業別 <span class="text-danger">*</span></label>
              <select class="form-select" id="editIndustry">
                <option value="">請選擇產業別</option>
                <option value="製造業">製造業</option>
                <option value="批發及零售業">批發及零售業</option>
                <option value="住宿及餐飲業">住宿及餐飲業</option>
                <option value="資訊及通訊傳播業">資訊及通訊傳播業</option>
                <option value="專業、科學及技術服務業">專業、科學及技術服務業</option>
                <option value="運輸及倉儲業">運輸及倉儲業</option>
                <option value="金融及保險業">金融及保險業</option>
                <option value="農、林、漁、牧業">農、林、漁、牧業</option>
                <option value="電力及燃氣供應業">電力及燃氣供應業</option>
                <option value="其他">其他</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">員工規模</label>
              <select class="form-select" id="editEmployeeRange">
                <option value="">請選擇員工規模</option>
                <option value="5人以下">5人以下</option>
                <option value="6-20人">6-20人</option>
                <option value="21-50人">21-50人</option>
                <option value="51-100人">51-100人</option>
                <option value="101-200人">101-200人</option>
                <option value="201人以上">201人以上</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">數位化階段</label>
              <select class="form-select" id="editDigitalStage">
                <option value="">請選擇數位化階段</option>
                <option value="尚未開始">尚未開始</option>
                <option value="初步導入階段">初步導入階段</option>
                <option value="持續優化階段">持續優化階段</option>
                <option value="成熟運用階段">成熟運用階段</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveEditCompany()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增問卷 Modal -->
  <div class="modal fade" id="createSurveyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增問卷</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createSurveyForm">
            <div class="mb-3">
              <label for="newSurveyName" class="form-label">問卷名稱 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="newSurveyName" 
                placeholder="例如：2025 Q3 數位轉型調查" required>
            </div>
            <div class="mb-3">
              <label for="newSurveyDescription" class="form-label">問卷說明</label>
              <textarea class="form-control" id="newSurveyDescription" rows="3"
                placeholder="請簡述此問卷的調查目的與範圍"></textarea>
            </div>
            <div class="mb-3">
              <label for="newSurveyOwner" class="form-label">負責單位</label>
              <input type="text" class="form-control" id="newSurveyOwner" 
                placeholder="例如：輔導組">
            </div>
            <div class="mb-3">
              <label for="newSurveyCreator" class="form-label">建立者 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="newSurveyCreator" 
                placeholder="請輸入您的姓名" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitCreateSurvey()">建立問卷</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 篩選 Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">篩選與欄位設定</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- 顯示欄位區塊 -->
          <div class="mb-4">
            <h6 class="fw-bold mb-3">顯示欄位</h6>
            <div id="fieldSelectionContainer" class="row g-2" style="max-height: 200px; overflow-y: auto;">
              <!-- 動態生成 checkbox -->
            </div>
          </div>
          
          <!-- 篩選條件區塊 -->
          <div>
            <h6 class="fw-bold mb-3">篩選條件</h6>
            <div id="filterConditionsContainer" style="max-height: 400px; overflow-y: auto;">
              <!-- 動態生成 Accordion -->
            </div>
            <p class="text-muted small mt-2 mb-0">
              <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
              同欄位內為 OR，不同欄位間為 AND
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">清除篩選</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="applyFilters()">套用</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/layout.js"></script>
  <script>
    checkLogin('companies');
    initLayout('companies');

    const STORAGE_KEY = 'companiesStore';
    let currentCompany = null;
    let companyId = null;
    let currentView = 'list'; // 'list', 'surveyDetail', or 'guidanceDetail'
    let currentSurvey = null;
    let currentGuidanceRecord = null;
    let currentGuidanceIndex = null;
    let surveyDetailKeyword = '';
    let surveyDetailPage = 1;
    const SURVEY_DETAIL_PAGE_SIZE = 10;
    
    // 篩選功能相關變數
    let visibleFields = [];  // 顯示的欄位 ID 陣列
    let filterConditions = {}; // 篩選條件 {fieldId: [選中的值陣列]}
    let activeFilterCount = 0; // 啟用的篩選條件數量
    let filterModalInstance = null;
    let fieldSearchKeywords = {}; // 每個欄位的搜尋關鍵字 {fieldId: keyword}

    // 從 URL 取得公司 ID
    function getCompanyIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // 載入公司資料
    function loadCompany() {
      companyId = getCompanyIdFromUrl();
      if (!companyId) {
        alert('找不到公司 ID');
        window.location.href = 'a02-companies.html';
        return;
      }

      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        alert('找不到公司資料');
        window.location.href = 'a02-companies.html';
        return;
      }

      try {
        const companies = JSON.parse(raw);
        currentCompany = companies.find(c => c.id === companyId);
        
        if (!currentCompany) {
          alert('找不到指定的公司');
          window.location.href = 'a02-companies.html';
          return;
        }

        renderCompanyInfo();
        renderGuidanceRecords();
        renderSurveyList();
      } catch (e) {
        alert('讀取資料失敗');
        window.location.href = 'a02-companies.html';
      }
    }

    // 渲染公司基本資料
    function renderCompanyInfo() {
      document.getElementById('companyTitle').textContent = currentCompany.name || '未命名公司';
      document.getElementById('companyName').textContent = currentCompany.name || '-';
      document.getElementById('companyTaxId').textContent = currentCompany.taxId || '-';
      document.getElementById('companyCity').textContent = currentCompany.city || '-';
      document.getElementById('companyDistrict').textContent = currentCompany.district || '-';
      document.getElementById('companyAddress').textContent = currentCompany.address || '-';
      document.getElementById('companyContactPerson').textContent = currentCompany.contactPerson || '-';
      document.getElementById('companyContactPhone').textContent = currentCompany.contactPhone || '-';
      document.getElementById('companyContactEmail').textContent = currentCompany.contactEmail || '-';
      document.getElementById('companyFax').textContent = currentCompany.fax || '-';
      
      // 網址處理
      if (currentCompany.website) {
        document.getElementById('companyWebsite').innerHTML = 
          `<a href="${escapeHtml(currentCompany.website)}" target="_blank" class="text-decoration-none">${escapeHtml(currentCompany.website)}</a>`;
      } else {
        document.getElementById('companyWebsite').textContent = '-';
      }
      
      document.getElementById('companyCapital').textContent = currentCompany.capital || '-';
      document.getElementById('companyIndustry').textContent = currentCompany.industry || '-';
      document.getElementById('companyEmployeeRange').textContent = currentCompany.employeeRange || '-';
      
      const stageColor = getStageColor(currentCompany.digitalStage);
      document.getElementById('companyDigitalStage').innerHTML = 
        `<span class="badge ${stageColor}">${currentCompany.digitalStage || '未評估'}</span>`;
      
      document.getElementById('companyJoinedAt').textContent = 
        formatDateTime(currentCompany.joinedAt || currentCompany.createdAt);
      
      const surveyCount = (currentCompany.surveys || []).length;
      document.getElementById('companySurveyCount').innerHTML = 
        `<span class="badge bg-info">${surveyCount}</span>`;
    }

    // 渲染輔導紀錄
    function renderGuidanceRecords() {
      const container = document.getElementById('guidanceRecordsContainer');
      const records = currentCompany.guidanceRecords || [];

      if (records.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">尚無輔導紀錄</div>';
        return;
      }

      let html = '<div class="timeline">';
      records.forEach((record, index) => {
        // 狀態徽章樣式
        const statusBadgeClass = {
          '初訪': 'bg-info',
          '中期': 'bg-warning',
          '結案': 'bg-success'
        };
        const statusClass = statusBadgeClass[record.status] || 'bg-secondary';

        html += `
          <div class="timeline-item mb-3 pb-3 ${index < records.length - 1 ? 'border-bottom' : ''}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <span class="badge bg-primary">${escapeHtml(record.type || '一般輔導')}</span>
                ${record.status ? `<span class="badge ${statusClass} ms-2">${escapeHtml(record.status)}</span>` : ''}
                <span class="text-muted small ms-2">${formatDate(record.date)}</span>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="viewGuidanceRecord(${index})">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">visibility</span>
                  檢視
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteGuidanceRecord(${index})">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">delete</span>
                  刪除
                </button>
              </div>
            </div>
            <h6 class="mb-2">${escapeHtml(record.title || '無標題')}</h6>
            <p class="mb-1 text-muted small">${escapeHtml(record.content || '無內容')}</p>
            ${record.suggestions ? `<p class="mb-1 text-muted small">建議：${escapeHtml(record.suggestions)}</p>` : ''}
            ${record.consultant ? `<div class="small text-muted">輔導顧問：${escapeHtml(record.consultant)}</div>` : ''}
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    // 渲染問卷列表
    function renderSurveyList() {
      currentView = 'list';
      
      // 顯示公司資料和輔導紀錄區塊
      document.getElementById('backToCompaniesBtn').style.display = 'block';
      document.getElementById('companyHeader').style.display = 'flex';
      document.getElementById('companyInfoCard').style.display = 'block';
      document.getElementById('guidanceRecordsCard').style.display = 'block';
      
      const container = document.getElementById('surveySection');
      const surveys = currentCompany.surveys || [];

      let html = `
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">問卷資料庫（${surveys.length} 份）</h5>
            <button class="btn btn-primary btn-sm" onclick="createSurvey()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</span>
              新增問卷
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead style="background-color: #fafafa;">
                  <tr>
                    <th style="width: 50px;">#</th>
                    <th>問卷名稱</th>
                    <th>狀態</th>
                    <th>負責單位</th>
                    <th>建立者</th>
                    <th>建立日期</th>
                    <th>欄位數</th>
                    <th>回覆數</th>
                    <th style="width: 200px;">操作</th>
                  </tr>
                </thead>
                <tbody>
      `;

      if (surveys.length === 0) {
        html += '<tr><td colspan="9" class="text-center py-4 text-muted">尚無問卷資料</td></tr>';
      } else {
        surveys.forEach((survey, index) => {
          const fieldCount = survey.fields?.length || 0;
          const responseCount = survey.responses?.length || 0;
          const statusClass = survey.status === '進行中' ? 'bg-primary' : 'bg-secondary';

          html += `
            <tr>
              <td class="text-center">${index + 1}</td>
              <td>
                <strong>${escapeHtml(survey.name || '未命名')}</strong><br>
                <small class="text-muted">${escapeHtml(survey.description || '')}</small>
              </td>
              <td><span class="badge ${statusClass}">${survey.status || '草稿'}</span></td>
              <td>${escapeHtml(survey.owner || '-')}</td>
              <td>${escapeHtml(survey.creator || '-')}</td>
              <td>${formatDate(survey.createdAt)}</td>
              <td>${fieldCount}</td>
              <td>${responseCount}</td>
              <td style="white-space: nowrap;">
                <button class="btn btn-sm btn-outline-primary me-2" onclick="viewSurvey('${survey.id}')">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">visibility</span>
                  查看
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSurvey(${index})">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">delete</span>
                  刪除
                </button>
              </td>
            </tr>
          `;
        });
      }

      html += `
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // 渲染問卷詳情
    function renderSurveyDetail() {
      currentView = 'detail';
      
      // 隱藏公司資料和輔導紀錄區塊，全屏顯示問卷
      document.getElementById('backToCompaniesBtn').style.display = 'none';
      document.getElementById('companyHeader').style.display = 'none';
      document.getElementById('companyInfoCard').style.display = 'none';
      document.getElementById('guidanceRecordsCard').style.display = 'none';
      
      const container = document.getElementById('surveySection');
      const survey = currentSurvey;
      const fields = survey.fields || [];
      const responses = survey.responses || [];
      
      // 第一次進入時，初始化為顯示所有欄位
      if (visibleFields.length === 0 && fields.length > 0) {
        visibleFields = fields.map(f => f.id);
      }

      let html = `
        <!-- 返回按鈕 -->
        <div class="mb-3">
          <button class="btn btn-outline-secondary btn-sm" onclick="backToSurveyList()">
            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">arrow_back</span>
            返回問卷列表
          </button>
        </div>

        <!-- 問卷標題 -->
        <div class="d-flex flex-wrap gap-3 align-items-center mb-4">
          <div class="flex-grow-1">
            <h1 class="h4 mb-1 fw-bold">${escapeHtml(survey.name || '未命名')}</h1>
            <p class="text-muted small mb-0">${escapeHtml(survey.description || '無說明')}</p>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge ${survey.status === '進行中' ? 'bg-primary' : 'bg-secondary'} fs-6">${survey.status || '草稿'}</span>
            <input type="file" id="importFile-${survey.id}" class="d-none" accept=".xlsx,.xls,.csv" onchange="handleImportFile(this)">
            <button class="btn btn-primary btn-sm" onclick="document.getElementById('importFile-${survey.id}').click()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">download</span>
              匯入
            </button>
            <div class="btn-group">
              <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">upload</span>
              匯出
            </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportData('excel'); return false;">
                  <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">table_chart</span>
                  匯出 Excel
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportData('csv'); return false;">
                  <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">description</span>
                  匯出 CSV
                </a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- 統計卡片 -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card h-100">
              <div class="card-body text-center d-flex flex-column justify-content-center" style="min-height: 100px;">
                <div class="text-muted small mb-1">負責單位</div>
                <div class="fw-bold">${escapeHtml(survey.owner || '未指派')}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100">
              <div class="card-body text-center d-flex flex-column justify-content-center" style="min-height: 100px;">
                <div class="text-muted small mb-1">建立者 / 建立日期</div>
                <div class="fw-bold">${escapeHtml(survey.creator || '-')}</div>
                <div class="text-muted small">${formatDate(survey.createdAt)}</div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card h-100">
              <div class="card-body text-center d-flex flex-column justify-content-center" style="min-height: 100px;">
                <div class="h5 mb-0 text-primary">${fields.length}</div>
                <div class="text-muted small">欄位數</div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card h-100">
              <div class="card-body text-center d-flex flex-column justify-content-center" style="min-height: 100px;">
                <div class="h5 mb-0 text-success">${responses.length}</div>
                <div class="text-muted small">回覆數</div>
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="card h-100">
              <div class="card-body text-center d-flex flex-column justify-content-center" style="min-height: 100px;">
                <div class="h5 mb-0 text-info">${(survey.importHistory || []).length}</div>
                <div class="text-muted small">匯入次數</div>
              </div>
            </div>
          </div>
              </div>
      `;

      // 匯入歷史記錄
      const importHistory = survey.importHistory || [];
      if (importHistory.length > 0) {
        const collapseId = `importHistory-${survey.id}`;
        html += `
        <div class="card mb-4">
          <div class="card-header bg-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 fw-bold">
                <span class="material-icons" style="font-size: 20px; vertical-align: middle; margin-right: 8px;">history</span>
                匯入歷史記錄（${importHistory.length} 次）
              </h6>
              <span class="material-icons" style="font-size: 20px; color: #666;">expand_more</span>
            </div>
          </div>
          <div class="collapse" id="${collapseId}">
            <div class="card-body p-0">
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                    <tr>
                      <th style="width: 50px;">#</th>
                      <th>檔案名稱</th>
                      <th>上傳者</th>
                      <th>上傳時間</th>
                      <th class="text-center">匯入筆數</th>
                      <th class="text-center">欄位數</th>
                      <th style="width: 100px;">操作</th>
                    </tr>
                  </thead>
                  <tbody>
        `;
        
        importHistory.forEach((record, index) => {
          html += `
                    <tr>
                      <td class="text-center">${index + 1}</td>
                      <td>
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; color: #4CAF50; margin-right: 4px;">insert_drive_file</span>
                        ${escapeHtml(record.fileName)}
                      </td>
                      <td>${escapeHtml(record.uploadedBy)}</td>
                      <td>${formatDateTime(record.uploadedAt)}</td>
                      <td class="text-center"><span class="badge bg-primary">${record.recordCount}</span></td>
                      <td class="text-center"><span class="badge bg-info">${record.fieldCount}</span></td>
                      <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteImportRecord('${record.id}')" title="刪除記錄">
                          <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                      </td>
                    </tr>
          `;
        });
        
        html += `
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
      }

      if (fields.length === 0) {
        html += `
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="mb-3">
              <span class="material-icons" style="font-size: 64px; color: var(--color-border);">description</span>
            </div>
            <h5>尚無問卷資料</h5>
            <p class="text-muted mb-3">此問卷尚未匯入任何欄位定義和回覆資料</p>
            <input type="file" id="importFileEmpty-${survey.id}" class="d-none" accept=".xlsx,.xls,.csv" onchange="handleImportFile(this)">
            <button class="btn btn-primary" onclick="document.getElementById('importFileEmpty-${survey.id}').click()">
              <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">download</span>
              立即匯入
            </button>
          </div>
        </div>
        `;
      } else {
        const filteredResponses = filterSurveyResponses(responses, fields);
        const totalPages = Math.max(1, Math.ceil(filteredResponses.length / SURVEY_DETAIL_PAGE_SIZE));
        surveyDetailPage = Math.min(surveyDetailPage, totalPages);
        const start = (surveyDetailPage - 1) * SURVEY_DETAIL_PAGE_SIZE;
        const pageData = filteredResponses.slice(start, start + SURVEY_DETAIL_PAGE_SIZE);

        html += `
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 fw-bold">問卷回覆 (${filteredResponses.length})</h6>
              <button class="btn btn-outline-primary btn-sm" onclick="openFilterModal()">
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">filter_list</span>
                篩選${activeFilterCount > 0 ? ` (${activeFilterCount})` : ''}
              </button>
            </div>
          </div>
          <div class="card-body p-0" style="overflow-x: auto; overflow-y: visible;">
              <table class="table table-bordered table-hover mb-0">
        `;

        if (pageData.length === 0) {
          html += `
                <tbody>
                  <tr>
                    <td colspan="100" class="text-center py-5 text-muted">
                      ${responses.length === 0 ? '尚無問卷回覆' : '找不到符合條件的資料'}
                    </td>
                  </tr>
                </tbody>
          `;
        } else {
          // 只顯示選中的欄位
          const displayFields = fields.filter(f => visibleFields.length === 0 || visibleFields.includes(f.id));
          
          html += `
                <thead class="table-light">
                  <tr>
                    <th class="text-center" style="min-width: 60px; white-space: nowrap;">#</th>
                    <th class="text-center" style="min-width: 120px; white-space: nowrap;">問卷編號</th>
                    <th class="text-center" style="min-width: 150px; white-space: nowrap;">提交時間</th>
          `;
          
          displayFields.forEach(field => {
            html += `<th style="min-width: 200px; white-space: nowrap;">${escapeHtml(field.label)}</th>`;
          });
          
          html += `
                  </tr>
                </thead>
                <tbody>
          `;

          pageData.forEach((response, index) => {
            html += `
                  <tr>
                    <td class="text-center" style="white-space: nowrap;">${start + index + 1}</td>
                    <td style="white-space: nowrap;">${escapeHtml(response.id)}</td>
                    <td style="white-space: nowrap;">${formatDateTime(response.submittedAt)}</td>
            `;

            displayFields.forEach(field => {
              const value = response.values[field.id];
              html += `<td style="min-width: 200px; max-width: 500px; word-wrap: break-word; white-space: normal;">${formatFieldValue(value, field)}</td>`;
            });
            
            html += `</tr>`;
          });

          html += `
                </tbody>
          `;
        }

        html += `
              </table>
          </div>
        `;

        if (totalPages > 1) {
          html += `
          <div class="card-footer bg-white">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">顯示第 ${start + 1} - ${start + pageData.length} 筆，共 ${filteredResponses.length} 筆</small>
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  ${buildSurveyDetailPagination(totalPages)}
                </ul>
              </nav>
            </div>
          </div>
          `;
        } else if (pageData.length > 0) {
          html += `
          <div class="card-footer bg-white">
            <small class="text-muted">共 ${filteredResponses.length} 筆</small>
          </div>
          `;
        }
        
        html += `</div>`;
      }

      container.innerHTML = html;
    }

    // 篩選問卷回覆
    function filterSurveyResponses(responses, fields) {
      // 沒有任何篩選條件，返回全部
      const activeFilters = Object.entries(filterConditions).filter(([fieldId, values]) => values && values.length > 0);
      
      if (activeFilters.length === 0) {
        return responses;
      }
      
      return responses.filter(response => {
        // 檢查所有欄位的篩選條件（不同欄位之間為 AND）
        return activeFilters.every(([fieldId, selectedValues]) => {
          const responseValue = response.values[fieldId];
          
          // 檢查是否符合該欄位的任一選項（同一欄位內為 OR）
          return selectedValues.some(selectedValue => {
            // 處理陣列值（多選）
            if (Array.isArray(responseValue)) {
              return responseValue.some(v => String(v) === String(selectedValue));
            }
            // 處理單一值
            return String(responseValue) === String(selectedValue);
          });
        });
      });
    }

    // 格式化欄位值
    function formatFieldValue(value, field) {
      if (field.type === 'multi') {
        const items = Array.isArray(value) ? value : parseMultiValue(value);
        if (!items.length) return '<span class="text-muted">－</span>';
        return items.map(item => `<span class="badge bg-light text-dark me-1 mb-1">${escapeHtml(item)}</span>`).join('');
      }
      if (field.type === 'datetime') {
        return formatDateTime(value);
      }
      if (!value) return '<span class="text-muted">－</span>';
      return escapeHtml(String(value)).replace(/\n/g, '<br>');
    }

    // 解析多選值
    function parseMultiValue(value) {
      if (Array.isArray(value)) return value;
      if (!value) return [];
      return String(value).split(/[\n,、，；;]/).map(s => s.trim()).filter(Boolean);
    }

    // 更新搜尋關鍵字
    function updateSurveyDetailKeyword(value) {
      surveyDetailKeyword = value;
      surveyDetailPage = 1;
      renderSurveyDetail();
    }

    // 切換頁碼
    function changeSurveyDetailPage(page) {
      surveyDetailPage = page;
      renderSurveyDetail();
    }

    // 建立分頁
    function buildSurveyDetailPagination(totalPages) {
      let html = '';
      
      html += `
        <li class="page-item ${surveyDetailPage === 1 ? 'disabled' : ''}">
          <button class="page-link" onclick="changeSurveyDetailPage(${surveyDetailPage - 1})" ${surveyDetailPage === 1 ? 'disabled' : ''}>‹</button>
        </li>
      `;
      
      for (let i = 1; i <= totalPages; i++) {
        if (totalPages <= 7 || i === 1 || i === totalPages || (i >= surveyDetailPage - 1 && i <= surveyDetailPage + 1)) {
          html += `
            <li class="page-item ${i === surveyDetailPage ? 'active' : ''}">
              <button class="page-link" onclick="changeSurveyDetailPage(${i})">${i}</button>
            </li>
          `;
        } else if (i === surveyDetailPage - 2 || i === surveyDetailPage + 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      
      html += `
        <li class="page-item ${surveyDetailPage === totalPages ? 'disabled' : ''}">
          <button class="page-link" onclick="changeSurveyDetailPage(${surveyDetailPage + 1})" ${surveyDetailPage === totalPages ? 'disabled' : ''}>›</button>
        </li>
      `;
      
      return html;
    }

    // 取得階段顏色
    function getStageColor(stage) {
      switch(stage) {
        case '尚未開始': return 'bg-secondary';
        case '初步導入階段': return 'bg-primary';
        case '持續優化階段': return 'bg-success';
        case '成熟運用階段': return 'bg-warning';
        default: return 'bg-light text-dark';
      }
    }

    // 格式化日期時間
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
      } catch (e) {
        return dateStr;
      }
    }

    // 格式化日期
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      } catch (e) {
        return dateStr;
      }
    }

    // 跳脫 HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let editCompanyModal = null;

    // 編輯公司資料
    function editCompanyInfo() {
      if (!currentCompany) return;

      // 填入現有資料
      document.getElementById('editCompanyName').value = currentCompany.name || '';
      document.getElementById('editTaxId').value = currentCompany.taxId || '';
      document.getElementById('editCity').value = currentCompany.city || '';
      document.getElementById('editDistrict').value = currentCompany.district || '';
      document.getElementById('editAddress').value = currentCompany.address || '';
      document.getElementById('editContactPerson').value = currentCompany.contactPerson || '';
      document.getElementById('editContactPhone').value = currentCompany.contactPhone || '';
      document.getElementById('editContactEmail').value = currentCompany.contactEmail || '';
      document.getElementById('editFax').value = currentCompany.fax || '';
      document.getElementById('editWebsite').value = currentCompany.website || '';
      document.getElementById('editCapital').value = currentCompany.capital || '';
      document.getElementById('editIndustry').value = currentCompany.industry || '';
      document.getElementById('editEmployeeRange').value = currentCompany.employeeRange || '';
      document.getElementById('editDigitalStage').value = currentCompany.digitalStage || '';

      // 顯示 Modal
      if (!editCompanyModal) {
        editCompanyModal = new bootstrap.Modal(document.getElementById('editCompanyModal'));
      }
      editCompanyModal.show();
    }

    // 儲存編輯的公司資料
    function saveEditCompany() {
      // 取得表單資料
      const name = document.getElementById('editCompanyName').value.trim();
      const city = document.getElementById('editCity').value;
      const district = document.getElementById('editDistrict').value.trim();
      const address = document.getElementById('editAddress').value.trim();
      const contactPerson = document.getElementById('editContactPerson').value.trim();
      const contactPhone = document.getElementById('editContactPhone').value.trim();
      const contactEmail = document.getElementById('editContactEmail').value.trim();
      const fax = document.getElementById('editFax').value.trim();
      const website = document.getElementById('editWebsite').value.trim();
      const capital = document.getElementById('editCapital').value.trim();
      const industry = document.getElementById('editIndustry').value;
      const employeeRange = document.getElementById('editEmployeeRange').value;
      const digitalStage = document.getElementById('editDigitalStage').value;

      // 驗證必填欄位
      if (!name) {
        alert('請輸入公司名稱');
        return;
      }
      if (!city) {
        alert('請選擇縣市');
        return;
      }
      if (!contactPerson) {
        alert('請輸入聯絡人姓名');
        return;
      }
      if (!contactPhone) {
        alert('請輸入聯絡電話');
        return;
      }
      if (!industry) {
        alert('請選擇產業別');
        return;
      }

      // 更新公司資料
      currentCompany.name = name;
      currentCompany.city = city;
      currentCompany.district = district;
      currentCompany.address = address;
      currentCompany.contactPerson = contactPerson;
      currentCompany.contactPhone = contactPhone;
      currentCompany.contactEmail = contactEmail;
      currentCompany.fax = fax;
      currentCompany.website = website;
      currentCompany.capital = capital;
      currentCompany.industry = industry;
      currentCompany.employeeRange = employeeRange;
      currentCompany.digitalStage = digitalStage;

      // 儲存到 localStorage
      saveCompany();

      // 關閉 Modal
      if (editCompanyModal) {
        editCompanyModal.hide();
      }

      // 重新渲染
      renderCompanyInfo();

      alert('公司資料已更新');
    }

    // 新增輔導紀錄
    function addGuidanceRecord() {
      // 建立模態框表單
      const modalHtml = `
        <div class="modal fade" id="addGuidanceModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">新增輔導紀錄</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">輔導類型</label>
                  <select class="form-select" id="guidanceType">
                    <option value="初次訪談">初次訪談</option>
                    <option value="技術輔導">技術輔導</option>
                    <option value="追蹤輔導">追蹤輔導</option>
                    <option value="一般輔導" selected>一般輔導</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">狀態</label>
                  <select class="form-select" id="guidanceStatus">
                    <option value="初訪" selected>初訪</option>
                    <option value="中期">中期</option>
                    <option value="結案">結案</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導主題</label>
                  <input type="text" class="form-control" id="guidanceTitle" placeholder="請輸入輔導主題">
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導內容</label>
                  <textarea class="form-control" id="guidanceContent" rows="4" placeholder="請輸入輔導內容"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">建議</label>
                  <textarea class="form-control" id="guidanceSuggestions" rows="3" placeholder="請輸入建議（選填）"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導顧問</label>
                  <input type="text" class="form-control" id="guidanceConsultant" placeholder="請輸入輔導顧問姓名">
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導日期</label>
                  <input type="datetime-local" class="form-control" id="guidanceDate" value="${new Date().toISOString().slice(0, 16)}">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveNewGuidanceRecord()">儲存</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // 移除舊的模態框（如果存在）
      const oldModal = document.getElementById('addGuidanceModal');
      if (oldModal) oldModal.remove();

      // 添加到 body
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // 顯示模態框
      const modal = new bootstrap.Modal(document.getElementById('addGuidanceModal'));
      modal.show();
    }

    function saveNewGuidanceRecord() {
      const type = document.getElementById('guidanceType').value;
      const status = document.getElementById('guidanceStatus').value;
      const title = document.getElementById('guidanceTitle').value.trim();
      const content = document.getElementById('guidanceContent').value.trim();
      const consultant = document.getElementById('guidanceConsultant').value.trim();
      const suggestions = document.getElementById('guidanceSuggestions').value.trim();
      const date = document.getElementById('guidanceDate').value;

      if (!title) {
        alert('請輸入輔導主題');
        return;
      }

      if (!content) {
        alert('請輸入輔導內容');
        return;
      }

      const newRecord = {
        id: `guidance-${Date.now()}`,
        date: new Date(date).toISOString(),
        type: type,
        status: status,
        title: title,
        content: content,
        consultant: consultant,
        suggestions: suggestions
      };

      if (!currentCompany.guidanceRecords) {
        currentCompany.guidanceRecords = [];
      }
      currentCompany.guidanceRecords.unshift(newRecord);

      // 儲存到 localStorage
      saveCompany();
      renderGuidanceRecords();

      // 關閉模態框
      const modal = bootstrap.Modal.getInstance(document.getElementById('addGuidanceModal'));
      modal.hide();
    }

    // 刪除輔導紀錄
    function deleteGuidanceRecord(index) {
      if (!confirm('確定要刪除這筆輔導紀錄嗎？')) return;
      
      currentCompany.guidanceRecords.splice(index, 1);
      saveCompany();
      renderGuidanceRecords();
    }

    // 查看問卷
    function viewSurvey(surveyId) {
      const surveys = currentCompany.surveys || [];
      currentSurvey = surveys.find(s => s.id === surveyId);
      
      if (!currentSurvey) {
        alert('找不到指定的問卷');
        return;
      }

      surveyDetailKeyword = '';
      surveyDetailPage = 1;
      renderSurveyDetail();
    }

    // 返回問卷列表
    function backToSurveyList() {
      currentSurvey = null;
      surveyDetailKeyword = '';
      surveyDetailPage = 1;
      // 重置篩選狀態
      visibleFields = [];
      filterConditions = {};
      activeFilterCount = 0;
      fieldSearchKeywords = {};
      renderSurveyList();
    }

    // 查看輔導紀錄詳情
    function viewGuidanceRecord(index) {
      const records = currentCompany.guidanceRecords || [];
      currentGuidanceRecord = records[index];
      currentGuidanceIndex = index;
      
      if (!currentGuidanceRecord) {
        alert('找不到指定的輔導紀錄');
        return;
      }

      renderGuidanceDetail();
    }

    // 返回輔導列表
    function backToGuidanceList() {
      currentGuidanceRecord = null;
      currentGuidanceIndex = null;
      renderSurveyList(); // 回到主列表（包含輔導紀錄）
    }

    // 渲染輔導詳情
    function renderGuidanceDetail() {
      currentView = 'guidanceDetail';
      
      // 隱藏公司資料和輔導紀錄區塊
      document.getElementById('backToCompaniesBtn').style.display = 'none';
      document.getElementById('companyHeader').style.display = 'none';
      document.getElementById('companyInfoCard').style.display = 'none';
      document.getElementById('guidanceRecordsCard').style.display = 'none';

      const statusBadgeClass = {
        '初訪': 'bg-info',
        '中期': 'bg-warning',
        '結案': 'bg-success'
      };
      const statusClass = statusBadgeClass[currentGuidanceRecord.status] || 'bg-secondary';

      const section = document.getElementById('surveySection');
      let html = `
        <!-- 返回按鈕 -->
        <div class="mb-3">
          <button class="btn btn-outline-secondary btn-sm" onclick="backToGuidanceList()">
            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">arrow_back</span>
            返回輔導列表
          </button>
        </div>

        <div class="card">
          <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">輔導紀錄詳情</h5>
              <div>
                <button class="btn btn-outline-primary me-2" onclick="editGuidanceRecord()">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">edit</span>
                  編輯
                </button>
                <button class="btn btn-outline-danger" onclick="deleteCurrentGuidanceRecord()">
                  <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">delete</span>
                  刪除
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-4">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label text-muted small">輔導類型</label>
                  <div>
                    <span class="badge bg-primary fs-6">${escapeHtml(currentGuidanceRecord.type || '一般輔導')}</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label text-muted small">狀態</label>
                  <div>
                    ${currentGuidanceRecord.status ? `<span class="badge ${statusClass} fs-6">${escapeHtml(currentGuidanceRecord.status)}</span>` : '<span class="text-muted">-</span>'}
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label text-muted small">輔導日期</label>
                  <div class="fw-medium">${formatDateTime(currentGuidanceRecord.date)}</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label text-muted small">輔導顧問</label>
                  <div class="fw-medium">${escapeHtml(currentGuidanceRecord.consultant || '-')}</div>
                </div>
              </div>
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label text-muted small">輔導主題</label>
                  <h5>${escapeHtml(currentGuidanceRecord.title || '無標題')}</h5>
                </div>
              </div>
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label text-muted small">輔導內容</label>
                  <div class="border rounded p-3" style="background-color: #f8f9fa; min-height: 200px; white-space: pre-wrap;">
${escapeHtml(currentGuidanceRecord.content || '無內容')}
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label text-muted small">建議</label>
                  <div class="border rounded p-3" style="background-color: #f8f9fa; min-height: 120px; white-space: pre-wrap;">
${escapeHtml(currentGuidanceRecord.suggestions || '尚無建議')}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 附件管理 -->
        <div class="card mt-4">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <span class="material-icons" style="font-size: 20px; vertical-align: middle; margin-right: 8px;">attach_file</span>
              附件管理
            </h5>
            <input type="file" id="attachmentInput" class="d-none" multiple onchange="handleAttachmentUpload(this)">
            <button class="btn btn-primary btn-sm" onclick="document.getElementById('attachmentInput').click()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">upload</span>
              上傳附件
            </button>
          </div>
          <div class="card-body" id="attachmentListContainer">
            ${renderAttachments()}
          </div>
        </div>
      `;
      
      // 設置 section 的 HTML
      section.innerHTML = html;
    }
    
    // 更新附件列表（不重新渲染整個頁面）
    function updateAttachmentList() {
      const container = document.getElementById('attachmentListContainer');
      if (container) {
        container.innerHTML = renderAttachments();
      }
    }
    
    // 渲染附件列表
    function renderAttachments() {
      const attachments = currentGuidanceRecord.attachments || [];
      
      if (attachments.length === 0) {
        return '<div class="text-center py-4 text-muted">尚無附件</div>';
      }
      
      // 按類型分類
      const reports = attachments.filter(a => ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'csv'].includes(a.type));
      const images = attachments.filter(a => ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(a.type));
      const others = attachments.filter(a => !reports.includes(a) && !images.includes(a));
      
      let html = '';
      
      // 報告文件
      if (reports.length > 0) {
        html += `
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseReports">
              <h6 class="mb-0">
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">description</span>
                報告文件 (${reports.length})
              </h6>
              <span class="material-icons">expand_more</span>
            </div>
            <div class="collapse show" id="collapseReports">
              <div class="list-group">
        `;
        reports.forEach(att => {
          // 根據檔案類型選擇圖標和顏色
          let icon = 'description';
          let iconColor = '#6c757d';
          
          if (att.type === 'pdf') {
            icon = 'picture_as_pdf';
            iconColor = '#dc3545'; // 紅色
          } else if (['xls', 'xlsx'].includes(att.type)) {
            icon = 'table_chart';
            iconColor = '#28a745'; // 綠色
          } else if (['doc', 'docx'].includes(att.type)) {
            icon = 'article';
            iconColor = '#007bff'; // 藍色
          } else if (['ppt', 'pptx'].includes(att.type)) {
            icon = 'slideshow';
            iconColor = '#fd7e14'; // 橘色
          } else if (att.type === 'csv') {
            icon = 'grid_on';
            iconColor = '#20c997'; // 青綠色
          }
          
          html += `
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <span class="material-icons me-2" style="color: ${iconColor}; font-size: 24px;">${icon}</span>
                  <div>
                    <div>${escapeHtml(att.name)}</div>
                    <small class="text-muted">${formatFileSize(att.size)} • ${formatDateTime(att.uploadedAt)}</small>
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadAttachment('${att.id}')">
                    <span class="material-icons" style="font-size: 16px;">download</span>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment('${att.id}')">
                    <span class="material-icons" style="font-size: 16px;">delete</span>
                  </button>
                </div>
              </div>
          `;
        });
        html += `
              </div>
            </div>
          </div>
        `;
      }
      
      // 現場照片
      if (images.length > 0) {
        html += `
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseImages">
              <h6 class="mb-0">
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">photo_library</span>
                現場照片 (${images.length})
              </h6>
              <span class="material-icons">expand_more</span>
            </div>
            <div class="collapse show" id="collapseImages">
              <div class="row g-3">
        `;
        images.forEach(att => {
          html += `
              <div class="col-md-3">
                <div class="card">
                  <img src="${att.data}" class="card-img-top" style="height: 150px; object-fit: cover; cursor: pointer;" 
                       onclick="viewImage('${att.id}')" alt="${escapeHtml(att.name)}">
                  <div class="card-body p-2">
                    <small class="d-block text-truncate" title="${escapeHtml(att.name)}">${escapeHtml(att.name)}</small>
                    <div class="d-flex justify-content-between mt-2">
                      <button class="btn btn-sm btn-outline-primary" onclick="downloadAttachment('${att.id}')">
                        <span class="material-icons" style="font-size: 14px;">download</span>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment('${att.id}')">
                        <span class="material-icons" style="font-size: 14px;">delete</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
          `;
        });
        html += `
              </div>
            </div>
          </div>
        `;
      }
      
      // 其他檔案
      if (others.length > 0) {
        html += `
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseOthers">
              <h6 class="mb-0">
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">folder</span>
                其他檔案 (${others.length})
              </h6>
              <span class="material-icons">expand_more</span>
            </div>
            <div class="collapse show" id="collapseOthers">
              <div class="list-group">
        `;
        others.forEach(att => {
          html += `
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <span class="material-icons me-2">insert_drive_file</span>
                  <div>
                    <div>${escapeHtml(att.name)}</div>
                    <small class="text-muted">${formatFileSize(att.size)} • ${formatDateTime(att.uploadedAt)}</small>
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadAttachment('${att.id}')">
                    <span class="material-icons" style="font-size: 16px;">download</span>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment('${att.id}')">
                    <span class="material-icons" style="font-size: 16px;">delete</span>
                  </button>
                </div>
              </div>
          `;
        });
        html += `
              </div>
            </div>
          </div>
        `;
      }
      
      return html;
    }
    
    // 處理附件上傳
    function handleAttachmentUpload(input) {
      console.log('=== 開始處理附件上傳 ===');
      console.log('input:', input);
      console.log('input.files:', input.files);
      
      const files = input.files;
      if (!files || files.length === 0) {
        console.log('❌ 沒有選擇檔案');
        alert('沒有選擇檔案');
        return;
      }
      
      console.log(`✅ 選擇了 ${files.length} 個檔案`);
      
      // 檢查總檔案大小
      let totalSize = 0;
      for (let file of files) {
        console.log(`檔案: ${file.name}, 大小: ${file.size} bytes`);
        totalSize += file.size;
      }
      
      console.log(`總大小：${totalSize} bytes (${(totalSize / 1024 / 1024).toFixed(2)} MB)`);
      
      if (!currentGuidanceRecord) {
        console.log('❌ currentGuidanceRecord 是 null');
        alert('找不到當前輔導紀錄');
        return;
      }
      
      console.log('✅ currentGuidanceRecord 存在:', currentGuidanceRecord);
      
      if (!currentGuidanceRecord.attachments) {
        currentGuidanceRecord.attachments = [];
      }
      
      // 先儲存檔案數量，因為清空 input 後 files.length 會變成 0
      const totalFiles = files.length;
      let uploadedCount = 0;
      let errorCount = 0;
      
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            const attachment = {
              id: `att-${Date.now()}-${index}`,
              name: file.name,
              type: fileExt,
              size: file.size,
              data: e.target.result,
              uploadedAt: new Date().toISOString()
            };
            
            currentGuidanceRecord.attachments.push(attachment);
            
            // 同步更新到 currentCompany
            if (currentCompany.guidanceRecords && currentGuidanceIndex !== null) {
              currentCompany.guidanceRecords[currentGuidanceIndex] = currentGuidanceRecord;
            }
            
            uploadedCount++;
            console.log(`已上傳 ${uploadedCount}/${totalFiles} 個檔案`);
            
            // 當所有檔案都處理完成
            if (uploadedCount + errorCount === totalFiles) {
              try {
                saveCompany();
                console.log('已儲存到 localStorage');
                updateAttachmentList();  // 只更新附件列表，不重新渲染整個頁面
                
                if (errorCount > 0) {
                  alert(`成功上傳 ${uploadedCount} 個附件，${errorCount} 個失敗`);
                } else {
                  alert(`成功上傳 ${uploadedCount} 個附件`);
                }
              } catch (err) {
                console.error('儲存失敗：', err);
                alert('儲存失敗，可能是空間不足。請刪除一些舊資料或選擇較小的檔案。');
              }
            }
          } catch (err) {
            console.error('處理檔案錯誤：', err);
            errorCount++;
          }
        };
        
        reader.onerror = function(err) {
          console.error('讀取檔案錯誤：', err);
          alert(`檔案「${file.name}」讀取失敗`);
          errorCount++;
          
          // 檢查是否所有檔案都處理完成
          if (uploadedCount + errorCount === totalFiles) {
            if (uploadedCount > 0) {
              saveCompany();
              updateAttachmentList();  // 只更新附件列表
              alert(`成功上傳 ${uploadedCount} 個附件，${errorCount} 個失敗`);
            }
          }
        };
        
        reader.readAsDataURL(file);
      });
      
      // 清空 input
      input.value = '';
    }
    
    // 下載附件
    function downloadAttachment(attachmentId) {
      const attachment = currentGuidanceRecord.attachments?.find(a => a.id === attachmentId);
      if (!attachment) {
        alert('找不到附件');
        return;
      }
      
      const link = document.createElement('a');
      link.href = attachment.data;
      link.download = attachment.name;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // 刪除附件
    function deleteAttachment(attachmentId) {
      if (!confirm('確定要刪除此附件嗎？')) return;
      
      const index = currentGuidanceRecord.attachments?.findIndex(a => a.id === attachmentId);
      if (index === -1 || index === undefined) {
        alert('找不到附件');
        return;
      }
      
      currentGuidanceRecord.attachments.splice(index, 1);
      
      // 同步更新到 currentCompany
      if (currentCompany.guidanceRecords && currentGuidanceIndex !== null) {
        currentCompany.guidanceRecords[currentGuidanceIndex] = currentGuidanceRecord;
      }
      
      saveCompany();
      updateAttachmentList();  // 只更新附件列表
      alert('附件已刪除');
    }
    
    // 查看圖片（放大顯示）
    function viewImage(attachmentId) {
      const attachment = currentGuidanceRecord.attachments?.find(a => a.id === attachmentId);
      if (!attachment) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.id = 'imageViewModal';
      modal.tabIndex = -1;
      modal.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${escapeHtml(attachment.name)}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <img src="${attachment.data}" class="img-fluid" alt="${escapeHtml(attachment.name)}">
            </div>
          </div>
        </div>
      `;
      
      // 移除舊的 modal
      const oldModal = document.getElementById('imageViewModal');
      if (oldModal) oldModal.remove();
      
      document.body.appendChild(modal);
      const modalInstance = new bootstrap.Modal(modal);
      modalInstance.show();
      
      // Modal 關閉後移除
      modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
      });
    }
    
    // 格式化檔案大小
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // 編輯輔導紀錄
    function editGuidanceRecord() {
      if (!currentGuidanceRecord) return;

      // 建立編輯模態框
      const modalHtml = `
        <div class="modal fade" id="editGuidanceModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">編輯輔導紀錄</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">輔導類型</label>
                  <select class="form-select" id="editGuidanceType">
                    <option value="初次訪談" ${currentGuidanceRecord.type === '初次訪談' ? 'selected' : ''}>初次訪談</option>
                    <option value="技術輔導" ${currentGuidanceRecord.type === '技術輔導' ? 'selected' : ''}>技術輔導</option>
                    <option value="追蹤輔導" ${currentGuidanceRecord.type === '追蹤輔導' ? 'selected' : ''}>追蹤輔導</option>
                    <option value="一般輔導" ${currentGuidanceRecord.type === '一般輔導' ? 'selected' : ''}>一般輔導</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">狀態</label>
                  <select class="form-select" id="editGuidanceStatus">
                    <option value="初訪" ${currentGuidanceRecord.status === '初訪' ? 'selected' : ''}>初訪</option>
                    <option value="中期" ${currentGuidanceRecord.status === '中期' ? 'selected' : ''}>中期</option>
                    <option value="結案" ${currentGuidanceRecord.status === '結案' ? 'selected' : ''}>結案</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導主題</label>
                  <input type="text" class="form-control" id="editGuidanceTitle" value="${escapeHtml(currentGuidanceRecord.title || '')}">
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導內容</label>
                  <textarea class="form-control" id="editGuidanceContent" rows="6">${escapeHtml(currentGuidanceRecord.content || '')}</textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">建議</label>
                  <textarea class="form-control" id="editGuidanceSuggestions" rows="4">${escapeHtml(currentGuidanceRecord.suggestions || '')}</textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導顧問</label>
                  <input type="text" class="form-control" id="editGuidanceConsultant" value="${escapeHtml(currentGuidanceRecord.consultant || '')}">
                </div>
                <div class="mb-3">
                  <label class="form-label">輔導日期</label>
                  <input type="datetime-local" class="form-control" id="editGuidanceDate" value="${new Date(currentGuidanceRecord.date).toISOString().slice(0, 16)}">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedGuidanceRecord()">儲存</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // 移除舊的模態框
      const oldModal = document.getElementById('editGuidanceModal');
      if (oldModal) oldModal.remove();

      // 添加到 body
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // 顯示模態框
      const modal = new bootstrap.Modal(document.getElementById('editGuidanceModal'));
      modal.show();
    }

    // 儲存編輯的輔導紀錄
    function saveEditedGuidanceRecord() {
      const type = document.getElementById('editGuidanceType').value;
      const status = document.getElementById('editGuidanceStatus').value;
      const title = document.getElementById('editGuidanceTitle').value.trim();
      const content = document.getElementById('editGuidanceContent').value.trim();
      const consultant = document.getElementById('editGuidanceConsultant').value.trim();
      const suggestions = document.getElementById('editGuidanceSuggestions').value.trim();
      const date = document.getElementById('editGuidanceDate').value;

      if (!title) {
        alert('請輸入輔導主題');
        return;
      }

      if (!content) {
        alert('請輸入輔導內容');
        return;
      }

      // 更新紀錄
      currentGuidanceRecord.type = type;
      currentGuidanceRecord.status = status;
      currentGuidanceRecord.title = title;
      currentGuidanceRecord.content = content;
      currentGuidanceRecord.consultant = consultant;
      currentGuidanceRecord.suggestions = suggestions;
      currentGuidanceRecord.date = new Date(date).toISOString();

      // 更新公司資料
      currentCompany.guidanceRecords[currentGuidanceIndex] = currentGuidanceRecord;

      // 儲存到 localStorage
      saveCompany();

      // 關閉模態框
      const modal = bootstrap.Modal.getInstance(document.getElementById('editGuidanceModal'));
      modal.hide();

      // 重新渲染詳情
      renderGuidanceDetail();
    }

    // 刪除當前輔導紀錄
    function deleteCurrentGuidanceRecord() {
      if (!confirm('確定要刪除這筆輔導紀錄嗎？')) return;
      
      currentCompany.guidanceRecords.splice(currentGuidanceIndex, 1);
      saveCompany();
      
      // 返回列表
      backToGuidanceList();
    }

    // 新增問卷 Modal 實例
    let createSurveyModalInstance = null;

    // 新增問卷
    function createSurvey() {
      // 清空表單
      document.getElementById('newSurveyName').value = '';
      document.getElementById('newSurveyDescription').value = '';
      document.getElementById('newSurveyOwner').value = '';
      document.getElementById('newSurveyCreator').value = '';
      
      // 顯示 Modal
      if (!createSurveyModalInstance) {
        createSurveyModalInstance = new bootstrap.Modal(document.getElementById('createSurveyModal'));
      }
      createSurveyModalInstance.show();
    }

    // 提交新增問卷
    function submitCreateSurvey() {
      const name = document.getElementById('newSurveyName').value.trim();
      const description = document.getElementById('newSurveyDescription').value.trim();
      const owner = document.getElementById('newSurveyOwner').value.trim();
      const creator = document.getElementById('newSurveyCreator').value.trim();
      
      // 驗證必填欄位
      if (!name) {
        alert('請輸入問卷名稱');
        return;
      }
      if (!creator) {
        alert('請輸入建立者姓名');
        return;
      }

      const now = new Date();
      const newSurvey = {
        id: `survey-${Date.now()}`,
        name: name,
        description: description || '尚未填寫說明',
        owner: owner || '尚未指派',
        creator: creator,
        status: '草稿',
        createdAt: now.toISOString(),
        fields: [],
        responses: []
      };

      if (!currentCompany.surveys) {
        currentCompany.surveys = [];
      }
      currentCompany.surveys.push(newSurvey);

      saveCompany();
      
      // 關閉 Modal
      createSurveyModalInstance.hide();
      
      // 重新渲染列表
      renderSurveyList();
      
      // 提示成功
      setTimeout(() => {
        alert(`問卷「${name}」已成功新增！`);
      }, 300);
    }

    // 刪除問卷
    function deleteSurvey(index) {
      const survey = currentCompany.surveys[index];
      if (!confirm(`確定要刪除問卷「${survey.name}」嗎？`)) return;
      
      currentCompany.surveys.splice(index, 1);
      saveCompany();
      renderSurveyList();
    }

    // 匯入問卷資料
    async function handleImportFile(input) {
      const file = input.files?.[0];
      input.value = '';
      if (!file) return;

      // 先要求輸入建立者名稱
      const creator = prompt('請輸入建立者名稱：');
      if (!creator || !creator.trim()) {
        alert('必須輸入建立者名稱才能上傳');
        return;
      }

      if (typeof XLSX === 'undefined') {
        alert('載入 Excel 解析工具失敗，請重新整理頁面後再試。');
        return;
      }

      try {
        const ext = file.name.split('.').pop()?.toLowerCase();
        if (!ext || !['xlsx', 'xls', 'csv'].includes(ext)) {
          alert('僅支援 Excel (.xlsx, .xls) 或 CSV 檔案');
          return;
        }

        const mode = ext === 'csv' ? 'text' : 'arrayBuffer';
        const fileData = await readFileAsync(file, mode);

        let workbook;
        if (ext === 'csv') {
          workbook = XLSX.read(fileData, { type: 'string' });
        } else {
          workbook = XLSX.read(new Uint8Array(fileData), { type: 'array' });
        }

        if (!workbook.SheetNames || !workbook.SheetNames.length) {
          alert('檔案中找不到任何工作表');
          return;
        }

        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

        processImportedData(rows, creator.trim(), file.name);
      } catch (error) {
        console.error(error);
        alert('匯入失敗：' + (error.message || '請確認檔案格式'));
      }
    }

    // 讀取檔案
    function readFileAsync(file, mode) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = event => resolve(event.target.result);
        reader.onerror = () => reject(new Error('檔案讀取失敗'));
        if (mode === 'text') {
          reader.readAsText(file, 'utf-8');
        } else {
          reader.readAsArrayBuffer(file);
        }
      });
    }

    // 處理匯入的資料
    function processImportedData(rows, creator, fileName) {
      if (!rows || !rows.length) {
        alert('檔案內沒有資料');
        return;
      }

      const headers = rows[0].map((cell, index) => {
        const text = String(cell ?? '').trim();
        return text || `欄位${index + 1}`;
      });

      const dataRows = rows.slice(1).filter(row => 
        Array.isArray(row) && row.some(cell => String(cell ?? '').trim() !== '')
      );

      if (!dataRows.length) {
        alert('沒有可匯入的資料列');
        return;
      }

      const fields = headers.map((label, index) => ({
        id: `field-${index}`,
        label: label,
        group: '匯入資料',
        summary: true,
        type: 'text'
      }));

      const baseTime = Date.now();
      const responses = dataRows.map((row, index) => {
        const values = {};
        headers.forEach((header, colIdx) => {
          values[`field-${colIdx}`] = row[colIdx] ?? '';
        });

        const submittedAt = new Date(baseTime + index * 1000).toISOString();
        values.submittedAt = submittedAt;

        return {
          id: `${currentSurvey.id.toUpperCase()}-${String(index + 1).padStart(4, '0')}`,
          submittedAt: submittedAt,
          values
        };
      });

      // 初始化匯入歷史（如果不存在）
      if (!currentSurvey.importHistory) {
        currentSurvey.importHistory = [];
      }

      // 記錄本次匯入
      const importRecord = {
        id: `import-${Date.now()}`,
        fileName: fileName,
        uploadedBy: creator,
        uploadedAt: new Date().toISOString(),
        recordCount: responses.length,
        fieldCount: fields.length
      };
      currentSurvey.importHistory.unshift(importRecord);

      // 更新問卷
      currentSurvey.fields = fields;
      currentSurvey.responses = responses;
      currentSurvey.status = '進行中';
      currentSurvey.creator = creator;
      currentSurvey.lastUploadAt = new Date().toISOString();
      currentSurvey.lastUploadBy = creator;

      saveCompany();
      alert(`匯入完成：已導入 ${responses.length} 筆資料，共 ${fields.length} 個欄位`);
      renderSurveyDetail();
    }

    // 匯出問卷資料
    function exportSurveyData() {
      if (typeof XLSX === 'undefined') {
        alert('載入 Excel 工具失敗，請重新整理頁面後再試。');
        return;
      }

      const survey = currentSurvey;
      const fields = survey.fields || [];
      const responses = survey.responses || [];

      if (!responses.length) {
        alert('此問卷尚無回覆資料可匯出');
        return;
      }

      // 建立標題列
      const headers = ['#', '問卷編號', '提交時間', ...fields.map(f => f.label)];

      // 建立資料列
      const data = responses.map((response, index) => {
        const row = [
          index + 1,
          response.id,
          formatDateTime(response.submittedAt)
        ];

        fields.forEach(field => {
          const value = response.values[field.id];
          if (Array.isArray(value)) {
            row.push(value.join(', '));
          } else if (value == null) {
            row.push('');
          } else {
            row.push(String(value));
          }
        });

        return row;
      });

      // 建立工作表
      const wsData = [headers, ...data];
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // 設定欄位寬度
      const colWidths = headers.map((_, i) => {
        if (i === 0) return { wch: 5 };
        if (i === 1) return { wch: 15 };
        if (i === 2) return { wch: 20 };
        return { wch: 25 };
      });
      ws['!cols'] = colWidths;

      // 建立工作簿
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '問卷回覆');

      // 下載檔案
      const fileName = `${currentCompany.name}_${survey.name}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);

      alert(`已匯出 ${responses.length} 筆資料`);
    }

    // 儲存公司資料
    function saveCompany() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;

      try {
        const companies = JSON.parse(raw);
        const index = companies.findIndex(c => c.id === companyId);
        if (index !== -1) {
          companies[index] = currentCompany;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(companies));
        }
      } catch (e) {
        console.error('儲存失敗', e);
      }
    }

    // 刪除匯入記錄
    function deleteImportRecord(importId) {
      if (!confirm('確定要刪除此匯入記錄嗎？\n注意：這不會刪除問卷資料，只是刪除記錄。')) {
        return;
      }
      
      if (!currentSurvey.importHistory) {
        return;
      }
      
      // 找到並刪除記錄
      const index = currentSurvey.importHistory.findIndex(record => record.id === importId);
      if (index !== -1) {
        currentSurvey.importHistory.splice(index, 1);
        saveCompany();
        renderSurveyDetail();
        alert('匯入記錄已刪除');
      }
    }

    // 開啟篩選 Modal
    function openFilterModal() {
      if (!currentSurvey) return;
      
      const fields = currentSurvey.fields || [];
      
      // 初始化 visibleFields（第一次開啟時全選）
      if (visibleFields.length === 0) {
        visibleFields = fields.map(f => f.id);
      }
      
      // 渲染欄位選擇區
      renderFieldSelection(fields);
      
      // 渲染篩選條件區
      renderFilterConditions(fields);
      
      // 顯示 Modal
      if (!filterModalInstance) {
        filterModalInstance = new bootstrap.Modal(document.getElementById('filterModal'));
      }
      filterModalInstance.show();
    }

    // 渲染欄位選擇區
    function renderFieldSelection(fields) {
      const container = document.getElementById('fieldSelectionContainer');
      let html = '';
      
      fields.forEach(field => {
        const checked = visibleFields.includes(field.id) ? 'checked' : '';
        html += `
          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" 
                     id="field-${field.id}" value="${field.id}" ${checked}
                     onchange="toggleFieldVisibility('${field.id}', this.checked)">
              <label class="form-check-label" for="field-${field.id}">
                ${escapeHtml(field.label)}
              </label>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // 渲染篩選條件區（只顯示已勾選的欄位）
    function renderFilterConditions(fields) {
      const container = document.getElementById('filterConditionsContainer');
      let html = '';
      
      const visibleFieldObjects = fields.filter(f => visibleFields.includes(f.id));
      
      if (visibleFieldObjects.length === 0) {
        html = '<p class="text-muted">請先選擇要顯示的欄位</p>';
      } else {
        const responses = currentSurvey.responses || [];
        
        html += '<div class="accordion" id="filterAccordion">';
        
        visibleFieldObjects.forEach((field, index) => {
          // 統計該欄位的所有不同值
          const valueStats = getFieldValueStats(responses, field.id);
          const searchKeyword = fieldSearchKeywords[field.id] || '';
          const selectedValues = filterConditions[field.id] || [];
          
          // 過濾選項（根據搜尋關鍵字）
          const filteredValues = valueStats.filter(stat => {
            if (!searchKeyword) return true;
            return String(stat.value).toLowerCase().includes(searchKeyword.toLowerCase());
          });
          
          // 顯示已選數量
          const selectedCount = selectedValues.length;
          const countBadge = selectedCount > 0 ? `<span class="badge bg-primary">${selectedCount}</span>` : '';
          
          html += `
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-${field.id}">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#collapse-${field.id}">
                  <span class="flex-grow-1">${escapeHtml(field.label)}</span>
                  ${countBadge}
                </button>
              </h2>
              <div id="collapse-${field.id}" class="accordion-collapse collapse" 
                   data-bs-parent="#filterAccordion">
                <div class="accordion-body">
                  <!-- 搜尋框 -->
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">
                      <span class="material-icons" style="font-size: 16px;">search</span>
                    </span>
                    <input type="text" class="form-control form-control-sm" 
                           id="search-${field.id}" 
                           value="${escapeHtml(searchKeyword)}"
                           placeholder="搜尋選項..."
                           oninput="updateFieldSearch('${field.id}', this.value)">
                  </div>
                  
                  <!-- Checkbox 列表 -->
                  <div id="options-${field.id}" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; background: #f8f9fa;">
          `;
          
          if (filteredValues.length === 0) {
            html += '<p class="text-muted small mb-0">無符合的選項</p>';
          } else {
            filteredValues.forEach(stat => {
              const valueStr = String(stat.value);
              const isChecked = selectedValues.includes(valueStr) ? 'checked' : '';
              const safeValue = escapeHtml(valueStr).replace(/'/g, '&#39;');
              
              html += `
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" 
                         id="opt-${field.id}-${stat.index}" 
                         value="${safeValue}"
                         ${isChecked}
                         onchange="toggleFilterOption('${field.id}', '${safeValue}', this.checked)">
                  <label class="form-check-label small" for="opt-${field.id}-${stat.index}">
                    ${escapeHtml(valueStr)} <span class="text-muted">(${stat.count})</span>
                  </label>
                </div>
              `;
            });
          }
          
          html += `
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      }
      
      container.innerHTML = html;
    }
    
    // 統計欄位的所有不同值及其出現次數
    function getFieldValueStats(responses, fieldId) {
      const valueCount = {};
      
      responses.forEach(response => {
        const value = response.values[fieldId];
        
        // 處理陣列值（多選）
        if (Array.isArray(value)) {
          value.forEach(v => {
            const key = String(v);
            valueCount[key] = (valueCount[key] || 0) + 1;
          });
        } else if (value != null && value !== '') {
          const key = String(value);
          valueCount[key] = (valueCount[key] || 0) + 1;
        }
      });
      
      // 轉換為陣列並排序（按出現次數降序）
      return Object.entries(valueCount)
        .map(([value, count], index) => ({ value, count, index }))
        .sort((a, b) => b.count - a.count);
    }
    
    // 更新欄位搜尋關鍵字
    function updateFieldSearch(fieldId, keyword) {
      fieldSearchKeywords[fieldId] = keyword;
      // 只重新渲染該欄位的選項列表
      updateFieldOptions(fieldId);
    }
    
    // 更新單一欄位的選項列表（不重新渲染整個區塊）
    function updateFieldOptions(fieldId) {
      const container = document.getElementById(`options-${fieldId}`);
      if (!container) return;
      
      const responses = currentSurvey.responses || [];
      const field = (currentSurvey.fields || []).find(f => f.id === fieldId);
      if (!field) return;
      
      const valueStats = getFieldValueStats(responses, fieldId);
      const searchKeyword = fieldSearchKeywords[fieldId] || '';
      const selectedValues = filterConditions[fieldId] || [];
      
      // 過濾選項
      const filteredValues = valueStats.filter(stat => {
        if (!searchKeyword) return true;
        return String(stat.value).toLowerCase().includes(searchKeyword.toLowerCase());
      });
      
      let html = '';
      if (filteredValues.length === 0) {
        html = '<p class="text-muted small mb-0">無符合的選項</p>';
      } else {
        filteredValues.forEach(stat => {
          const valueStr = String(stat.value);
          const isChecked = selectedValues.includes(valueStr) ? 'checked' : '';
          const safeValue = escapeHtml(valueStr).replace(/'/g, '&#39;');
          
          html += `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" 
                     id="opt-${fieldId}-${stat.index}" 
                     value="${safeValue}"
                     ${isChecked}
                     onchange="toggleFilterOption('${fieldId}', '${safeValue}', this.checked)">
              <label class="form-check-label small" for="opt-${fieldId}-${stat.index}">
                ${escapeHtml(valueStr)} <span class="text-muted">(${stat.count})</span>
              </label>
            </div>
          `;
        });
      }
      
      container.innerHTML = html;
    }
    
    // 切換篩選選項
    function toggleFilterOption(fieldId, value, isChecked) {
      if (!filterConditions[fieldId]) {
        filterConditions[fieldId] = [];
      }
      
      if (isChecked) {
        if (!filterConditions[fieldId].includes(value)) {
          filterConditions[fieldId].push(value);
        }
      } else {
        filterConditions[fieldId] = filterConditions[fieldId].filter(v => v !== value);
      }
      
      // 更新 Accordion header 的 badge
      updateAccordionBadge(fieldId);
    }
    
    // 更新 Accordion 標題的 badge
    function updateAccordionBadge(fieldId) {
      const button = document.querySelector(`#heading-${fieldId} button`);
      if (!button) return;
      
      const selectedValues = filterConditions[fieldId] || [];
      const selectedCount = selectedValues.length;
      
      // 移除舊的 badge
      const oldBadge = button.querySelector('.badge');
      if (oldBadge) {
        oldBadge.remove();
      }
      
      // 如果有選中項目，添加新的 badge
      if (selectedCount > 0) {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary';
        badge.textContent = selectedCount;
        button.appendChild(badge);
      }
    }

    // 切換欄位顯示
    function toggleFieldVisibility(fieldId, isVisible) {
      if (isVisible) {
        if (!visibleFields.includes(fieldId)) {
          visibleFields.push(fieldId);
        }
      } else {
        visibleFields = visibleFields.filter(id => id !== fieldId);
      }
      
      // 重新渲染篩選條件區
      const fields = currentSurvey.fields || [];
      renderFilterConditions(fields);
    }

    // 套用篩選
    function applyFilters() {
      // 計算啟用的篩選條件數量（有選中項目的欄位）
      activeFilterCount = 0;
      Object.values(filterConditions).forEach(values => {
        if (values && values.length > 0) {
          activeFilterCount++;
        }
      });
      
      // 關閉 Modal
      filterModalInstance.hide();
      
      // 重新渲染問卷詳情
      renderSurveyDetail();
    }

    // 清除篩選
    function clearFilters() {
      filterConditions = {};
      activeFilterCount = 0;
      fieldSearchKeywords = {};
      
      // 重置顯示欄位為全選
      const fields = currentSurvey.fields || [];
      visibleFields = fields.map(f => f.id);
      
      // 重新渲染欄位選擇區和篩選條件區
      renderFieldSelection(fields);
      renderFilterConditions(fields);
    }

    // 匯出資料
    function exportData(format) {
      if (!currentSurvey) return;
      
      const fields = currentSurvey.fields || [];
      const responses = currentSurvey.responses || [];
      
      // 取得篩選後的資料
      const filteredResponses = filterSurveyResponses(responses, fields);
      
      if (filteredResponses.length === 0) {
        alert('沒有資料可以匯出');
        return;
      }
      
      // 決定要匯出的欄位（如果沒有設定 visibleFields，則匯出全部）
      const exportFields = visibleFields.length > 0 
        ? fields.filter(f => visibleFields.includes(f.id))
        : fields;
      
      if (exportFields.length === 0) {
        alert('請至少選擇一個要顯示的欄位');
        return;
      }
      
      // 準備資料
      const data = [];
      
      // 標題行（包含基本欄位 + 動態欄位）
      const headers = ['#', '問卷編號', '提交時間', ...exportFields.map(f => f.label)];
      data.push(headers);
      
      // 資料行
      filteredResponses.forEach((response, index) => {
        const row = [
          index + 1,
          response.id,
          formatDateTime(response.submittedAt)
        ];
        
        // 加入各欄位的值
        exportFields.forEach(field => {
          const value = response.values[field.id];
          let cellValue = '';
          
          if (Array.isArray(value)) {
            cellValue = value.join(', ');
          } else if (value != null) {
            cellValue = String(value);
          }
          
          row.push(cellValue);
        });
        
        data.push(row);
      });
      
      // 根據格式匯出
      if (format === 'excel') {
        exportToExcel(data);
      } else if (format === 'csv') {
        exportToCSV(data);
      }
    }
    
    // 匯出為 Excel
    function exportToExcel(data) {
      if (typeof XLSX === 'undefined') {
        alert('XLSX 庫尚未載入，請稍後再試');
        return;
      }
      
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '問卷回覆');
      
      const fileName = `${currentCompany.name}_${currentSurvey.name}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      alert(`已匯出 ${data.length - 1} 筆資料`);
    }
    
    // 匯出為 CSV
    function exportToCSV(data) {
      // 將資料轉換為 CSV 格式
      const csvContent = data.map(row => {
        return row.map(cell => {
          // 處理包含逗號、引號或換行的儲存格
          const cellStr = String(cell || '');
          if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
            return '"' + cellStr.replace(/"/g, '""') + '"';
          }
          return cellStr;
        }).join(',');
      }).join('\n');
      
      // 加上 BOM 以支援中文
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      
      // 創建下載連結
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      const fileName = `${currentCompany.name}_${currentSurvey.name}_${new Date().toISOString().slice(0, 10)}.csv`;
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`已匯出 ${data.length - 1} 筆資料`);
    }

    // 匯出輔導紀錄
    function exportGuidanceRecords(format) {
      if (!currentCompany) {
        alert('找不到公司資料');
        return;
      }
      
      const records = currentCompany.guidanceRecords || [];
      
      if (records.length === 0) {
        alert('沒有輔導紀錄可以匯出');
        return;
      }
      
      // 準備資料
      const data = [];
      
      // 標題行
      const headers = [
        '#',
        '輔導日期',
        '輔導類型',
        '輔導階段',
        '輔導顧問',
        '輔導主題',
        '輔導內容',
        '建議',
        '附件數量'
      ];
      data.push(headers);
      
      // 資料行
      records.forEach((record, index) => {
        const row = [
          index + 1,
          formatDateTime(record.date),
          record.type || '',
          record.status || '',
          record.consultant || '',
          record.title || '',
          record.content || '',
          record.suggestions || '',
          (record.attachments || []).length
        ];
        data.push(row);
      });
      
      // 根據格式匯出
      if (format === 'excel') {
        exportGuidanceToExcel(data);
      } else if (format === 'csv') {
        exportGuidanceToCSV(data);
      }
    }
    
    // 匯出輔導紀錄為 Excel
    function exportGuidanceToExcel(data) {
      if (typeof XLSX === 'undefined') {
        alert('XLSX 庫尚未載入，請稍後再試');
        return;
      }
      
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '輔導紀錄');
      
      const fileName = `${currentCompany.name}_輔導紀錄_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      alert(`已匯出 ${data.length - 1} 筆輔導紀錄`);
    }
    
    // 匯出輔導紀錄為 CSV
    function exportGuidanceToCSV(data) {
      // 將資料轉換為 CSV 格式
      const csvContent = data.map(row => {
        return row.map(cell => {
          const cellStr = String(cell || '');
          if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
            return '"' + cellStr.replace(/"/g, '""') + '"';
          }
          return cellStr;
        }).join(',');
      }).join('\n');
      
      // 加上 BOM 以支援中文
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      
      // 創建下載連結
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      const fileName = `${currentCompany.name}_輔導紀錄_${new Date().toISOString().slice(0, 10)}.csv`;
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`已匯出 ${data.length - 1} 筆輔導紀錄`);
    }

    // 初始化
    window.addEventListener('load', function() {
      loadCompany();
    });
  </script>
</body>
</html>
