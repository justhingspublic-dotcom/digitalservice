<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å•å·è©³æƒ… - æ•¸ä½è½‰å‹å•å·ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="../assets/css/custom.css" rel="stylesheet">
  <style>
    /* å‡çµè¡¨é ­æ¨£å¼ */
    .sticky-table-wrapper {
      max-height: 600px;
      overflow-y: auto;
      overflow-x: auto;
      position: relative;
      border: 1px solid #dee2e6;
      border-radius: 0;
    }
    
    .sticky-table-wrapper .table {
      margin-bottom: 0;
    }
    
    .sticky-table-wrapper .table thead th {
      position: sticky !important;
      top: 0 !important;
      z-index: 100 !important;
      background-color: #f8f9fa !important;
      border-bottom: 2px solid #dee2e6 !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    
    /* ç¢ºä¿è¡¨é ­æ–‡å­—å¯è¦‹ */
    .sticky-table-wrapper .table thead th::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      border-bottom: 1px solid #dee2e6;
    }
  </style>
</head>
<body>
  <div id="topbar"></div>

  <div class="d-flex" style="height: calc(100vh - 64px);">
    <div id="sidebar"></div>

    <main class="flex-fill p-4" style="background-color: var(--color-bg-gray); overflow-y: auto; height: 100%;">
      <div id="detailContainer"></div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="../assets/js/layout.js"></script>
  <script>
    // åˆå§‹åŒ–ä½ˆå±€
    checkLogin();
    initLayout('list');
    
    const STORAGE_KEY = 'surveyStore';

    function getDefaultSurveyStore() {
      return [
        {
          id: 'survey-2025q1',
          name: '2025 Q1 é¤é£²æ¥­èª¿æŸ¥',
          status: 'é€²è¡Œä¸­',
          owner: 'é¤é£²å°ˆæ¡ˆçµ„',
          createdAt: '2025-09-30',
          description: 'èšç„¦é¤é£²æ¥­è€…çš„ç‡Ÿé‹ç¾æ³èˆ‡ç—›é»ã€‚',
          definition: {
            fields: [
              { id: 'companyName', label: 'ä¼æ¥­åç¨±', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'taxId', label: 'çµ±ä¸€ç·¨è™Ÿ', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'city', label: 'æ‰€åœ¨ç¸£å¸‚', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'industry', label: 'ç”¢æ¥­åˆ¥', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'industryDetail', label: 'ç´°é …æ¥­åˆ¥', group: 'åŸºæœ¬è³‡æ–™', summary: false, type: 'multi' },
              { id: 'marketingHasTools', label: 'è¡ŒéŠ·æ•¸ä½å·¥å…·ä½¿ç”¨æƒ…æ³', group: 'è¡ŒéŠ·æ¨å»£', summary: true, type: 'text' },
              { id: 'marketingImprovement', label: 'è¡ŒéŠ·ç—›é»', group: 'è¡ŒéŠ·æ¨å»£', summary: false, type: 'multi' },
              { id: 'operationsHasTools', label: 'ç‡Ÿé‹æ•¸ä½å·¥å…·ä½¿ç”¨æƒ…æ³', group: 'ç‡Ÿé‹æµç¨‹', summary: true, type: 'text' },
              { id: 'operationsPainPoints', label: 'ç‡Ÿé‹ç—›é»', group: 'ç‡Ÿé‹æµç¨‹', summary: false, type: 'multi' },
              { id: 'customerHasTools', label: 'é¡§å®¢äº’å‹•å·¥å…·ä½¿ç”¨æƒ…æ³', group: 'é¡§å®¢äº’å‹•', summary: true, type: 'text' },
              { id: 'customerTools', label: 'é¡§å®¢äº’å‹•å·¥å…·', group: 'é¡§å®¢äº’å‹•', summary: false, type: 'multi' },
              { id: 'customerPainPoints', label: 'é¡§å®¢äº’å‹•ç—›é»', group: 'é¡§å®¢äº’å‹•', summary: false, type: 'multi' },
              { id: 'transformationChallenges', label: 'è½‰å‹æŒ‘æˆ°', group: 'è½‰å‹æŒ‘æˆ°', summary: false, type: 'multi' },
              { id: 'transformationResources', label: 'éœ€è¦è³‡æº', group: 'è½‰å‹æŒ‘æˆ°', summary: false, type: 'multi' },
              { id: 'transformationBudget', label: 'å¹´åº¦é ç®—', group: 'è½‰å‹æŒ‘æˆ°', summary: true, type: 'text' },
              { id: 'transformationTeam', label: 'å”åŠ©æ¨å‹•äººæ•¸', group: 'è½‰å‹æŒ‘æˆ°', summary: false, type: 'text' },
              { id: 'notes', label: 'å…¶ä»–å»ºè­°', group: 'å…¶ä»–æ¬„ä½', summary: false, type: 'text' },
              { id: 'submittedAt', label: 'æäº¤æ™‚é–“', group: 'ç³»çµ±æ¬„ä½', summary: true, type: 'datetime' }
            ]
          },
          responses: [
            {
              id: 'DT2025-0001',
              submittedAt: '2025-10-02T09:15:00',
              values: {
                companyName: 'æ³•å¤§è±ç››æœ‰é™å…¬å¸',
                taxId: '95491548',
                city: 'è‡ºä¸­å¸‚',
                industry: 'é¤é£²æ¥­',
                industryDetail: ['é¤é£Ÿæ¥­', 'å…¶ä»–-ç¸½éƒ¨'],
                marketingHasTools: 'è©•ä¼°ä½¿ç”¨',
                marketingImprovement: [
                  'æå‡å“ç‰Œæ›å…‰èˆ‡çŸ¥ååº¦',
                  'æ¥è§¸æˆ–å¸å¼•æ½›åœ¨é¡§å®¢',
                  'ä¿ƒé€²è³¼è²·è½‰æ›ç‡'
                ],
                operationsHasTools: 'è©•ä¼°ä½¿ç”¨',
                operationsPainPoints: [
                  'å„ªåŒ–äººå“¡å‡ºå‹¤èˆ‡æ’ç­ç®¡ç†',
                  'ç°¡åŒ–å“¡å·¥å‹å¥ä¿è¨ˆç®—èˆ‡ç”³å ±',
                  'ç¢ºä¿è–ªé…¬ä½œæ¥­æµç¨‹é †æš¢'
                ],
                customerHasTools: 'å·²ç¶“ä½¿ç”¨',
                customerTools: [
                  'æ•¸ä½é»é¤æœå‹™',
                  'å¤šå…ƒæ”¯ä»˜',
                  'é ç´„ï¼è¨‚ä½æœå‹™'
                ],
                customerPainPoints: [
                  'å»ºç«‹å¤šå…ƒæœå‹™ç®¡é“',
                  'å„ªåŒ–ä»˜æ¬¾æµç¨‹èˆ‡ä»‹é¢',
                  'æå‡èˆŠæœ‰é¡§å®¢å›è³¼ç‡'
                ],
                transformationChallenges: [
                  'å¿™ç‡Ÿé‹ï¼šäººæ‰‹ä¸è¶³ï¼Œç„¡æš‡æŠ•å…¥',
                  'ç¼ºè³‡é‡‘ï¼šæ²’æœ‰å¤šé¤˜çš„è³‡é‡‘æŠ•å…¥'
                ],
                transformationResources: [
                  'å®¢è£½åŒ–è¼”å°',
                  'ä¸€ç«™å¼è«®è©¢',
                  'æ•™è‚²è¨“ç·´ï¼å·¥ä½œåŠ'
                ],
                transformationBudget: '6~10 è¬å…ƒ',
                transformationTeam: '2~4 ä½',
                notes: 'å¸Œæœ›æä¾›æ›´å¤šæ¡ˆä¾‹è«®è©¢èˆ‡é–€å¸‚å°å…¥ç¤ºç¯„',
                submittedAt: '2025-10-02T09:15:00'
              }
            },
            {
              id: 'DT2025-0002',
              submittedAt: '2025-10-03T14:20:00',
              values: {
                companyName: 'å¯¶è¯ç å¯¶éŠ€æ¨“',
                taxId: '45704047',
                city: 'è‡ºä¸­å¸‚',
                industry: 'é›¶å”®æ¥­',
                industryDetail: ['ç å¯¶é›¶å”®'],
                marketingHasTools: 'å·²ç¶“ä½¿ç”¨',
                marketingImprovement: [
                  'æŒæ¡å¸‚å ´è¶¨å‹¢',
                  'æå‡å“ç‰Œæ›å…‰èˆ‡çŸ¥ååº¦'
                ],
                operationsHasTools: 'å·²ç¶“ä½¿ç”¨',
                operationsPainPoints: [
                  'ç°¡åŒ–å¸³å‹™èˆ‡ç¨…å‹™ä½œæ¥­æµç¨‹',
                  'æå‡è·¨éƒ¨é–€æºé€šèˆ‡å”ä½œæ•ˆç‡'
                ],
                customerHasTools: 'å·²ç¶“ä½¿ç”¨',
                customerTools: [
                  'ç·šä¸Šè³¼ç‰©æœå‹™',
                  'å¤šå…ƒæ”¯ä»˜'
                ],
                customerPainPoints: [
                  'è¾¨è­˜é«˜æ½›åŠ›é¡§å®¢',
                  'å„ªåŒ–ä»˜æ¬¾æµç¨‹èˆ‡ä»‹é¢'
                ],
                transformationChallenges: [
                  'ç¼ºæ–¹å‘ï¼šä¸çŸ¥å¦‚ä½•é¸æ“‡æ•¸ä½å·¥å…·ï¼è½‰å‹æ–¹å‘'
                ],
                transformationResources: [
                  'æ•™è‚²è¨“ç·´ï¼å·¥ä½œåŠ',
                  'ä¸€ç«™å¼è«®è©¢'
                ],
                transformationBudget: '1 è¬å…ƒä»¥ä¸‹',
                transformationTeam: '1 ä½',
                notes: 'å¸Œæœ›å¹³å°èƒ½æä¾›æ›´å¤šç å¯¶æ¥­æˆåŠŸæ¡ˆä¾‹ã€‚',
                submittedAt: '2025-10-03T14:20:00'
              }
            }
          ]
        },
        {
          id: 'survey-2025q2',
          name: '2025 Q2 é›¶å”®æ¥­èª¿æŸ¥',
          status: 'è‰ç¨¿',
          owner: 'é›¶å”®å°ˆæ¡ˆçµ„',
          createdAt: '2025-10-15',
          description: 'å»¶ä¼¸èª¿æŸ¥é–€å¸‚æ•¸é‡èˆ‡é¡§å®¢äº’å‹•æ–¹å¼ã€‚',
          definition: {
            fields: [
              { id: 'companyName', label: 'ä¼æ¥­åç¨±', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'taxId', label: 'çµ±ä¸€ç·¨è™Ÿ', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'industryDetail', label: 'ç´°é …æ¥­åˆ¥', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'shopCount', label: 'å°ç£åº—é¢æ•¸', group: 'åŸºæœ¬è³‡æ–™', summary: true, type: 'text' },
              { id: 'branchType', label: 'ç¶“ç‡Ÿå‹æ…‹', group: 'åŸºæœ¬è³‡æ–™', summary: false, type: 'text' },
              { id: 'operationsHasTools', label: 'ç‡Ÿé‹æ•¸ä½å·¥å…·ä½¿ç”¨æƒ…æ³', group: 'ç‡Ÿé‹æµç¨‹', summary: true, type: 'text' },
              { id: 'operationsPainPoints', label: 'ç‡Ÿé‹ç—›é»', group: 'ç‡Ÿé‹æµç¨‹', summary: false, type: 'multi' },
              { id: 'customerHasTools', label: 'é¡§å®¢äº’å‹•å·¥å…·ä½¿ç”¨æƒ…æ³', group: 'é¡§å®¢äº’å‹•', summary: true, type: 'text' },
              { id: 'customerTools', label: 'é¡§å®¢äº’å‹•å·¥å…·', group: 'é¡§å®¢äº’å‹•', summary: false, type: 'multi' },
              { id: 'transformationBudget', label: 'å¹´åº¦é ç®—', group: 'è½‰å‹æŒ‘æˆ°', summary: true, type: 'text' },
              { id: 'submittedAt', label: 'æäº¤æ™‚é–“', group: 'ç³»çµ±æ¬„ä½', summary: true, type: 'datetime' }
            ]
          },
          responses: [
            {
              id: 'DT2025-1001',
              submittedAt: '2025-11-05T11:05:00',
              values: {
                companyName: 'å„·èˆå©šç´—æ”å½±æœ‰é™å…¬å¸',
                taxId: '00127046',
                industryDetail: 'å©šç´—æ”å½±',
                shopCount: '1',
                branchType: 'ç¨ç«‹å“ç‰Œ',
                operationsHasTools: 'è©•ä¼°ä½¿ç”¨',
                operationsPainPoints: [
                  'ç°¡åŒ–å¸³å‹™èˆ‡ç¨…å‹™ä½œæ¥­æµç¨‹',
                  'å„ªåŒ–äººå“¡å‡ºå‹¤èˆ‡æ’ç­ç®¡ç†'
                ],
                customerHasTools: 'è©•ä¼°ä½¿ç”¨',
                customerTools: [
                  'ç¤¾ç¾¤å¹³è‡º',
                  'ç·šä¸Šé ç´„ç³»çµ±'
                ],
                transformationBudget: '2~5 è¬å…ƒ',
                submittedAt: '2025-11-05T11:05:00'
              }
            },
            {
              id: 'DT2025-1002',
              submittedAt: '2025-11-07T16:45:00',
              values: {
                companyName: 'é‡‘çš‡æ¨“ç²¾å“ç å¯¶è¡Œ',
                taxId: '87107970',
                industryDetail: 'ç å¯¶é›¶å”®',
                shopCount: '1',
                branchType: 'ç¨ç«‹å“ç‰Œ',
                operationsHasTools: 'è©•ä¼°ä½¿ç”¨',
                operationsPainPoints: [
                  'å¼·åŒ–ç‡Ÿé‹å½ˆæ€§èˆ‡åº«å­˜æ§ç®¡',
                  'ç°¡åŒ–å¸³å‹™èˆ‡ç¨…å‹™ä½œæ¥­æµç¨‹'
                ],
                customerHasTools: 'å·²ç¶“ä½¿ç”¨',
                customerTools: [
                  'ç·šä¸Šè³¼ç‰©æœå‹™',
                  'å¤šå…ƒæ”¯ä»˜'
                ],
                transformationBudget: '1 è¬å…ƒä»¥ä¸‹',
                submittedAt: '2025-11-07T16:45:00'
              }
            }
          ]
        },
        {
          id: 'survey-empty',
          name: 'æ–°å¢å•å·ç¤ºç¯„',
          status: 'è‰ç¨¿',
          owner: 'å°šæœªæŒ‡æ´¾',
          createdAt: '2025-11-15',
          description: 'å°šæœªåŒ¯å…¥ä»»ä½•è³‡æ–™ï¼Œè«‹é€éå•å·è©³æƒ…é åŒ¯å…¥è©¦ç®—è¡¨ã€‚',
          definition: { fields: [] },
          responses: []
        }
      ];
    }

    function loadSurveyStore() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return getDefaultSurveyStore();
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
      } catch (e) {
        console.warn('è®€å–å•å·è³‡æ–™å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™ã€‚', e);
      }
      return getDefaultSurveyStore();
    }

    function saveSurveyStore(store) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
    }

    const importPresets = {
      sampleXlsx: {
        id: 'sampleXlsx',
        name: 'ç¤ºç¯„å•å·å¡«ç­”è³‡æ–™.xlsx',
        description: 'ä»¥ Excel åŒ¯å…¥é¤é£²èˆ‡æœå‹™æ¥­å•å·ï¼Œæ¬„ä½ä¾é¦–åˆ—æ¨™é¡Œå‹•æ…‹ç”Ÿæˆã€‚',
        headers: [
          'åç¨±',
          'åç¨±2',
          'çµ±ä¸€ç·¨è™Ÿ',
          'çµ±ä¸€ç·¨è™Ÿ2',
          'æ‰€åœ¨ç¸£å¸‚',
          'ç”¢æ¥­åˆ¥',
          'ç´°é …æ¥­åˆ¥',
          'æˆç«‹å¹´æ•¸',
          'è² è²¬äººçš„å¹´é½¡å±¤',
          'ç›®å‰ç¶“å¸¸åƒ±ç”¨å“¡å·¥äººæ•¸',
          'å¹´ç‡Ÿæ¥­é¡',
          'æ–¼è‡ºç£çš„åº—é¢æ•¸é‡å…±æœ‰_______é–“',
          'æ˜¯å¦å±¬æ–¼é€£é–åŠ ç›Ÿé«”ç³»',
          'ç¶“ç‡Ÿå‹æ…‹',
          'æ˜¯å¦ç‚º2ä»£ï¼ˆå«ä»¥ä¸Šï¼‰ç¶“ç‡Ÿè€…æ¥ç­',
          'å±¬æ–¼å“ªä¸€å€‹å…¬å”æœƒ',
          'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€æ˜¯å¦æœ‰ä½¿ç”¨æ•¸ä½å·¥å…·',
          'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼',
          'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·',
          'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€å¸Œæœ›é€éæ•¸ä½å·¥å…·æ”¹å–„å“ªç¨®ç—›é»',
          'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€æœ‰ç„¡ä½¿ç”¨æ•¸ä½å·¥å…·',
          'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼',
          'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·',
          'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€å¸Œæœ›é€éæ•¸ä½å·¥å…·æ”¹å–„å“ªç¨®ç—›é»',
          'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€æ˜¯å¦æœ‰ä½¿ç”¨æ•¸ä½å·¥å…·',
          'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼',
          'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·',
          'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€å¸Œæœ›æ”¹å–„ä½•ç¨®ç—›é»',
          'åœ¨æ¨å‹•æ•¸ä½è½‰å‹æ™‚ï¼Œä¸»è¦é¢è‡¨å“ªäº›æŒ‘æˆ°',
          'åœ¨æ¨å‹•æ•¸ä½è½‰å‹æ™‚ï¼Œå“ªäº›è³‡æºæœ€æœ‰å¹«åŠ©',
          'æœ‰åƒåŠ éç¶“æ¿Ÿéƒ¨æˆ–ç¶“æ¿Ÿéƒ¨å•†æ¥­ç™¼å±•ç½²æ•¸ä½è½‰å‹çš„è¨ˆç•«å—',
          'åƒèˆ‡çš„è¨ˆç•«æœ‰æä¾›å“ªäº›è³‡æºå‘¢',
          'æ¯å¹´é¡˜æ„æŠ•å…¥å¤šå°‘ç¶“è²»æ¨å‹•æ•¸ä½è½‰å‹',
          'æœ‰å¹¾ä½å”åŠ©æ¨å‹•æ•¸ä½è½‰å‹äººæ‰',
          'å°æ•¸ä½è½‰å‹é‚„æœ‰å…¶ä»–éœ€æ±‚æˆ–å»ºè­°å—'
        ],
        rows: [
          {
            'åç¨±': 'æ³•***å¸',
            'åç¨±2': 'æ³•å¤§è±ç››æœ‰é™å…¬å¸',
            'çµ±ä¸€ç·¨è™Ÿ': '9***8',
            'çµ±ä¸€ç·¨è™Ÿ2': '95491548',
            'æ‰€åœ¨ç¸£å¸‚': 'è‡ºä¸­å¸‚',
            'ç”¢æ¥­åˆ¥': 'é¤é£²æ¥­',
            'ç´°é …æ¥­åˆ¥': 'é¤é£Ÿæ¥­\nå…¶ä»–-ç¸½éƒ¨',
            'æˆç«‹å¹´æ•¸': 'æœªæ»¿1å¹´',
            'è² è²¬äººçš„å¹´é½¡å±¤': '40~49æ­²',
            'ç›®å‰ç¶“å¸¸åƒ±ç”¨å“¡å·¥äººæ•¸': '1~4äºº',
            'å¹´ç‡Ÿæ¥­é¡': '500~999è¬',
            'æ–¼è‡ºç£çš„åº—é¢æ•¸é‡å…±æœ‰_______é–“': '8',
            'æ˜¯å¦å±¬æ–¼é€£é–åŠ ç›Ÿé«”ç³»': 'æ˜¯',
            'ç¶“ç‡Ÿå‹æ…‹': 'æˆ‘å€‘æ˜¯ç›´ç‡Ÿ',
            'æ˜¯å¦ç‚º2ä»£ï¼ˆå«ä»¥ä¸Šï¼‰ç¶“ç‡Ÿè€…æ¥ç­': 'å¦ï¼Œç”±å°ˆæ¥­ç¶“ç†äººç¶“ç‡Ÿ',
            'å±¬æ–¼å“ªä¸€å€‹å…¬å”æœƒ': 'å°ç£é€£é–åŠ ç›Ÿä¿ƒé€²å”æœƒ',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€æ˜¯å¦æœ‰ä½¿ç”¨æ•¸ä½å·¥å…·': 'è©•ä¼°ä½¿ç”¨',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼': 'ç¤¾ç¾¤ç¶“ç‡Ÿ\nå“ç‰Œæ´»å‹•\nå…§å®¹è¡ŒéŠ·',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·': 'ç¤¾ç¾¤å¹³è‡ºï¼ˆFacebookã€Instagramï¼‰\næ•¸ä½å»£å‘ŠæŠ•æ”¾\nå¤šå…ƒæ”¯ä»˜',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€å¸Œæœ›é€éæ•¸ä½å·¥å…·æ”¹å–„å“ªç¨®ç—›é»': 'æå‡å“ç‰Œæ›å…‰èˆ‡çŸ¥ååº¦\næ¥è§¸æˆ–å¸å¼•æ½›åœ¨é¡§å®¢\nä¿ƒé€²è³¼è²·è½‰æ›ç‡',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€æœ‰ç„¡ä½¿ç”¨æ•¸ä½å·¥å…·': 'è©•ä¼°ä½¿ç”¨',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼': 'äººå·¥ä½œæ¥­æ­é…è©¦ç”¨é›²ç«¯å·¥å…·',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·': 'æ’ç­èˆ‡è€ƒå‹¤ç³»çµ±\né€²éŠ·å­˜ç®¡ç†\né›»å­ç™¼ç¥¨ä¸²æ¥',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€å¸Œæœ›é€éæ•¸ä½å·¥å…·æ”¹å–„å“ªç¨®ç—›é»': 'å„ªåŒ–äººå“¡å‡ºå‹¤èˆ‡æ’ç­ç®¡ç†\nç°¡åŒ–å“¡å·¥å‹å¥ä¿è¨ˆç®—èˆ‡ç”³å ±\nç¢ºä¿è–ªé…¬ä½œæ¥­æµç¨‹é †æš¢',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€æ˜¯å¦æœ‰ä½¿ç”¨æ•¸ä½å·¥å…·': 'å·²ç¶“ä½¿ç”¨',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼': 'å»ºç½®æœƒå“¡åˆ¶åº¦\nå•Ÿç”¨ç·šä¸Šé ç´„',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·': 'LINE å®˜æ–¹å¸³è™Ÿ\nChatbot ç·šä¸Šå®¢æœ\nç·šä¸Šé ç´„ç³»çµ±',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€å¸Œæœ›æ”¹å–„ä½•ç¨®ç—›é»': 'å»ºç«‹å¤šå…ƒæœå‹™ç®¡é“\nå„ªåŒ–ä»˜æ¬¾æµç¨‹èˆ‡ä»‹é¢\næå‡èˆŠæœ‰é¡§å®¢å›è³¼ç‡',
            'åœ¨æ¨å‹•æ•¸ä½è½‰å‹æ™‚ï¼Œä¸»è¦é¢è‡¨å“ªäº›æŒ‘æˆ°': 'å¿™ç‡Ÿé‹ï¼šäººæ‰‹ä¸è¶³ï¼Œç„¡æš‡æŠ•å…¥\nç¼ºè³‡é‡‘ï¼šæ²’æœ‰å¤šé¤˜çš„è³‡é‡‘æŠ•å…¥',
            'åœ¨æ¨å‹•æ•¸ä½è½‰å‹æ™‚ï¼Œå“ªäº›è³‡æºæœ€æœ‰å¹«åŠ©': 'å®¢è£½åŒ–è¼”å°\nä¸€ç«™å¼è«®è©¢\næ•™è‚²è¨“ç·´ï¼å·¥ä½œåŠ',
            'æœ‰åƒåŠ éç¶“æ¿Ÿéƒ¨æˆ–ç¶“æ¿Ÿéƒ¨å•†æ¥­ç™¼å±•ç½²æ•¸ä½è½‰å‹çš„è¨ˆç•«å—': 'æœ‰',
            'åƒèˆ‡çš„è¨ˆç•«æœ‰æä¾›å“ªäº›è³‡æºå‘¢': 'å°ˆå®¶è¼”å°\nè£œåŠ©ï¼è³‡é‡‘\nå…¬å”æœƒè³‡æºå…±äº«',
            'æ¯å¹´é¡˜æ„æŠ•å…¥å¤šå°‘ç¶“è²»æ¨å‹•æ•¸ä½è½‰å‹': '6~10 è¬å…ƒ',
            'æœ‰å¹¾ä½å”åŠ©æ¨å‹•æ•¸ä½è½‰å‹äººæ‰': '2~4 ä½',
            'å°æ•¸ä½è½‰å‹é‚„æœ‰å…¶ä»–éœ€æ±‚æˆ–å»ºè­°å—': 'å¸Œæœ›æä¾›æ›´å¤šæ¡ˆä¾‹è«®è©¢èˆ‡é–€å¸‚å°å…¥ç¤ºç¯„'
          },
          {
            'åç¨±': 'å„·***å…¬å¸',
            'åç¨±2': 'å„·èˆå©šç´—æ”å½±æœ‰é™å…¬å¸',
            'çµ±ä¸€ç·¨è™Ÿ': '0***6',
            'çµ±ä¸€ç·¨è™Ÿ2': '00127046',
            'æ‰€åœ¨ç¸£å¸‚': 'è‡ºåŒ—å¸‚',
            'ç”¢æ¥­åˆ¥': 'å…¶ä»–æœå‹™æ¥­',
            'ç´°é …æ¥­åˆ¥': 'æ”å½±æ¥­',
            'æˆç«‹å¹´æ•¸': '8å¹´ä»¥ä¸Š~æœªæ»¿20å¹´',
            'è² è²¬äººçš„å¹´é½¡å±¤': '50~59æ­²',
            'ç›®å‰ç¶“å¸¸åƒ±ç”¨å“¡å·¥äººæ•¸': '10~29äºº',
            'å¹´ç‡Ÿæ¥­é¡': '1,000~3,999è¬',
            'æ–¼è‡ºç£çš„åº—é¢æ•¸é‡å…±æœ‰_______é–“': '1',
            'æ˜¯å¦å±¬æ–¼é€£é–åŠ ç›Ÿé«”ç³»': 'å¦',
            'ç¶“ç‡Ÿå‹æ…‹': 'ç¨ç«‹å“ç‰Œ',
            'æ˜¯å¦ç‚º2ä»£ï¼ˆå«ä»¥ä¸Šï¼‰ç¶“ç‡Ÿè€…æ¥ç­': 'å¦ï¼Œç›®å‰æ˜¯ç¬¬1ä»£ç¶“ç‡Ÿï¼Œå°šæœªæœ‰æ¥ç­è¨ˆç•«',
            'å±¬æ–¼å“ªä¸€å€‹å…¬å”æœƒ': 'å°ç£å©šå®´æ–‡å‰µç”¢æ¥­ç™¼å±•å”æœƒ',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€æ˜¯å¦æœ‰ä½¿ç”¨æ•¸ä½å·¥å…·': 'è©•ä¼°ä½¿ç”¨',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼': 'ç¤¾ç¾¤ç¶“ç‡Ÿ\nå£ç¢‘æ¨è–¦\næ´»å‹•åˆä½œ',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·': 'ç¤¾ç¾¤å¹³è‡º\né›»å­å ± EDM',
            'åœ¨ã€Œè¡ŒéŠ·æ¨å»£ã€å¸Œæœ›é€éæ•¸ä½å·¥å…·æ”¹å–„å“ªç¨®ç—›é»': 'ä¿ƒé€²è³¼è²·è½‰æ›ç‡\nè©•ä¼°è¡ŒéŠ·æˆæ•ˆ',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€æœ‰ç„¡ä½¿ç”¨æ•¸ä½å·¥å…·': 'è©•ä¼°ä½¿ç”¨',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼': 'éƒ¨åˆ†å§”å¤–æ­é…å…§éƒ¨äººå“¡',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·': 'æ’ç­ç³»çµ±\nå°ˆæ¡ˆç®¡ç†å·¥å…·',
            'åœ¨ã€Œå…§éƒ¨ç‡Ÿé‹æµç¨‹ã€å¸Œæœ›é€éæ•¸ä½å·¥å…·æ”¹å–„å“ªç¨®ç—›é»': 'å„ªåŒ–äººå“¡å‡ºå‹¤èˆ‡æ’ç­ç®¡ç†\nç°¡åŒ–å“¡å·¥å‹å¥ä¿è¨ˆç®—èˆ‡ç”³å ±',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€æ˜¯å¦æœ‰ä½¿ç”¨æ•¸ä½å·¥å…·': 'è©•ä¼°ä½¿ç”¨',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€ä¸»è¦æ¡å–å“ªç¨®æ–¹å¼': 'é ç´„æ´½è«‡\nå©šç´—æˆæœå±•ç¤º',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€æœ‰ä½¿ç”¨å“ªäº›æ•¸ä½å·¥å…·': 'å®˜æ–¹ç¶²ç«™\nç·šä¸Šé ç´„ç³»çµ±',
            'åœ¨ã€Œé¡§å®¢äº’å‹•èˆ‡é—œä¿‚ç¶­ç¹«ã€å¸Œæœ›æ”¹å–„ä½•ç¨®ç—›é»': 'å³æ™‚å›å¾©é¡§å®¢å•é¡Œèˆ‡éœ€æ±‚\næå‡èˆŠæœ‰é¡§å®¢å›è³¼ç‡',
            'åœ¨æ¨å‹•æ•¸ä½è½‰å‹æ™‚ï¼Œä¸»è¦é¢è‡¨å“ªäº›æŒ‘æˆ°': 'çœ‹ä¸æ‡‚ï¼šæ•¸ä½å·¥å…·æ“ä½œé–€æª»é«˜\nå¿™ç‡Ÿé‹ï¼šäººæ‰‹ä¸è¶³ï¼Œç„¡æš‡æŠ•å…¥',
            'åœ¨æ¨å‹•æ•¸ä½è½‰å‹æ™‚ï¼Œå“ªäº›è³‡æºæœ€æœ‰å¹«åŠ©': 'å®¢è£½åŒ–è¼”å°\næ¡ˆä¾‹åˆ†äº«\nä¸€ç«™å¼è«®è©¢',
            'æœ‰åƒåŠ éç¶“æ¿Ÿéƒ¨æˆ–ç¶“æ¿Ÿéƒ¨å•†æ¥­ç™¼å±•ç½²æ•¸ä½è½‰å‹çš„è¨ˆç•«å—': 'ç„¡',
            'åƒèˆ‡çš„è¨ˆç•«æœ‰æä¾›å“ªäº›è³‡æºå‘¢': '',
            'æ¯å¹´é¡˜æ„æŠ•å…¥å¤šå°‘ç¶“è²»æ¨å‹•æ•¸ä½è½‰å‹': '2~5 è¬å…ƒ',
            'æœ‰å¹¾ä½å”åŠ©æ¨å‹•æ•¸ä½è½‰å‹äººæ‰': 'ç„¡',
            'å°æ•¸ä½è½‰å‹é‚„æœ‰å…¶ä»–éœ€æ±‚æˆ–å»ºè­°å—': 'å¾Œå°æ“ä½œå¸Œæœ›æ›´ç›´è¦ºï¼Œä¸¦æä¾›é¡§å®¢æ¡ˆä¾‹åˆ†æå·¥å…·ã€‚'
          }
        ]
      }
    };

    let surveyStore = loadSurveyStore();
    let currentSurveyId = null;
    let currentSurvey = null;
    let keyword = '';
    let currentPage = 1;
    const PAGE_SIZE = 10;

    function renderPage() {
      const container = document.getElementById('detailContainer');
      const params = new URLSearchParams(window.location.search);
      currentSurveyId = params.get('id');

      if (!currentSurveyId) {
        container.innerHTML = `
          <div class="card shadow-sm">
            <div class="card-body text-center py-5">
              <h2 class="h5 mb-3 fw-bold">å°šæœªé¸æ“‡å•å·</h2>
              <p class="text-muted mb-4">è«‹è¿”å›å•å·åˆ—è¡¨é¸æ“‡è¦ç®¡ç†çš„å•å·ã€‚</p>
              <a class="btn btn-primary" href="a02-list.html">è¿”å›å•å·åˆ—è¡¨</a>
            </div>
          </div>
        `;
        return;
      }

      surveyStore = loadSurveyStore();
      currentSurvey = surveyStore.find(survey => survey.id === currentSurveyId);

      if (!currentSurvey) {
        container.innerHTML = `
          <div class="card shadow-sm">
            <div class="card-body text-center py-5">
              <h2 class="h5 mb-3 fw-bold">æ‰¾ä¸åˆ°æŒ‡å®šçš„å•å·</h2>
              <p class="text-muted mb-4">å¯èƒ½å·²è¢«åˆªé™¤æˆ–å°šæœªå»ºç«‹ï¼Œè«‹è¿”å›åˆ—è¡¨é‡æ–°é¸æ“‡ã€‚</p>
              <a class="btn btn-primary" href="a02-list.html">è¿”å›å•å·åˆ—è¡¨</a>
            </div>
          </div>
        `;
        return;
      }

      renderDetail();
    }

    function renderDetail() {
      const container = document.getElementById('detailContainer');
      const survey = currentSurvey;
      const fields = survey.definition?.fields || [];

      let html = `
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
          <a class="btn btn-outline-primary btn-sm" href="a02-list.html">â† è¿”å›å•å·åˆ—è¡¨</a>
        </div>

        <div class="card mb-4 shadow-sm">
          <div class="card-body d-flex flex-wrap gap-3 justify-content-between align-items-start">
            <div>
              <h1 class="h4 mb-1 fw-bold">${escapeHtml(survey.name)}</h1>
              <p class="text-muted mb-2">${escapeHtml(survey.description || 'å°šæœªå¡«å¯«èªªæ˜ã€‚')}</p>
              <div class="text-muted small">
                <span class="me-3">å»ºç«‹æ—¥æœŸï¼š${escapeHtml(survey.createdAt || '-')}</span>
                <span>è² è²¬å–®ä½ï¼š${escapeHtml(survey.owner || 'å°šæœªæŒ‡æ´¾')}</span>
              </div>
            </div>
            <div class="text-end">
              <span class="badge ${survey.status === 'é€²è¡Œä¸­' ? 'bg-primary' : 'bg-secondary'}">${survey.status}</span>
              ${renderImportControls(survey.id)}
            </div>
          </div>
          <div class="card-footer bg-white d-flex flex-wrap gap-3 align-items-center">
            <span class="text-muted">æ¬„ä½ ${fields.length} é … Â· å›è¦† ${survey.responses.length} ä»½</span>
            <div class="ms-auto">
              <button class="btn btn-outline-primary btn-sm" onclick="exportSurvey()">åŒ¯å‡ºå•å·è³‡æ–™</button>
            </div>
          </div>
        </div>

        <div class="alert alert-light border shadow-sm mb-4">
          <div class="fw-bold mb-1">åŒ¯å…¥èªªæ˜</div>
          <ol class="text-muted mb-0 ps-3">
            <li>æº–å‚™ Excel æˆ– CSVï¼Œç¬¬ä¸€åˆ—æ”¾é¡Œç›®æ¨™é¡Œï¼ˆä¾‹ï¼šä¼æ¥­åç¨±ã€è¡ŒéŠ·ç—›é»ï¼‰ã€‚</li>
            <li>åŒ¯å…¥å¾Œç³»çµ±æœƒä»¥é¦–åˆ—æ¨™é¡Œå»ºç«‹æ¬„ä½å®šç¾©ï¼Œä¸¦å¯«å…¥æ¯åˆ—ç­”å·ã€‚</li>
            <li>é‡è¤‡åŒ¯å…¥æœƒè¦†è“‹æ¬„ä½å®šç¾©ä¸¦é‡æ–°å¯«å…¥è³‡æ–™ï¼Œè«‹å…ˆå‚™ä»½éœ€è¦ä¿ç•™çš„è³‡æ–™ã€‚</li>
          </ol>
        </div>
      `;

      if (!fields.length) {
        container.innerHTML = html + `
          <div class="card shadow-sm">
            <div class="card-body py-5 text-center text-muted">
              å°šæœªæœ‰æ¬„ä½å®šç¾©ï¼Œè«‹å…ˆåŒ¯å…¥è©¦ç®—è¡¨ç”¢ç”Ÿæ¬„ä½ã€‚
            </div>
          </div>
        `;
        attachImportHandlers(survey);
        return;
      }

      const filteredResponses = filterResponses(survey.responses, fields);
      const totalPages = Math.max(1, Math.ceil(filteredResponses.length / PAGE_SIZE));
      currentPage = Math.min(currentPage, totalPages);
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageData = filteredResponses.slice(start, start + PAGE_SIZE);

      const fieldSummary = `é¡¯ç¤ºå…¨éƒ¨æ¬„ä½ï¼ˆ${fields.length}ï¼‰`;

      const tableHead = `
        <th style="width: 56px;">#</th>
        ${fields.map(field => `<th>${escapeHtml(field.label)}</th>`).join('')}
        <th style="width: 96px;">æ“ä½œ</th>
      `;

      let tableBody = '';
      if (!pageData.length) {
        tableBody = `
          <tr>
            <td colspan="${fields.length + 2}" class="text-center py-5 text-muted">
              å°šæœªæœ‰å•å·å›è¦†ï¼Œè«‹åŒ¯å…¥è³‡æ–™ã€‚
            </td>
          </tr>
        `;
      } else {
        tableBody = pageData.map((response, index) => `
          <tr>
            <td>${start + index + 1}</td>
            ${fields.map(field => `<td>${formatValue(response.values[field.id], field)}</td>`).join('')}
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="viewResponse('${response.id}')">æŸ¥çœ‹</button>
            </td>
          </tr>
        `).join('');
      }

      const pagination = buildPagination(totalPages);
      const recordInfo = `é¡¯ç¤ºç¬¬ ${pageData.length ? start + 1 : 0} - ${start + pageData.length} ç­†ï¼Œå…± ${filteredResponses.length} ç­†`;

      html += `
        <div class="card shadow-sm">
          <div class="card-header bg-white d-flex flex-wrap gap-3 justify-content-between align-items-center">
            <div>
              <span class="badge bg-light text-dark me-2">${escapeHtml(survey.name)}</span>
              <span class="text-muted">${fieldSummary}</span>
            </div>
            <div class="input-group" style="max-width: 280px;">
              <span class="input-group-text">ğŸ”</span>
              <input type="search" class="form-control" placeholder="æœå°‹ä¼æ¥­åç¨± / çµ±ç·¨"
                value="${escapeHtml(keyword)}"
                oninput="updateKeyword(this.value)">
            </div>
          </div>
          <div class="sticky-table-wrapper">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>${tableHead}</tr>
              </thead>
              <tbody>${tableBody}</tbody>
            </table>
          </div>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span class="text-muted">${recordInfo}</span>
            <nav>
              <ul class="pagination pagination-sm mb-0">${pagination}</ul>
            </nav>
          </div>
        </div>
      `;

      container.innerHTML = html;
      attachImportHandlers(survey);
    }

    function renderImportControls(surveyId) {
      const hasPreset = !!importPresets.sampleXlsx;
      return `
        <div class="d-flex flex-column align-items-end gap-2 mt-2">
          <input class="visually-hidden" type="file" id="importFile-${surveyId}" accept=".xlsx,.xls,.csv">
          <label class="btn btn-primary btn-sm" for="importFile-${surveyId}">åŒ¯å…¥å•å·</label>
          ${hasPreset ? `<button class="btn btn-link btn-sm p-0" id="importPreset-${surveyId}" type="button">å¥—ç”¨ç¤ºç¯„è³‡æ–™</button>` : ''}
        </div>
      `;
    }

    function attachImportHandlers(survey) {
      const fileInput = document.getElementById(`importFile-${survey.id}`);
      if (fileInput) {
        fileInput.addEventListener('change', async event => {
          const file = event.target.files?.[0];
          event.target.value = '';
          if (!file) return;
          try {
            await handleFileUpload(survey, file);
          } catch (error) {
            console.error(error);
            alert(error?.message ? `åŒ¯å…¥å¤±æ•—ï¼š${error.message}` : 'åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚');
          }
        });
      }

      const presetBtn = document.getElementById(`importPreset-${survey.id}`);
      if (presetBtn) {
        presetBtn.addEventListener('click', () => handleImportPreset('sampleXlsx'));
      }
    }

    function updateKeyword(value) {
      keyword = value;
      currentPage = 1;
      renderDetail();
    }

    function changePage(page) {
      currentPage = page;
      renderDetail();
    }

    function buildPagination(totalPages) {
      return Array.from({ length: totalPages }, (_, index) => index + 1)
        .map(page => `
          <li class="page-item ${page === currentPage ? 'active' : ''}">
            <button class="page-link" onclick="changePage(${page})">${page}</button>
          </li>
        `).join('');
    }

    function filterResponses(responses, fields) {
      if (!keyword) return responses;
      const lower = keyword.toLowerCase();
      return responses.filter(response => {
        const text = [
          response.id,
          ...fields.map(field => {
            const value = response.values[field.id];
            if (Array.isArray(value)) return value.join(' ');
            if (value == null) return '';
            return String(value);
          })
        ].join(' ');
        return text.toLowerCase().includes(lower);
      });
    }

    function formatValue(value, field) {
      if (field.type === 'multi') {
        const items = Array.isArray(value) ? value : parseValue(value, 'multi');
        if (!items.length) return '<span class="text-muted">ï¼</span>';
        return items.map(item => `<span class="badge bg-light text-dark me-1 mb-1">${escapeHtml(item)}</span>`).join('');
      }
      if (field.type === 'datetime') {
        if (!value) return '<span class="text-muted">ï¼</span>';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return `<span>${escapeHtml(String(value))}</span>`;
        return date.toLocaleString('zh-TW', { hour12: false });
      }
      if (!value) return '<span class="text-muted">ï¼</span>';
      return escapeHtml(String(value)).replace(/\n/g, '<br>');
    }

    function handleImportPreset(presetId) {
      const survey = currentSurvey;
      if (!survey) return;
      const preset = importPresets[presetId];
      if (!preset) {
        alert('æ‰¾ä¸åˆ°ç¤ºç¯„è³‡æ–™ã€‚');
        return;
      }

      const rows = [
        preset.headers,
        ...preset.rows.map(row =>
          preset.headers.map(header => row[header] ?? '')
        )
      ];

      try {
        processImportedRows(survey, rows, preset.name);
      } catch (error) {
        console.error(error);
        alert(error?.message ? `åŒ¯å…¥å¤±æ•—ï¼š${error.message}` : 'åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™æ ¼å¼ã€‚');
      }
    }

    async function handleFileUpload(survey, file) {
      if (typeof XLSX === 'undefined') {
        throw new Error('æœªèƒ½è¼‰å…¥åŒ¯å…¥æ‰€éœ€çš„è§£æå·¥å…·ï¼Œè«‹é‡æ–°æ•´ç†å¾Œå†è©¦ã€‚');
      }

      const ext = file.name.split('.').pop()?.toLowerCase();
      if (!ext || !['xlsx', 'xls', 'csv'].includes(ext)) {
        throw new Error('åƒ…æ”¯æ´åŒ¯å…¥ Excelï¼ˆ.xlsx/.xlsï¼‰æˆ– CSV æª”æ¡ˆã€‚');
      }

      const mode = ext === 'csv' ? 'text' : 'arrayBuffer';
      const fileData = await readFileAsync(file, mode);

      let workbook;
      if (ext === 'csv') {
        workbook = XLSX.read(typeof fileData === 'string' ? fileData : new TextDecoder('utf-8').decode(fileData), { type: 'string' });
      } else {
        workbook = XLSX.read(new Uint8Array(fileData), { type: 'array' });
      }

      if (!workbook.SheetNames || !workbook.SheetNames.length) {
        throw new Error('æª”æ¡ˆä¸­æ‰¾ä¸åˆ°ä»»ä½•å·¥ä½œè¡¨ã€‚');
      }

      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

      processImportedRows(survey, rows, file.name);
    }

    function readFileAsync(file, mode) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = event => resolve(event.target.result);
        reader.onerror = () => reject(new Error('æª”æ¡ˆè®€å–å¤±æ•—'));
        if (mode === 'text') {
          reader.readAsText(file, 'utf-8');
        } else {
          reader.readAsArrayBuffer(file);
        }
      });
    }

    function processImportedRows(survey, rows, sourceLabel) {
      if (!rows || !rows.length) {
        throw new Error('æª”æ¡ˆå…§æ²’æœ‰è³‡æ–™ã€‚');
      }

      const headers = rows[0]
        .map((cell, index) => {
          const text = String(cell ?? '').trim();
          return text || `æ¬„ä½${index + 1}`;
        });

      if (!headers.some(header => header.trim().length > 0)) {
        throw new Error('æœªæ‰¾åˆ°æ¬„ä½æ¨™é¡Œï¼Œè«‹ç¢ºèªç¬¬ä¸€åˆ—æ˜¯å¦ç‚ºé¡Œç›®ã€‚');
      }

      const dataRows = rows
        .slice(1)
        .filter(row => Array.isArray(row) && row.some(cell => String(cell ?? '').trim() !== ''));

      if (!dataRows.length) {
        throw new Error('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™åˆ—ã€‚');
      }

      const fields = buildFieldsFromHeaders(headers);
      const baseTime = Date.now();

      const responses = dataRows.map((row, index) => {
        const values = {};

        fields.forEach((field, colIdx) => {
          const raw = row[colIdx] ?? '';
          values[field.id] = parseValue(raw, field.type);
        });

        let submittedAtValue = values.submittedAt;
        if (Array.isArray(submittedAtValue)) {
          submittedAtValue = submittedAtValue[0];
        }

        if (!submittedAtValue) {
          submittedAtValue = new Date(baseTime + index * 1000).toISOString();
          values.submittedAt = submittedAtValue;
        }

        return {
          id: `${survey.id.toUpperCase()}-${String(index + 1).padStart(4, '0')}`,
          submittedAt: submittedAtValue,
          values
        };
      });

      if (!fields.some(field => field.id === 'submittedAt')) {
        fields.push({
          id: 'submittedAt',
          label: 'æäº¤æ™‚é–“',
          group: 'ç³»çµ±æ¬„ä½',
          summary: true,
          type: 'datetime'
        });
        responses.forEach(response => {
          response.values.submittedAt = response.submittedAt;
        });
      }

      survey.definition.fields = fields;
      survey.responses = responses;
      survey.status = 'é€²è¡Œä¸­';

      const updateIndex = surveyStore.findIndex(item => item.id === survey.id);
      if (updateIndex !== -1) {
        surveyStore[updateIndex] = survey;
        currentSurvey = surveyStore[updateIndex];
        saveSurveyStore(surveyStore);
      }

      alert(`åŒ¯å…¥å®Œæˆï¼šå·²å¾ã€Œ${sourceLabel}ã€å°å…¥ ${responses.length} ç­†è³‡æ–™ã€‚`);
      renderDetail();
    }

    function buildFieldsFromHeaders(headers) {
      const fields = [];
      const seenIds = new Set();

      headers.forEach((label, index) => {
        let id = slugify(label);
        if (!id) id = `field-${index + 1}`;
        let uniqueId = id;
        let counter = 1;
        while (seenIds.has(uniqueId)) {
          uniqueId = `${id}-${++counter}`;
        }
        seenIds.add(uniqueId);

        const type = detectType(label);
        const group = guessGroup(label);

        fields.push({
          id: uniqueId,
          label,
          group,
          summary: true,
          type
        });
      });

      return fields;
    }

    function detectType(label) {
      const multiKeywords = ['å“ªäº›', 'ç—›é»', 'æŒ‘æˆ°', 'è³‡æº', 'æ–¹å¼', 'å·¥å…·'];
      const datetimeKeywords = ['æ™‚é–“', 'æ—¥æœŸ'];
      if (datetimeKeywords.some(keyword => label.includes(keyword))) return 'datetime';
      if (multiKeywords.some(keyword => label.includes(keyword))) return 'multi';
      return 'text';
    }

    function guessGroup(label) {
      if (/è¡ŒéŠ·/.test(label)) return 'è¡ŒéŠ·æ¨å»£';
      if (/ç‡Ÿé‹/.test(label)) return 'ç‡Ÿé‹æµç¨‹';
      if (/é¡§å®¢/.test(label)) return 'é¡§å®¢äº’å‹•';
      if (/æŒ‘æˆ°|è³‡æº|é ç®—/.test(label)) return 'è½‰å‹æŒ‘æˆ°';
      if (/åç¨±|çµ±ä¸€ç·¨è™Ÿ|ç¸£å¸‚|ç”¢æ¥­|æˆç«‹|åº—é¢|ç¶“ç‡Ÿå‹æ…‹/.test(label)) return 'åŸºæœ¬è³‡æ–™';
      return 'å…¶ä»–æ¬„ä½';
    }

    function slugify(label) {
      return label
        .replace(/[^A-Za-z0-9\u4e00-\u9fa5]+/g, ' ')
        .trim()
        .replace(/\s+/g, '-')
        .toLowerCase();
    }

    function parseValue(raw, type) {
      if (raw == null || raw === '') {
        if (type === 'multi') return [];
        return '';
      }
      if (type === 'multi') {
        if (Array.isArray(raw)) return raw;
        const tokens = String(raw)
          .split(/[\n,ã€ï¼Œï¼›;]/)
          .map(token => token.trim())
          .filter(Boolean);
        return tokens;
      }
      if (type === 'datetime') {
        const date = new Date(raw);
        if (!Number.isNaN(date.getTime())) {
          return date.toISOString();
        }
        return String(raw);
      }
      return String(raw);
    }

    function viewResponse(responseId) {
      alert(`ç¤ºç¯„ï¼šå¯å°å‘å•å·è©³æƒ…é ï¼Œä¾‹å¦‚åˆ—å°æˆ–å–®ç­†ç€è¦½ï¼ˆID: ${responseId}ï¼‰`);
    }

    function exportSurvey() {
      alert('ç¤ºç¯„ï¼šå¯åœ¨æ­¤åŒ¯å‡ºç›®å‰å•å·çš„æ¬„ä½å®šç¾©èˆ‡å›è¦†è³‡æ–™ç‚º Excelã€‚');
    }

    function escapeHtml(value) {
      if (value == null) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    renderPage();
  </script>
</body>
</html>
