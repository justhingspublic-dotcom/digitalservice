<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>部門設定 - 商業服務業數位應用資料庫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="../assets/css/custom.css" rel="stylesheet">
</head>
<body>
  <div id="topbar"></div>

  <div class="d-flex" style="height: calc(100vh - 64px);">
    <div id="sidebar"></div>

    <main class="flex-fill p-4" style="background-color: var(--color-bg-gray); overflow-y: auto; height: 100%;">
      <div class="container-fluid">
        <!-- 標題 -->
        <div class="d-flex align-items-center gap-2 mb-4">
          <span class="material-icons" style="font-size: 28px; color: var(--color-primary);">apartment</span>
          <h4 class="mb-0">部門設定</h4>
        </div>

        <!-- 統計卡片 -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <div class="h3 mb-0 text-primary" id="totalDepts">0</div>
                <div class="text-muted small">部門數</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 列表 -->
        <div class="card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">部門列表</h5>
            <button class="btn btn-primary btn-sm" onclick="showDeptModal()">
              <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add_business</span>
              新增部門
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead style="background-color: #fafafa;">
                  <tr>
                    <th style="width: 60px;">#</th>
                    <th>部門名稱</th>
                    <th>上層部門</th>
                    <th>主管</th>
                    <th>狀態</th>
                    <th style="width: 200px;">操作</th>
                  </tr>
                </thead>
                <tbody id="deptsTableBody">
                  <tr>
                    <td colspan="6" class="text-center py-4 text-muted">載入中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 新增/編輯 部門 Modal -->
  <div class="modal fade" id="deptModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deptModalTitle">新增部門</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">部門名稱 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="modalDeptName" placeholder="例如：資訊處">
            </div>
            <div class="col-12">
              <label class="form-label">上層部門</label>
              <select class="form-select" id="modalDeptParent"></select>
            </div>
            <div class="col-12">
              <label class="form-label">部門主管</label>
              <input type="text" class="form-control" id="modalDeptManager" placeholder="可先輸入姓名（Demo）">
            </div>
            <div class="col-12">
              <label class="form-label">狀態</label>
              <select class="form-select" id="modalDeptStatus">
                <option value="啟用">啟用</option>
                <option value="停用">停用</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveDept()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/hardcoded-data.js"></script>
  <script src="../assets/js/layout.js"></script>
  <script>
    checkLogin('departments');
    initLayout('departments');

    const STORAGE_KEY = 'departmentsStore';
    let allDepts = [];
    let editingDeptId = null;
    let deptModal = null;

    function getDefaultDepts() {
      return [
        { id: 'dept-it', name: '資訊處', parentId: null, manager: '王台長', status: '啟用' },
        { id: 'dept-sales', name: '業務處', parentId: null, manager: '李處長', status: '啟用' },
        { id: 'dept-consult', name: '輔導組', parentId: 'dept-sales', manager: '陳組長', status: '啟用' },
        { id: 'dept-plan', name: '企劃處', parentId: null, manager: '張處長', status: '啟用' }
      ];
    }

    function loadDepts() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        allDepts = getDefaultDepts();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allDepts));
      } else {
        try { allDepts = JSON.parse(raw); } catch(e) { allDepts = getDefaultDepts(); }
      }
    }

    function saveDepts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allDepts));
    }

    function renderDepts() {
      const tbody = document.getElementById('deptsTableBody');
      const total = document.getElementById('totalDepts');
      total.textContent = allDepts.length;

      if (allDepts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">尚無部門，請新增</td></tr>';
        return;
      }

      const getName = id => allDepts.find(d => d.id === id)?.name || '';
      let html = '';
      allDepts.forEach((d, idx) => {
        const statusColor = d.status === '啟用' ? 'bg-success' : 'bg-secondary';
        html += `
          <tr>
            <td class="text-center">${idx + 1}</td>
            <td><strong>${escapeHtml(d.name)}</strong></td>
            <td>${escapeHtml(getName(d.parentId) || '-')}</td>
            <td>${escapeHtml(d.manager || '-')}</td>
            <td><span class="badge ${statusColor}">${escapeHtml(d.status)}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editDept('${d.id}')">
                <span class="material-icons" style="font-size: 16px;">edit</span>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteDept('${d.id}')">
                <span class="material-icons" style="font-size: 16px;">delete</span>
              </button>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    function showDeptModal() {
      editingDeptId = null;
      document.getElementById('deptModalTitle').textContent = '新增部門';
      document.getElementById('modalDeptName').value = '';
      document.getElementById('modalDeptManager').value = '';
      document.getElementById('modalDeptStatus').value = '啟用';
      buildParentOptions();
      if (!deptModal) deptModal = new bootstrap.Modal(document.getElementById('deptModal'));
      deptModal.show();
    }

    function editDept(id) {
      const d = allDepts.find(x => x.id === id);
      if (!d) return;
      editingDeptId = id;
      document.getElementById('deptModalTitle').textContent = '編輯部門';
      document.getElementById('modalDeptName').value = d.name;
      document.getElementById('modalDeptManager').value = d.manager || '';
      document.getElementById('modalDeptStatus').value = d.status || '啟用';
      buildParentOptions(d.id, d.parentId);
      if (!deptModal) deptModal = new bootstrap.Modal(document.getElementById('deptModal'));
      deptModal.show();
    }

    function buildParentOptions(excludeId = null, selectedId = null) {
      const sel = document.getElementById('modalDeptParent');
      let options = '<option value="">（無）</option>';
      allDepts.forEach(d => {
        if (d.id === excludeId) return;
        const selAttr = selectedId === d.id ? 'selected' : '';
        options += `<option value="${d.id}" ${selAttr}>${escapeHtml(d.name)}</option>`;
      });
      sel.innerHTML = options;
    }

    function saveDept() {
      const name = document.getElementById('modalDeptName').value.trim();
      const parentId = document.getElementById('modalDeptParent').value || null;
      const manager = document.getElementById('modalDeptManager').value.trim();
      const status = document.getElementById('modalDeptStatus').value;
      if (!name) { alert('請輸入部門名稱'); return; }

      if (editingDeptId) {
        if (parentId === editingDeptId) {
          alert('上層部門不可為自己');
          return;
        }
        const d = allDepts.find(x => x.id === editingDeptId);
        if (d) {
          d.name = name;
          d.parentId = parentId;
          d.manager = manager;
          d.status = status;
        }
      } else {
        const newDept = { id: `dept-${Date.now()}`, name, parentId, manager, status };
        allDepts.push(newDept);
      }

      saveDepts();
      renderDepts();
      if (deptModal) deptModal.hide();
      alert(editingDeptId ? '部門已更新' : '部門已新增');
    }

    function deleteDept(id) {
      const d = allDepts.find(x => x.id === id);
      if (!d) return;
      const hasChild = allDepts.some(x => x.parentId === id);
      if (hasChild) {
        alert('此部門仍有下層部門，請先處理下層部門再刪除');
        return;
      }
      if (!confirm(`確定要刪除部門「${d.name}」嗎？此操作無法復原。`)) return;
      allDepts = allDepts.filter(x => x.id !== id);
      saveDepts();
      renderDepts();
      alert('部門已刪除');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    window.addEventListener('load', function() {
      loadDepts();
      renderDepts();
    });
  </script>
</body>
</html>


